<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sherlock Holmes</title>
<link rel="icon" type="image/x-icon" href="https://icooon-mono.com/i/icon_14868/icon_148680_256.png">

<!-- <link rel="stylesheet" href="AudioPlayer.css"> -->
<style type="text/css">
@charset "UTF-8";
* {
	/* "SFU AmericanType",  */
  font-family: "SFU AmericanType", monospace, "Courier New";
  font-size: 19px;
  box-sizing: border-box;
  text-rendering: optimizeLegibility;
  -webkit-font-smoothing: antialiased;
}

body{
	/* Fun corner: change color of selBookGroup and elmSelBookTitles by the selected value of selBookGroup */
	--select-book-group-color: darkblue;
	--select-book-group-filter: invert(14%) sepia(49%) saturate(4923%) hue-rotate(236deg) brightness(81%) contrast(147%);

	&:has(#selBookGroup > option:nth-of-type(2):checked){
		--select-book-group-color: darkred;
		--select-book-group-filter: invert(6%) sepia(86%) saturate(6340%) hue-rotate(360deg) brightness(111%) contrast(108%);
	}
	&:has(#selBookGroup > option:nth-of-type(3):checked){
		--select-book-group-color: darkgreen;
		--select-book-group-filter: invert(22%) sepia(99%) saturate(1440%) hue-rotate(95deg) brightness(90%) contrast(105%);
	}
}

/* SETTING SOME VARIABLE TO CUSTOMIZE THE PAGE */
:root {
	/* Font size of Chapter title (span) in Playlist item (li) */
  --playlist-item-title-font-size: 21px;
  --playlist-item-title-font-weight: 400;
  --button-hover-bground-color: #e5e7eb;
  --select-hover-bground-filter: invert(19%) sepia(33%) saturate(6688%) hue-rotate(278deg) brightness(91%) contrast(89%); /* the filter that shift color of backgound svg image of select boxes from Black to --button-hover-bground-color */
  --button-hover-border-color: #8d28a5;
  --button-border-style: 1px solid #bdbec0;
}

audio{
	width: 100%;
	display: none;
}

div[name="divContainer"]{/* Choose divContainer becauss this div is innermost element that contain both playPause button. Remove this if you don't want circle progress buttons */
  /* Following 3 vars are for icnSvgPlayProgress */
  --audio-playing-current-progress-percent: 383px; /* stroke-dashoffset to show effect of percentage of current playing */
  --audio-playing-current-progress-remained-color: #8f8f8f; /* remained color: #abef83 rgb(135, 243, 102)*/
  --audio-playing-current-progress-played-color:#21ff15; /* Progressed color #ff4015*/
}

div[name="divContainer"] > * {
	width: 100%;
	max-width: 100%;
}
/* iphone, iPad has big screen dpi. See https://hover-pointer-media-query.glitch.me/ for pointer value for different device
Following are settings for Desktop screen. "pointer: coarse" is for iphone/iPad and android phone/tablet which defaultly is handled 
*/
@media (pointer: fine){
	:root {
	--playlist-item-title-font-size: 18px;
	--playlist-item-title-font-weight: 400;
	}
	* {
  		font-size: 17px;
	}
}
/* see https://www.w3schools.com/css/css_rwd_mediaqueries.asp for different kind of screen like phone, tablet,.. */

div[name="divContainer"]{
	width: 100%; /* 100vw 1vw = 1% of viewport width. Default width of the page is all screen */
	text-align: center;
	margin: 5px auto;
}

/* Introduce about Book or Chapter */
p.bookChapIntro{
	column-count:1; 
	column-rule:1px solid lightblue; 
	column-gap:30px;
	text-indent: 2em;
	margin-top: 10px;
	padding-top: 5px;
	border-top: 1px solid lightblue;
	text-align: justify;
	& > .bookChapIntroImg{
		width: 100px;
		margin-right: 10px;
		float:left;
	}
}

/* Flex container for dispay div side by side */
.flex-container { /* set default flex setting, which is for small device like iPhone */
    display: flex;
	flex-direction: column;
	column-gap: 15px; /* Only show gap between flex items on row mode */
}

/* Big Audio control below book cover Img and history buttons */
div[name="divCtnAudioControlExtraBig"]{
	display: none;
}

.flex-container > div, h2 {
    flex:auto;    /*0 0 auto*/
}
/* flex item that has book cover will have flex-grow = 0, so that all extra space will go to Playlist element*/
.flex-container > div:has(> #elmArtwork) {/* div that contain the artwork which can be book cover or chapter cover */
    flex:0 0 auto;    /*0 0 auto*/
	order: 2; /*so that in the column flex, the artwork will be after Playlist */
	max-width: 100%; /* In column mode, size of artwrok can reach to 100% */
}

/* This left side of playlist has multiple children, so set this to make nicer visibility */
.flex-container > div:has(> #elmArtwork) > *{
	margin-bottom: 5px;
}
  
.flex-container #elmArtwork{
	max-width: 100%; /* In column mode, size of artwrok can reach to 100% */
	border: 1px solid bisque;
	box-shadow: rgba(0, 0, 0, 0.45) 5px 5px 10px;
	margin-bottom: 15px !important; 
}

.flex-container .noInternetImg{
	width: min(100%, 400px);
	margin-bottom: 15px !important; 
}

.flex-container > div:last-child {
    flex-grow: 1;
}

.flex-container > :first-child {
    margin-right: 0px;
} 

@media only screen and (min-width: 850px) {
	p.bookChapIntro{
		column-count:2; 
	}
	.flex-container { /* If screen is bigger, make flex to be row */
		flex-direction: row;
	}
	/* Big Audio control below book cover Img and history buttons */
	div[name="divCtnAudioControlExtraBig"]{
		display: flex; /* This div has control-button-flex classm so set its display to flex */
	}
	/* .flex-container > :first-child {
		margin-right: 20px;
	}*/
	.flex-container > div:has(> #elmArtwork) { /* div that contain the artwork which can be book cover or chapter cover */
		order: 0; /*in the row flex, the artwork will be right side of Playlist */
		max-width: 40%; /* In row mode, size of artwrok cannot wider than 50% */
	}
}
	
@media only screen and (min-width: 1100px) {
	div[name="divContainer"]{
		/* text-align: center;
		margin: 5px auto; */
		width: 1100px; /* When screen is too wide, make the page only 1100px wide */
	}

	p.bookChapIntro{
		column-count:3; /* Wide screen, more column */
	}
}

.flex-button-container {
    display: flex;
	flex-flow: row wrap;
	justify-content: space-evenly;
}

/* DETAIL - SUMMARY css */

details {
	max-width: 100%;
	margin-top: 3px;
	/* margin-bottom: 10px; */
	overflow: hidden; /* Keep this line to prevent an odd blue outline around the element in Safari. */
}

summary {
	display: inline-block;
    padding-top: 5px;
}

summary::-webkit-details-marker {
	display: none;
}

summary > span {
	/* position: relative;
	display: flex;
	align-items: flex-start; */
	text-align: center;
	cursor: pointer;
	/* padding-left: 1rem;
	background: #444;
	color: #fff;
	height: 4rem; */
}

summary > span::before {
	content: '';
	width: 0;
	height: 0;
	display: inline-block;
	border: 6px solid transparent;
	border-width: 6px 9px;	
	border-left-color: red; /* these 7 css lines is to make ⏵ */
	margin-right: 5px;
	transform: translateY(-2px);
	transform-origin: 40% 50%;
	transition: rotate 200ms 400ms ease-out;
}
details[open] > summary > span::before {
	rotate: 90deg;
	transition: rotate 200ms ease-out;
}
	
div.detailContent {
	box-sizing: border-box;
	max-width: 100%;
	max-height: 0px;
	overflow: hidden;
	transition: max-height 400ms ease-out; /* , border 0ms 400ms linear; */
}

#elmChapterInfor{
	transition: max-height 100ms ease-out; /* chapter infor really short, so if animation time too long, the animation seems not smooth */
}

details[open] + div.detailContent {
	max-height: 1500px; /* Set a max-height value enough to show all the content */
	padding: 3px 0px; /* for a.srcPlaying item not to be cropped at bottom */
}

/*format summary marker (the small triagle) for Book and Chapter titles*/

#elmBookTitle::before{
	border-left-color: darkblue;
}

#elmChapterTitle {
	text-align: center;
	font-size: 25px;
    color: red;
	font-weight: bold;
	/*padding-top: 5px;*/
}
#elmChapterInfor{
	margin-bottom: 5px;
	/* padding-bottom: 3px; */
}
#elmBookTitle{
	text-align: center;
	font-size: 23px;
    color: darkblue;
	font-weight: bold;
}
#elmBookInfo{
	text-align:justify;
	text-justify:inter-word;
	padding-left: 5px;
}
/* END OF DETAIL - SUMMARY css */
#selBookGroup{
	background: transparent url(https://uxwing.com/wp-content/themes/uxwing/download/education-school/books-icon.svg) 50% 3px / 25px no-repeat !important;
	padding-top: 25px !important;
	text-indent: 0px; /* to make the [01] number at the center of button */
	padding-bottom: 4px;
    -moz-appearance: none;
    -webkit-appearance: none;
    appearance: none;
    font-size: 17px;
    text-align-last: center;
    color: #000;
	border: 2px solid black; /* var(--button-border-style); */
	filter: var(--select-book-group-filter);
    border-radius: 15%;
    cursor: pointer;
}
#selBookGroup:hover{
	filter: var(--select-hover-bground-filter);
	/* color: var(--button-hover-border-color);
	background-color: var(--button-hover-bground-color) !important; 
	*/
	-webkit-transition: background .2s ease;
    transition: background .2s ease;
}

#elmPlayingTime{
	flex-shrink: 0; /* Prevent playing time to be forced into two lines */
	text-align: center;
	font-weight: bold;
	color: green;
	margin: auto 0px;
    font-size: xx-large;
}
div:has(> #elmPlayingTime){ /* the div container which is direct father of #elmPlayingTime */
	display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0; /* to prevent #elmPlayingTime being broken into two line when screen width shrink */
}
div[name="HourglassSpining"]{
	color: darkgreen;
	position: relative; /* to vertically center the Loading span */
	transform: translateX(-80px); /* to make spinning clock with the span seems to be centered*/
}
div[name="HourglassSpining"] > span{
	font-weight: bold;
	font-size: xx-large;
	/* Center vertically */
	position: absolute;
	top: 50%;
	transform: translate(0, -50%);
	margin-left: 10px;
}
#elmBookTotalDuration{
	color: darkgreen;
	margin: -10px 0px 5px 0px;
	& > span{
		font-size: x-large;
		font-weight: bold;
	}
	& > svg:first-of-type{
		color: darkgreen;
		font-size: x-large;
		margin:auto -4px -2px 5px;
	}
	& > svg:last-of-type{
		color: darkgreen;
		font-size: xx-large;
		margin:auto -4px -5px 5px;
	}
}

#elmSelBookTitles {
	max-width: 100%;
	margin: 2px auto;
	border-color: var(--select-book-group-color);
	border-width: 2px;
}
/* class to replace default spinner (little triangle at right side) of dropdown list */
.dropdown-book-spinner{
	/* Hide default spninner */
	-webkit-appearance: none;
    -moz-appearance: none;
    appearance: none;
	/* SVG background image */
    background-image: url(data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20fill%3D%22darkgreen%22%20viewBox%3D%22102.4%20153.6%20870.4%20819.2%22%3E%3Cpath%20d%3D%22M512%20819.2c-23.3%2031.1-60.5%2051.2-102.4%2051.2H179.2a76.8%2076.8%200%200%201-76.8-76.8V230.4a76.8%2076.8%200%200%201%2076.8-76.8h230.4c41.9%200%2079.1%2020.1%20102.4%2051.2%2023.3-31.1%2060.5-51.2%20102.4-51.2h230.4a76.8%2076.8%200%200%201%2076.8%2076.8v358.4c0-41.9-20.1-79.1-51.2-102.4v-256a25.6%2025.6%200%200%200-25.6-25.6H614.4a76.8%2076.8%200%200%200-76.8%2076.8v460.8c0%2026.8%2013.8%2050.5%2034.7%2064.2%206.6%2022.7%2016.5%2043.9%2029.2%2063.2a127.8%20127.8%200%200%201-89.5-50.6M153.6%20230.4v563.2a25.6%2025.6%200%200%200%2025.6%2025.6h230.4a76.8%2076.8%200%200%200%2076.8-76.8V281.6a76.8%2076.8%200%200%200-76.8-76.8H179.2a25.6%2025.6%200%200%200-25.6%2025.6M892.2%20824a127.5%20127.5%200%200%200%2029.4-81.6%2025.6%2025.6%200%200%201%2051.2%200%20179.3%20179.3%200%200%201-153.6%20177.4v27.4a25.6%2025.6%200%200%201-51.2%200v-27.4a179.8%20179.8%200%200%201-136.3-100.6%20178.5%20178.5%200%200%201-17.3-76.8%2025.6%2025.6%200%200%201%2051.2%200A127.5%20127.5%200%200%200%20695%20824c23.4%2028.3%2058.9%2046.4%2098.5%2046.4h.2c39.7%200%2075.1-18.1%2098.5-46.4M716.8%20588.8a76.8%2076.8%200%200%201%20153.6%200v153.6a76.8%2076.8%200%200%201-153.6%200z%22%2F%3E%3C%2Fsvg%3E);
    background-size: 1.4em;
    background-position: calc(100% - 0.2em) center;
    background-repeat: no-repeat;
    line-height: 1.8em;
	padding-left:5px;
	padding-right: 1.8em;
    border-radius: .4em;
	
	&:focus{
		border-width: 2.5px !important;
		outline: none; /* remove browser-added black outline when dropdown got focus */
	}
	/* Hide default spninner for IE */
	&::-ms-expand {
    	display: none;
	}
	
}
#elmInnerMcFlexCtn > span > label::before{
	/* content: "🎙: "; 🗣 */
	content: url(https://uxwing.com/wp-content/themes/uxwing/download/peoples-avatars/speak-talk-voice-icon.svg);
    display: inline-block;
    width: 23px;
    margin: -1px 7px;
    transform: rotateY(180deg);
    color: red;
}
#elmInnerMcFlexCtn > span > label{
	font-size: var(--playlist-item-title-font-size);
	font-weight: bold;
	margin-right: 15px;
}
#elmInnerMcFlexCtn > span:first-of-type > label{
	color: darkred;
}
#elmInnerMcFlexCtn > span:nth-of-type(2) > label{
	color: darkblue;
}
#elmInnerMcFlexCtn > span:nth-of-type(3) > label{
	color: darkorchid;
}

p{
	margin: 5px 2px;
}
select, button{
	color: black;
	/*font-size: 18px;
	font-weight: bold;*/
}

a{
	&:link {
	text-decoration: none;
	}
	&:visited {
	text-decoration: none;  
	}
	&:hover {
	/* color:darkred !important; */
	background-color: rgb(227, 232, 244);
	border-bottom: 1px solid #2c272a;
	padding: 0px 5px 3px 1px;
	border-radius: 5px;
	}
}
</style>

<!-- inlineList, inlineListInfor -->
<style>
/* Display inline list of information. inlineList for list of anchors, inlineListInfor for list of pieces of information */
ul.inlineList, ul.inlineListInfor {
	display: inline;
	padding-inline-start: 2px;
}
ul.inlineList > li:not(:last-of-type)::after {
	content: ' ┋ '; /*∴ ┋*/
	color: darkred;	
}
ul.inlineListInfor {
	padding-inline-start: 0px;
}
ul.inlineListInfor > li::before{
	content: '∴'; 
	padding-left: 10px;
	padding-right: 7px;
	color: darkgreen;
}

ul.inlineList > li , ul.inlineListInfor > li {
	display: inline;
}

ul.inlineList {
  counter-reset: anchor;
}

ul.inlineList > li > a[href].srcPlaying{
	border: 1px solid #730a50;
	border-left: 5px solid #730a50;
	color: darkblue;
	font-weight: 700;
	background-color: rgb(255 243 229);
	padding: 1px 5px 2px 0px;
    border-radius: 5px;
	&:hover {
		background-color: rgb(246 213 175);
	}
}
ul.inlineList > li > a[href].srcPlaying::before {
	/* content: counter(anchor) ". "; "⏵ "  ⧉ */
	background-image: url("data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA5Mi4yIDEyMi44OCIgZmlsbD0iIzAwMDA4YiIgPjxwYXRoIHN0eWxlPSJmaWxsLXJ1bGU6ZXZlbm9kZDtjbGlwLXJ1bGU6ZXZlbm9kZCIgZD0iTTkyLjIgNjAuOTcgMCAxMjIuODhWMHoiLz48L3N2Zz4=");
	margin-left: 2px;
}
/* If there is only one link, no need for order number */
ul.inlineList > li:only-of-type > a[href].srcPlaying::before {
  content: "";/* "⏵ "; */
}

ul.inlineList > li > a[href] {
  counter-increment: anchor;
  white-space: nowrap;
  /* &:hover::before{
		color: black;
		filter: invert(13%) sepia(47%) saturate(6568%) hue-rotate(7deg) brightness(81%) contrast(124%);
	} */
}

ul.inlineList > li > a[href]::before {
	content: counter(anchor) ".";
    background-image: url("data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxZW0iIGhlaWdodD0iMWVtIiBmaWxsPSIjMDAwMEVFIiB2aWV3Qm94PSIzMDAgMTUwIDQyNCA3MjQiPiAKICAgPHBhdGggZD0iTTcyNS40IDg1My4zSDI1NkMyMDguOSA4NTMuMyAxNzAuNyA4MTUuMSAxNzAuNyA3NjhWMjk4LjdDMTcwLjcgMjUxLjUgMjA4LjkgMjEzLjMgMjU2IDIxMy4zSDQyNi43VjI5OC43SDI1NlY3NjhINzI1LjRWNTk3LjNIODEwLjdWNzY4QzgxMC43IDgxNS4xIDc3Mi41IDg1My4zIDcyNS40IDg1My4zWk00OTkuMiA1ODQuOEw0MzkuMSA1MjQuNSA3MDcuNiAyNTZINTU0LjdWMTcwLjdIODUzLjRWNDY5LjNINzY4VjMxNi40TDQ5OS4yIDU4NC44WiI+IAogICA8L3BhdGg+IAogICA8L3N2Zz4=");
	background-position: 0px 50%;
	background-size: 13px 13px;
	background-repeat: no-repeat;
    padding-left: 16px;
    padding-right: 6px;
	
}

ul.inlineList > li > a.outsideLink[href]::before {
  /* content: counter(anchor) ". ";  */
  background-image: URL("data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxZW0iIGhlaWdodD0iMWVtIiBmaWxsPSIjMDAwMEVFIiB2aWV3Qm94PSIxNTAgMTIwIDcyNCA3MjQiPiAKICAgPHBhdGggZD0iTTMwMS44IDQxOC43TDIxNCA1MDYuNWExOTIgMTkyIDAgMSAwIDI3MS41IDI3MS41bDExNy0xMTdBMTkyIDE5MiAwIDAgMCA1NDkuNSAzNTJMNTEyIDM4OS41YTY0LjEgNjQuMSAwIDAgMC05LjkgMTIuNyAxMjggMTI4IDAgMCAxIDU1LjEgMjEzLjZMNDQwLjMgNzMyLjhhMTI4IDEyOCAwIDEgMS0xODEuMS0xODEuMWw1MC44LTUwLjdhMjU3LjIgMjU3LjIgMCAwIDEtOC4yLTgyLjR6Ii8+IAogICA8cGF0aCBkPSJNNDIxLjUgMjk5QTE5MiAxOTIgMCAwIDAgNDc0LjUgNjA4bDQ5LjYtNDkuN2ExMjggMTI4IDAgMCAxLTU3LjMtMjE0LjFMNTgzLjcgMjI3LjJhMTI4IDEyOCAwIDEgMSAxODEuMSAxODEuMWwtNTAuOCA1MC43YzcuMiAyNi45IDkuOSA1NC43IDguMiA4Mi40bDg3LjgtODcuOGExOTIgMTkyIDAgMSAwLTI3MS41LTI3MS42TDQyMS41IDI5OXoiLz4KPC9zdmc+IA=="); /* 🔗 */
}
/* If there is only one link, no need for order number */
ul.inlineList > li:only-of-type > a[href]::before {
  content: ""; /*⚓ 🔗*/
}
svg.svg-img-infor {
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    user-select: none;
    width: 1.1em;
    height: 1.1em;
    display: inline-block;
	color: #0fa8a8;
    fill: currentColor;
	font-size: inherit;
	margin-bottom: -3px;
	margin-right: 5px;
	&:hover{
		color:#0d8707 !important;
	}
}
</style>

<!-- STYLE FOR BUTTONS AND SELECT IN MAIN PAGE USING SVG -->
<style>
/* Audio control button using SVG */
.control-button-flex {
    display: flex;
	flex-flow: row wrap;
	justify-content: center;
	align-items: center;
	gap: 8px;
	max-width: 100%;
	margin-bottom: 5px;
	background-color: transparent; /* #FBB040; */
}

.control-button-flex button, .svgButton {
	cursor: pointer;
    -webkit-appearance: button;
    background-color: transparent;
    background-image: none;
    text-transform: none;
	margin: 0px;
    padding: 4px 4px 1px 4px;
	border: var(--button-border-style);
	border-radius: 20%;
	color: inherit;
}

.control-button-flex button:hover, .svgButton:hover{
	color: var(--button-hover-border-color);
	background-color: var(--button-hover-bground-color);

	/* Make the remainder circle and played circle of circle-progress button a bit darker */
	--audio-playing-current-progress-played-color:#0ee302; 
	--audio-playing-current-progress-remained-color: #656565;
	
	-webkit-transition: background-color .2s ease;
    transition: background-color .2s ease;
}

svg.button-svg-img {
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    user-select: none;
    width: 1.25em;
    height: 1.25em;
    display: inline-block;
    fill: currentColor;
    -webkit-flex-shrink: 0;
    -ms-flex-negative: 0;
    flex-shrink: 0;
    -webkit-transition: fill 200ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;
    transition: fill 200ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;
    font-size: inherit;
	margin: auto -2px;
}
.\!text-\[15px\] {
    font-size: 15px !important;
}
.\!text-\[20px\] {
    font-size: 20px !important;
}
.\!text-\[25px\] {
    font-size: 25px !important;
}
.\!text-\[30px\] {
    font-size: 30px !important;
}
.\!text-\[35px\] {
    font-size: 35px !important;
}
.\!text-\[40px\] {
    font-size: 40px !important;
}
.\!text-\[50px\] {
    font-size: 50px !important;
}
.\!text-\[55px\] {
    font-size: 55px !important;
}
.\!text-\[80px\] {
    font-size: 80px !important;
}
.rotate-90 {
    transform: rotate(90deg);
}
.rotate-180 {
    transform: rotate(180deg);
}
.elm-hidden{/* This css for hiding element only and being used alot. SHOULD NOT touch this css, if in need, create other one */
	display: none !important;
}
.elm-disabled {
    cursor: not-allowed !important;
	pointer-events: none;
	color: gray !important;
	background-color: #ddd8d8 !important;
}

.animate-spin{animation:spin 1s linear infinite}
@keyframes spin {
    from {
        transform:rotate(0deg);
    }
    to {
        transform:rotate(360deg);
    }
}
</style>

<!-- ------------------------
    Audio Player - AP
------------------------ -->
<style>
/* Player and control panel */
.ap-container {
	max-width: 100%;
	background-color: #dfdbe5; /* #ddd */
	border: 1px solid darkcyan;
	border-radius: 4px;
	margin-bottom: 5px;
	padding: 4px 0px;
}
.ap-panel {
  display: -webkit-box;
  display: -webkit-flex;
  display: -ms-flexbox;
  display: flex;
}
.ap-sub-panel {
  display: -webkit-box;
  display: -webkit-flex;
  display: -ms-flexbox;
  display: flex;
  -webkit-box-flex: 0; /* 1 */
  -webkit-flex: 0; /* 1 */
      -ms-flex: 0; /* 1 */
          flex: 0; /* 1 */
  		 -webkit-box-pack: center;
  -webkit-justify-content: center;
      		-ms-flex-pack: center;
          justify-content: center;
  		-webkit-box-align: center;
  	  -webkit-align-items: center;
      	   -ms-flex-align: center;
          	align-items: center;
}
.ap--track {
  -webkit-box-flex: 1;
  -webkit-flex: 1 0 auto; /* 1 40% */
      -ms-flex: 1 0 auto; /* 1 40% */
          flex: 1 0 auto; /* 1 40% */
  padding: 0 5px;
}

.ap--playback, .ap--settings{
-webkit-box-flex: 0; /* 1 */
    -webkit-flex: 0; /* 1 */
        -ms-flex: 0; /* 1 */
            flex: 0; /* 1 */
}
.ap--settings > .ap-controls,
.ap--playback > .ap-controls {
  -webkit-box-flex: 0;
  -webkit-flex: 0 ; /* 25% */
      -ms-flex: 0 ; /* 25% */
          flex: 0 ; /* 25% */
}
.ap--settings button,
.ap--playback button
{		  
padding-left : 6px; /* On Ios, default padding is very wide (19px), so we need to fix this to save space of buttons for progress bar */
padding-right: 6px;
}

/* Info section */
.ap-info {
  width: 100%;
  position: relative;
  -webkit-align-self: flex-start;
      -ms-flex-item-align: start;
          align-self: flex-start;
  padding: 5px 0 0;
}
.ap-title {
  position: relative;
  padding-right: 10px;
  text-align: left;
  white-space: nowrap;
  text-overflow: ellipsis;
  overflow: hidden;
  font-size: 15px;
  width: 350px;
}
.ap-time {
  position: absolute;
  top: 5px;
  right: 0;}
.ap-time * {  
  font-size: 15px;
}
.ap-progress-container {
  padding: 5px 0 10px;
  cursor: pointer;
}
.ap-progress {
  position: relative;
  height: 5px;
  border-radius: 5px;
  background: #c4c4c4;
}
.ap-progress-preload-bar,
.ap-progress-bar {
  position: absolute;
  left: 0;
  top: 0;
  bottom: 0;
  width: 0;
  border-radius: 5px 0 0 5px;
}
.ap-progress-preload-bar{
	background: #a6a6a6;
	z-index: 0;
}
.ap-progress-bar {
  background: #f50; /* #f50 steelblue*/
  transition: width .5s;
  z-index: 1;
}
.ap-progress-bar::after {
  position: absolute;
  top: 0;
  right: -5px;
  width: 12px;
  height: 12px;
  margin-top: -4px;
  content: '';
  border-radius: 6px;
  background: #f50;
  opacity: 0.3;
  -webkit-transition: opacity .3s ease;
  transition: opacity .3s ease;
}
.ap-progress-container:hover .ap-progress-bar::after {
  opacity: 1;
}
.ap-buffer-bar{
	width: 100%;
	height: 4px;
	border-radius: 4px;
	line-height: 5px;
    display: block;
}

/* Buttons */
.ap-controls {
  position: relative;
  z-index: 2;
  display: block;
  height: 50px;
  cursor: pointer;
  -webkit-transition: background .2s ease;
  transition: background .2s ease;
  text-align: center;
  color: #222;
  border: 0;
  outline: 0;
  background: none;
  &:hover{
	background-color: #ccc;
  }
}

.ap-controls {
	cursor: pointer;
    -webkit-appearance: button;
    background-color: transparent;
    background-image: none;
    text-transform: none;
	margin: 0px;
	/* padding: 4px 4px 1px 4px;
	border: var(--button-border-style); */
	border-radius: 20%;
	color: inherit;
}

.ap-controls:hover, .svgButton:hover{
	color: var(--button-hover-border-color);
	background-color: var(--button-hover-bground-color);

	/* Make the remainder circle and played circle of circle-progress button a bit darker */
	--audio-playing-current-progress-played-color:#0ee302; 
	--audio-playing-current-progress-remained-color: #656565; 
}

/* .ap-controls svg {
  fill: #333;
}
.ap-controls:hover svg {
  fill: #222;
} */
.ap-controls:active {
  background: rgba(0,0,0,.1);
}

.ap-volume-container {
  z-index: 3;
}
    
.ap-volume {
  position: absolute;
  right: 0;
  bottom: 50px;
  overflow: hidden;
  width: min(100%, 35px); /* 100% */
  height: 0;
  visibility: hidden;
  -webkit-transition: height .2s cubic-bezier(0.17, 0.72, 0.26, 1.23);
  transition: height .2s cubic-bezier(0.17, 0.72, 0.26, 1.23);
  background: #f2f2f2;
  border: 1px solid #ccc;
  border-bottom: 0;  
}
.ap-volume-btn {
  display: block;
  text-align: center;
  width: 100%;
  padding-right: 9px !important;
}
.ap-volume-btn > svg > .ap--volume-off,
.muted > svg > .ap--volume-on {
  display: none;
}
.muted > svg > .ap--volume-off {
  display: inline;
}
.ap-volume-container:hover {
  background: #ddd;
}
.ap-volume-container:hover .ap-volume {
  height: 120px;
  visibility: visible;
}
.ap-volume-progress {
  display: block;
  width: 4px;
  height: 100px;
  margin: 10px auto;
  background: rgba(0,0,0,.2);
  position: relative;
  border-radius: 3px;
}
.ap-volume-bar {
  position: absolute;
  left: 0;
  right: 0;
  bottom: 0;
  background: #f50;
  height: 50%;
  border-radius: 3px;
}

.ap-speed-container{
	display: flex;
	align-items: center;
	gap: 1px;
}
.ap-change-speed-buttons{
    display: flex;
	flex-flow: column wrap;
	justify-content: center;
	align-items: stretch;
	gap: 0px;
	/* max-width: 100%;
	margin-bottom: 5px; */
	background-color: transparent; /* #FBB040; */
}
.ap-change-speed-buttons > button{ /* plus/minus speed buttons */
	border: none;
	background-color: transparent;
	padding: 0px 2px;
}

.ap-speed-option-select{
	background: transparent url(https://uxwing.com/wp-content/themes/uxwing/download/transportation-automotive/speed-test-icon.svg) 57% 3px / 30px no-repeat;
    padding-top: 30px;
	padding-bottom: 4px;
    -moz-appearance: none;
    -webkit-appearance: none;
    appearance: none;
    font-size: 15px;
    text-align-last: center;
    color: #000;
	border: none;
	border-radius: 8px;
	/* border:var(--button-border-style);
    border-radius: 15%; */
    cursor: pointer;
	
}
.ap-speed-option-select:hover{
	filter: var(--select-hover-bground-filter);
}
.ap-change-speed-buttons > button:hover{
	color: var(--button-hover-border-color);
	background-color: var(--button-hover-bground-color) !important;
}
.ap-active {
  background: rgba(0,0,0,.15);
  opacity: 1;
}

/* ------------HANDLING RESPONSIVE--------------- */
@media(min-width:1050px) {
  .ap-title{
	width: 580px; /* Wide screen such as iPad Pro or desktop, make title wider */	
  }
}
@media(min-width:850px) {
	.ap-container{
		border-radius: 10px;
	}
}
@media(max-width:850px) {
	.ap-title{
		width: 0px;
		visibility: hidden ; /* Hide title but keeps it there to take the space for progress bar display vertically center */
	}
}

/* @media(max-width:800px) {
  .ap-sub-panel > .ap-controls {
    -webkit-box-flex: 1;
    -webkit-flex: 1;
        -ms-flex: 1;
            flex: 1;
  }
} */

@media(max-width:550px) {
  .ap-container{
	/* min-width: 400px; */
	width: 100%;
    height: auto;
	background-color: transparent;
	border: none;
  }
  .ap-panel {
    -webkit-flex-wrap: wrap;
        -ms-flex-wrap: wrap;
            flex-wrap: wrap;
	justify-content: space-evenly;
	height: auto;
  }
  
  .ap--track {
    margin-bottom: 10px;
	padding: 8px 10px;
	background-color: #ddd; /* #56AEFF #B1D4E0*/
	border-radius: 20px;
    -webkit-box-ordinal-group: 2;
    -webkit-order: 1;
        -ms-flex-order: 1;
            order: 1;
    -webkit-box-flex: 1;
    -webkit-flex: 1 1 100%;
        -ms-flex: 1 1 100%;
            flex: 1 1 100%;
  }
  .ap--playback { 
	/* Only .ap--playback take extra space, .ap--settings keeps flex-grow=0 so take no extra space */
    -webkit-box-flex: 1;
    -webkit-flex: 1 1 70%;
        -ms-flex: 1 1 70%;
            flex: 1 1 70%;
    -webkit-box-ordinal-group: 3;
     -webkit-order: 2;
    -ms-flex-order: 2;
			 order: 2;
  }
  .ap--settings{
	-webkit-box-ordinal-group: 4;
     -webkit-order: 3;
    -ms-flex-order: 3;
			 order: 3;
  }
  
  .ap--playback > .ap-controls {
  -webkit-box-flex: 1;
  -webkit-flex: 1 ; /* 25% */
      -ms-flex: 1 ; /* 25% */
          flex: 1 ; /* 25% */
  }

  .ap-title, .ap-time{
	display: none;
  }
}
/* @media(max-width:450px) {
  .ap-panel {
    flex-direction: row;
	justify-content: space-evenly;
	height: auto;
  }
} */
</style>

<!-- Format ol, li of Playlist and popup book group list-->
<style>
:is(ol#elmPlaylist, ol.lstBookTitlesSetting){
	max-height: 450px;
	list-style: none;
	overflow-y: auto; /*overlay*/
	overflow-x: hidden;
	/*list-style: decimal-leading-zero;*/
	padding-left: 40px; /* to reserve space for li::before which show chapter order UI */
	border: 1px solid #bdbec0;
    border-radius: 10px;
}

:is(ol#elmPlaylist, ol.lstBookTitlesSetting) li{
	text-align: left;
	/* font-size: 16px; */
	color: #4F4F4F;
	position: relative;
	line-height: 21px;
	
	padding: 10px 0px 5px 7px;
	border-bottom: 1px solid #730a50c4;
    cursor: pointer;
	transition: color 0.4s;
	&:hover{
		background: linear-gradient(to right, rgba(255, 138, 0, 0.2), #fff) !important; /* background-color: #d8e08457; */
		transform: translate(0.5%, 0px);  /* scale(1.05) translate(3%, 0px) */
		box-shadow: 2px 2px 15px 4px rgba(51, 51, 51, 0.18);
		&::before{
			background-color: #f1a25a38 !important;
		}
	}
	&::before {
		/* counter-increment: list-item; */
		content: counter(list-item); /* counter(list-item, decimal-leading-zero) to have leading 0 */
		color:black;
		font-size: var(--playlist-item-title-font-size);
		font-weight: 700;
		display: flex;
		height: 32px;
		width: 32px;
		border-radius: 50%;
		border: 1.5px solid #454545;
		background: #afafaf54;
		justify-content: center;
		align-items: center;
		position: absolute;
		top: 2px;
		left: -36px;
	}

	&.beingPlay{ /* mark that a chapter being played or a book set/kit just being drag in setting */
		background: linear-gradient(to right, rgba(156, 39, 176, 0.2), #fff)  !important; 
		box-shadow: 2px 2px 15px 7px rgb(241 180 180 / 27%);
		&::before {
			border-color: #d52323;
			background: rgba(156, 39, 176, 0.25);
		}
	}
	
	/* Format the chapter titles in the list */
	& > span{
		color:#4F4F4F;
		font-size: var(--playlist-item-title-font-size);
		font-weight: var(--playlist-item-title-font-weight);
	}
	/* Format the duration wrap in <code> tag */
	& > code{
		display: inline-block;
		text-align: right;
		font-size: 0.9em;
	}
}
/* customize for even li */
:is(ol#elmPlaylist, ol.lstBookTitlesSetting) li:nth-of-type(even){
	background: linear-gradient(to left, rgba(138, 138, 138, 0.2), #fff);
	&:before {
		border-color: #2378D5;
		background: #2378d547;
	}
	/* Format the chapter titles in the list */
	& > span{
		color:#2378D5;		
	}
}
:is(ol#elmPlaylist, ol.lstBookTitlesSetting) :is(li:first-of-type, ul > li:first-of-type){
	border-top: 1px solid #730a50c4;
}

ol.lstBookTitlesSetting > li:has(> input[type="checkbox"]:not(:checked)){
	/* li that has unchecked chkbox, paint it gray */
	& > span, & > code {
		color: #639858 !important;
	}
	&::before{
		color: #999 !important;
	}
}

/* Chapter group css */
ol#elmPlaylist:has(section){
	padding-left: 0px !important; /* default #elmPlaylist has no section, so its  padding-left: 40px to reserve space for li::before which show chapter order UI*/	
}
ol#elmPlaylist > input[type=checkbox] { display: none; }
ol#elmPlaylist > input[type=checkbox] + label + section { 
	padding-left: 40px !important; /* to reserve space for li::before which show chapter order UI. Note that #elmPlaylist that has section set padding-left: 0px */
	max-height: 0;
	max-width: 0;
	transform: scaleY(1); 
	opacity: 0;
	overflow: hidden;
	/* white-space:nowrap; */
	-webkit-transition:all .5s ease;  
	-moz-transition:all .5s ease;  
	-o-transition:all .5s ease;  
	transition:all .5s ease;  
}
ol#elmPlaylist > input[type=checkbox]:checked + label + section { 
	max-height: 100%;
	max-width: 100%;
	transform: scaleY(1);
	opacity: 1;
}

/* label to define beginning of chapter group. This is for label when its previous sibling checkbox is CHECKED, meaning section expanded and is default style */
ol#elmPlaylist > input[type=checkbox] + label{
	color: rgb(139, 0, 127);
	margin: 4px auto;
	margin-left: 2px;
	padding: 7px 0px 7px 5px;
	cursor: pointer;
	display: flex; /* to display label center horizontally and vertically */
    align-items: center;
	justify-content: center;
	
	&.is-sticky{ /* This for sticky label */
		position: -webkit-sticky;
		/* for safari */
		position: sticky;
		z-index: 2;
		top: -0.1px; /* the hack for label being partly (0.1px) hidden, so IntersectionObserver triggers action (adding .stickyPinned class) when label being pinned (stickied) at the top */
		background-image: linear-gradient(to right, #e9d8c788 0%, #FFFFFF99 51%, #e9d8c788 100%);
		border: 1.5px solid rgb(144 42 136);
		border-radius: 5px;
		
	}
	&.stickyPinned{ /* This is for label when being pinned */
		
		color: red;
		background-image: linear-gradient(to right, #b7d1e6e9 0%, #eef2f3dd 51%, #b7d1e6cc 100%) !important; /* linear-gradient(to right, #9284add1 0%, #fdfdfd 51%, #9284add1 100%) !important
		*/
		border-right-width: 5px !important;
		
		&::before{
			border-top-color: red; /* change color for small triangle */
			rotate: -180deg !important;
			transform: translate(0px, 4px);
		}
	}
	/* format differently for label that its next sibling section contain li chapter that is playing */
	&:has(+ section > li.beingPlay){ 
		color: rgb(116 25 196);
		background-image: linear-gradient(to top left, #abb1f3bd, #ffffff2e 80%);
		font-weight: bold;
		&::before{
			border-top-color: rgb(116 25 196); /* change color for small triangle */
		}
	}
	
	/* underline animation effect class */
	& > span > code.underlineAnim{ /* prepare for label hover effect */
		--bg-h: 2px;
		text-decoration: none;
		/* display: inline; */
		background-image: linear-gradient(to right, slateblue, grey);
		background-position: 0px calc(1em + 4px + var(--bg-h));
        background-repeat: no-repeat;
        background-size: 0% var(--bg-h);
        transition: background-size 0.5s ease-in-out;
        padding-bottom: 3px;
	}
	
	&:hover{
		color: darkcyan !important;
		/* text-transform: capitalize; uppercase */
		/* font-weight: bold; */
		&::before{
			border-top-color: darkcyan !important; /* change color for small triangle */
		}
		/* parent on hover: underline animation effect class */
		& > span > code.underlineAnim{ /* change background width=100% to make the animation */
			background-size: 100% var(--bg-h);
			background-position-x: left;
		}
	}
	&::before{
		content: '';
		display: inline-block;
		width: 0;
		height: 0;
		border: 5px solid transparent;
		border-width: 10px 5px;	
		border-top-color: rgb(139, 0, 127); /* these 7 css lines is to make ⏵ */
		margin-left: 4px;
		
		-webkit-transition:all .5s ease;  
		-moz-transition:all .5s ease;  
		-o-transition:all .5s ease;  
		transition:all .5s ease;
		transform-origin:25% 50%;
		transform: translate(-5px, calc(50% - 2px));
	}
}

@media (pointer: coarse){
	/* for smart device has (pointer: coarse), the font-size set to 19px, so we need to change background-position so it not go off of the element and user cann't see it */
	ol#elmPlaylist > input[type=checkbox] + label > span > code.underlineAnim{ 
		--bg-h: 1.5px;
		background-position: 0px calc(1em - 1px);
	}
}

/* Customize for section collapsed  */
ol#elmPlaylist > input[type=checkbox]:not(:checked) + label{
	background-image: linear-gradient(to bottom right, #fdfcfb00, #e2d1c3b3);
	border: 1px solid rgb(139, 0, 127);
	border-left: 5px solid rgb(139, 0, 127);
	border-radius: 5px;
	justify-content: space-between; /* to force the triangle in ::before to align left (looks like float:left) and label content align right */
	padding-right: 5px;
	&:has(+ section > li.beingPlay){ /* format differently for label that its next sibling section contain li chapter that is playing */
		background-image: linear-gradient(to bottom right, #abb1f3bd, #ffffff2e 80%);
	}

	&::before{
		rotate: -90deg;
		transform: translate(-3px, 4px);
	}
}

/* adding playing icon for beingPlay item */
ol#elmPlaylist li.beingPlay::after {
	content: url("data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMC41IDciIGZpbGw9InJlZCI+PGc+PHJlY3QgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMC41MDAwMDAsIDYuMDAwMDAwKSByb3RhdGUoMTgwLjAwMDAwMCkgdHJhbnNsYXRlKC0wLjUwMDAwMCwgLTYuMDAwMDAwKSIgeD0iLTAuNSIgeT0iNSIgd2lkdGg9IjEuNSIgaGVpZ2h0PSIyIj48YW5pbWF0ZSBhdHRyaWJ1dGVOYW1lPSJoZWlnaHQiIHZhbHVlcz0iMjs3OzIiIGtleVRpbWVzPSIwOzAuNTsxIiBkdXI9IjEuMnMiIHJlcGVhdENvdW50PSJpbmRlZmluaXRlIi8+PC9yZWN0PjxyZWN0IHRyYW5zZm9ybT0idHJhbnNsYXRlKDMuNTAwMDAwLCA0LjUwMDAwMCkgcm90YXRlKDE4MC4wMDAwMDApIHRyYW5zbGF0ZSgtMy41MDAwMDAsIC00LjUwMDAwMCkiIHg9IjIuNSIgeT0iMiIgd2lkdGg9IjEuNSIgaGVpZ2h0PSI1Ij48YW5pbWF0ZSBhdHRyaWJ1dGVOYW1lPSJoZWlnaHQiIHZhbHVlcz0iNTsxOzc7NSIga2V5VGltZXM9IjA7MC40OzAuODsxIiBkdXI9IjIuOHMiIHJlcGVhdENvdW50PSJpbmRlZmluaXRlIi8+PC9yZWN0PjxyZWN0IHRyYW5zZm9ybT0idHJhbnNsYXRlKDYuNTAwMDAwLCAzLjUwMDAwMCkgcm90YXRlKDE4MC4wMDAwMDApIHRyYW5zbGF0ZSgtNi41MDAwMDAsIC0zLjUwMDAwMCkiIHg9IjUuNSIgeT0iMCIgd2lkdGg9IjEuNSIgaGVpZ2h0PSI3Ij48YW5pbWF0ZSBhdHRyaWJ1dGVOYW1lPSJoZWlnaHQiIHZhbHVlcz0iNzswOzciIGtleVRpbWVzPSIwOzAuNTsxIiBkdXI9IjFzIiByZXBlYXRDb3VudD0iaW5kZWZpbml0ZSIvPjwvcmVjdD48cmVjdCB0cmFuc2Zvcm09InRyYW5zbGF0ZSg5LjUwMDAwMCwgNS4wMDAwMDApIHJvdGF0ZSgxODAuMDAwMDAwKSB0cmFuc2xhdGUoLTkuNTAwMDAwLCAtNS4wMDAwMDApIiB4PSI4LjUiIHk9IjMiIHdpZHRoPSIxLjUiIGhlaWdodD0iNCI+PGFuaW1hdGUgYXR0cmlidXRlTmFtZT0iaGVpZ2h0IiB2YWx1ZXM9IjI7NzsyIiBrZXlUaW1lcz0iMDswLjU7MSIgZHVyPSI0LjdzIiByZXBlYXRDb3VudD0iaW5kZWZpbml0ZSIvPjwvcmVjdD48L2c+PC9zdmc+");
    width: 18px; /* height changes with width, that why scaleY below */
	transform: scaleY(1.3);
	display: block;
    position: absolute;
    right: 4px;
	bottom: 4px;
    /* vertically center the playing bars
	top: 50%;
    transform: translateY(-50%); */
}

/*       ScrollBar         */
:is(ol#elmPlaylist, ol.lstBookTitlesSetting)::-webkit-scrollbar {
	width: 10px;
}

:is(ol#elmPlaylist, ol.lstBookTitlesSetting)::-webkit-scrollbar-track {
	border-radius: 8px;
	background-color: #e7e7e7;
	border: 1px solid #cacaca;
}

:is(ol#elmPlaylist, ol.lstBookTitlesSetting)::-webkit-scrollbar-thumb {
	border-radius: 8px;
	border: 3px solid transparent;
	background-clip: content-box;
	background-color: #d55959;
}
/* End of Playlist*/

/* Class for changing UI of Book Sets when their parent's Book Kit is hover. See bookSetList() function for more
For now, maximum two Book Kits having more than one Book Sets (for all group way), if there are more than such two book kit, we can add style for .bookKitNo2-Childs, .bookKitNo3-Childs, ...
*/
div[name="bookKitChkboxContainer"] > :is(.bookKitNo0, .bookKitNo1){
	-webkit-tap-highlight-color: rgba(0,0,0,0);
	-webkit-user-select: none;
	-webkit-touch-callout: none /*only to disable context menu on long press*/
}

.bookKitNo0:hover > label, div[name="bookKitChkboxContainer"]:has(> .bookKitNo0:hover) + ol > li.bookKitNo0-Childs{
	background: linear-gradient(to right, rgb(0 123 255 / 20%), #fff) !important
}
.bookKitNo1:hover > label, div[name="bookKitChkboxContainer"]:has(> .bookKitNo1:hover) + ol > li.bookKitNo1-Childs{
	background: linear-gradient(to right, rgb(255 226 0 / 20%), #fff) !important
}
</style>

 <!-- Toast / snackbar  -->
<style>
	/* The snackbar - position it at the bottom and in the middle of the screen */
#toastSnackbar {
  visibility: hidden; /* Hidden by default. Visible on click */
  min-width: 250px; /* Set a default minimum width */
  max-width: calc(100vw - 50px);
  margin-left: -10px;
  background-color: #333; /* Black background color */
  color: #fff; /* White text color */
  text-align: center; /* Centered text */
  border-radius: 2px; /* Rounded borders */
  padding: 16px; /* Padding */
  position: fixed; /* Sit on top of the screen */
  z-index: 1; /* Add a z-index if needed */
  left: 50%; /* Center the snackbar */
  transform: translateX(-50%);
  font-size: 27px;
  bottom: 30px; /* 30px from the bottom */
}
@media only screen and (max-width: 450px) {
	#toastSnackbar { 
		font-size: 24px;/* toast text a bit smaller on small screen */
	}
}
/* Show the snackbar when clicking on a button (class added with JavaScript) */
#toastSnackbar.showSnackbar {
  visibility: visible; /* Show the snackbar */
  /* Add animation: Take 0.5 seconds to fade in and out the snackbar.
  However, delay the fade out process for 2.5 seconds */
  -webkit-animation: fadein 0.5s, fadeout 0.5s 2.5s;
  animation: fadein 0.5s, fadeout 0.5s 2.5s;
}

/* Animations to fade the snackbar in and out */
@-webkit-keyframes fadein {
  from {bottom: 0; opacity: 0;}
  to {bottom: 30px; opacity: 1;}
}

@keyframes fadein {
  from {bottom: 0; opacity: 0;}
  to {bottom: 30px; opacity: 1;}
}

@-webkit-keyframes fadeout {
  from {bottom: 30px; opacity: 1;}
  to {bottom: 0; opacity: 0;}
}

@keyframes fadeout {
  from {bottom: 30px; opacity: 1;}
  to {bottom: 0; opacity: 0;}
}
</style>

<!-- small popup css -->
<style>
.havingShortPopup{
	display: inline-block;
	position: relative;
}
.havingShortPopup .shortPoup{
	visibility: hidden;
	width: min(400px, calc(100vw - 75px)); /* to prevent jump2Chapter popup go outside of screen viewport*/
	top: 100%;
	left: 50%;
	/* margin-left: -150px; Use half of the width (300/2 = 150), to center the tooltip */
	transform:translateX(-50%);
	
	background-color: #656565;
	color: #fff;
	text-align: center;
	padding: 5px;
	border: 1px solid gray;
	border-radius: 6px;
	box-shadow: rgb(38, 57, 77) 0px 20px 30px -10px;
	
	/* box-shadow: rgba(0, 0, 0, 0.3) 0px 19px 38px, rgba(0, 0, 0, 0.22) 0px 15px 12px; */

	/* Position the tooltip text - see examples below! */
	position: absolute;
	z-index: 1;
	
	opacity: 0;
	transition: opacity 1s;
}
.havingShortPopup .shortPoup::after {
  content: " ";
  position: absolute;
  bottom: 100%;  /* At the top of the tooltip */
  left: 50%;
  margin-left: -10px;
  border-width: 8px;
  border-style: solid;
  border-color: transparent transparent #656565 transparent;
}
@media only screen and (max-width: 450px) {
	/* for small screen such as iPhone, popup needs not to appear outside of screen */
	.havingShortPopup .shortPoup{
		left: 5px;
		transform:translateX(-35px);
	}
	.havingShortPopup .shortPoup::after {
		left: 50px;
	}

}
.havingShortPopup .shortPoupShow{
	visibility: visible !important;
	opacity: 1;
}
/* .havingShortPopup:not(:hover) .shortPoupShow{
	visibility: hidden !important;
	opacity: 1;
} */
.shortPoup input:not([type="button"]){
	width: 10em;
}
/* Remove Arrows/Spinners */
/* Chrome, Safari, Edge, Opera */
input::-webkit-outer-spin-button,
input::-webkit-inner-spin-button {
  -webkit-appearance: none;
  margin: 0;
}

/* Firefox */
input[type=number] {
  -moz-appearance: textfield;
}
.shortPoup input + span {
  padding-right: 30px;
}

.shortPoup > * {
	margin-bottom: 5px;
}
.shortPoup > label {
	display: inline-block; /* for margin to work */
}
.shortPoup > label > b{
	font-weight: 400;
	color: rgb(208, 243, 153);
}
.shortPoup input:invalid + span.checkInputValidity::after {
  position: absolute;
  content: "✖";
  color: #ff7272;
  font-size: 1.2em;
  padding-left: 5px;
}

.shortPoup input:valid + span.checkInputValidity::after {
  position: absolute;
  content: "✓";
  color: #80f9f9;
  font-size: 1.15em;
  padding-left: 5px;
}
.shortPoup .popupCloseButton{
	float: right;
	padding: 2px 4px;
	border: 1px solid gray;
	border-radius: 5px;
	background-color: #ddd;
}
.shortPoup .popupCloseButton:hover{
	background-color: #d2f3f3;
}
.shortPoup .popupCloseButton::before{
	content: '✕';
}
/* Drag and Drop */
.activeDragItem{
	transform: scaleY(1.2);
	box-shadow: rgba(181, 14, 14, 0.16) 0px 1px 4px, rgb(124, 76, 76) 0px 0px 0px 3px;
}
.activeDropItem{
	transform: scaleX(1.2);
	background-color: #21ff1577 !important;
	box-shadow: rgba(0, 0, 0, 0.16) 0px 1px 4px, rgb(51, 51, 51) 0px 0px 0px 3px;
}
</style>

<!-- BOOK GROUP SETTING MODAL POPUP -->
<style>
	/* CSS nền hiển thị Modal */
	.modalPopup .modalPopupOverlay {
	  position: fixed;
	  top: 0px;
	  left: 0px;
	  width: 100vw;
	  height: 100vh;
	  background: rgba(0, 0, 0, 0.7);
	  z-index: 11;
	  display: none;
	}
	/* CSS bảng nội dung Modal */
	.modalPopup .modalPopupContentWrapper {
	  position: absolute;
	  display: block; /* This line and next to fit wrapper height to the content */
	  overflow: auto;
	  top:  50%; /* min(50%, 200px)Use 50% if you want the modal verically middle of screen */
	  left: 50%;
	  transform: translate(-50%, -50%) scale(0);
	  background-color: #fff; /* DFDBE5 */
	  width: min(80vw, 850px);
	  z-index: 12;
	  text-align: center;
	  padding: 15px 20px 5px 20px;
	  box-sizing: border-box;
	  border-radius: 20px;
	  display: block;
	  position: fixed;
	  box-shadow: 0px 0px 10px #111;
	}

	@media (max-width: 700px) {
	  .modalPopup .modalPopupContentWrapper {
		width: 95vw;
	  }
	}
	/* CSS Header bao bọc title & nút tắt Modal */
	.modalPopup .modalHeader {
		display: flex;
		align-items: center;
		justify-content: space-between;
		margin-top: -10px;
		/* margin-bottom: 10px; */
	}
	/* CSS tieu de của Modal */
	.modalPopup .modalHeader .modalTitle #elmHistoryWipeAll{
		display: flex;
		align-items: center;
		width: 34px;
		&::after{
			content: "Wipe out all saved data";
			position: absolute;
			left: 60px;
		}
	}

	.modalPopupContent #chkDisableCircleProgressButton{
		&:checked + label::before{
			content: "Show Play progress";
			color: var(--select-book-group-color);
		}
		&:not(:checked) + label::before{
			content: "Hide Play progress";
		}
	}
	.modalPopupContent #chkHideBufferBar{
		&:checked + label::before{
			content: "Show audio buffer bar";
			color: var(--select-book-group-color);
		}
		&:not(:checked) + label::before{
			content: "Hide audio buffer bar";
		}
	}

	@media (min-width: 800px) {
		.modalPopup .modalHeader .modalTitle #elmHistoryWipeAll::after {
			content: "Xóa toàn bộ thông tin đã lưu";
	  	}
		.modalPopupContent #chkDisableCircleProgressButton{
			&:checked + label::before{
				content: "Hiện tiến trình trên nút Play";
			}
			&:not(:checked) + label::before{
				content: "Ẩn tiến trình trên nút Play";
			}
		}
		.modalPopupContent #chkHideBufferBar{
		&:checked + label::before{
			content: "Hiện thanh audio buffer";
		}
		&:not(:checked) + label::before{
			content: "Ẩn thanh audio buffer";
		}
	}
		
	}

	/* CSS nút tắt modal */
	.modalPopup .modalHeader .closeModal {
		transform: translate(10px, 0px); 
    	width: 42px;
		height: 42px;
		text-align: center;
		padding: 2px;
		cursor: pointer;

		border-radius: 10px;
		background: #eee;
		/* border-radius: 50%; */
		border: 1px solid #aaa;
		&::before {
			content: ' ';
			background: transparent url("https://uxwing.com/wp-content/themes/uxwing/download/checkmark-cross/remove-icon.svg") 0px 0px / 35px 35px no-repeat !important;
			display: block;			
			width: 35px;
			height: 35px;
			text-align: center;			
		}
		&:hover{
			background: #ccc;
			&::before {
				filter: invert(14%) sepia(98%) saturate(7458%) hue-rotate(358deg) brightness(91%) contrast(122%);
				transition: filter 150ms ease-out;
			}
		}
	}
	.modalPopupContent > :is(:first-child, :last-child) {
		border: 1px solid gray;
		border-radius: 10px;
		background-color: #f0f8ffb0;
		padding: 5px 0px 2px 0px;
		margin: 5px 0px;
	}
	
	/* This conflict with tooltip, so it has to be removed
	.modalPopupContent #chkShowBookKit + label{
		&:checked + label::after{
			content: "Book Kit view";
		}
		&:not(:checked) + label::after{
			content: "Book Set view";
		}
		
	}*/
	
	.modalPopup.activeModalPopup .modalPopupOverlay {
	  display: block;
	  backdrop-filter: blur(2px);
	  -webkit-backdrop-filter: blur(2px);
	}
	/* CSS animation when Modal shown */
	.modalPopup.activeModalPopup .modalPopupContentWrapper {
	  transition: all 300ms ease-in-out;
	  transform: translate(-50%, -50%) scale(1);
	}

	.modalPopupContent #selPopupBookGroup {
		width: 90%;
		border-width: 2px;
		border-color: var(--select-book-group-color);
	}
	@media (min-width: 500px) {
		.modalPopupContent #selPopupBookGroup {
			width: 20em;
	  	}
	}
	/* Format ol, li of popup book group list. The others CSS are with ol#elmPlaylist */
	ol.lstBookTitlesSetting{/* responsive on screen height */
		margin: 5px 0px; /* to prevent margin-block-start, margin-block-end default is 1em = 17px */
		max-height: min(calc(80vh - 230px), 600px ) !important;
	}
	ol.lstBookTitlesSetting > li > input[type="checkbox"]{
		float:right;
		margin-right: 7px;
		font-size: 20px;
		border: 1px solid darkred !important;
	}

	/* Format checkbox */
	input:where([type="checkbox"][role="switch"]) {
		-webkit-appearance: none;
		-moz-appearance: none;
		appearance: none;
		position: relative;
		color: inherit;
		font-size: inherit;
		width: 2em;
		height: 1em;
		box-sizing: content-box;
		border: 1px solid;
		border-radius: 1em;
		vertical-align: text-bottom;
		margin: auto;

       &:checked:hover{
			background: color-mix(in srgb, #8bb9ee 60%, CanvasText 10%);
		}
		&:not(:checked):hover{
			background: color-mix(in srgb, GrayText 30%, CanvasText 10%);
		}
		/* Put last after :checked and :not:checked to avoid UI mess-up when browser does not know the state of checkbok */
        &:indeterminate:hover{
			background: color-mix(in srgb, GrayText 30%, white 70%);
		}
			
		&::before {
			content: "";
			position: absolute;
			top: 50%;
			left: 0;
			transform: translate(0, -50%);
			box-sizing: border-box;
			width: 0.7em;
			height: 0.7em;
			margin: 0 0.15em;
			border: 1px solid;
			border-radius: 50%;
			background: currentcolor;
		}
		&:checked::before {
			left: 1em;
			background: #0d8707;
		}
		/* Put last after :checked and :not:checked to avoid UI mess-up when browser does not know the state of checkbok */
		&:indeterminate{
			background: transparent;
			&::before {
				border-radius: 20%;
				left: 0.5em;
				background: #b8b8b8;
				scale: 0.8; /* make it smaller so it looks same size as circle */
				transform: translate(0, calc(-50% - 0.1em));
			}
		}

		&:disabled {
			opacity: 0.4;
		}
	}
</style>

<!-- CSS FOR LOADING PAGE -->
<style>

#loadingPageWrapper {
	position: fixed;
    top: 0px;
    left: 0px;
    width: 100vw;
    height: 100vh;
    background: white;
    z-index: 11;
 	& > div{
		height: 20px;
		width: 250px;
		position: absolute;
		top: 0;
		bottom: 0;
		left: 0;
		right: 0;
		margin: auto;
	}
}
#loadingPageWrapper .loader--dot {
	animation-name: loader-dots-anmation;
	animation-timing-function: ease-in-out;
	animation-duration: 3s;
	animation-iteration-count: infinite;
	height: 20px;
	width: 20px;
	border-radius: 100%;
	background-color: black;
	position: absolute;
	border: 2px solid white;

	&:first-child {
		background-color: #8cc759;
		animation-delay: 0.5s;
	}
	&:nth-child(2) {
	background-color: #8c6daf;
	animation-delay: 0.4s;
	}
	&:nth-child(3) {
	background-color: #ef5d74;
	animation-delay: 0.3s;
	}
	&:nth-child(4) {
	background-color: #f9a74b;
	animation-delay: 0.2s;
	}
	&:nth-child(5) {
	background-color: #60beeb;
	animation-delay: 0.1s;
	}
	&:nth-child(6) {
	background-color: #fbef5a;
	animation-delay: 0s;
	}
}

@keyframes loader-dots-anmation {
  15% {
    transform: translateX(0);
  }
  45% {
    transform: translateX(230px);
  }
  65% {
    transform: translateX(230px);
  }
  95% {
    transform: translateX(0);
  }
}
/* Loading text */
#loadingPageWrapper .loading-3dots--text{
	font-size: 2.3em;
	color:green;
	position: absolute;
	top: 150%;
	left: 0;
	right: 0;
	width: 4rem;
	margin: auto;
	transform: translateX(-60px);
}
.loading-3dots--text:after {
  content: "Loading";
  font-weight: bold;
  animation: loading-text-animation 3s infinite;
}
@keyframes loading-text-animation {
  0% {
    content: "Loading";
  }
  25% {
    content: "Loading.";
  }
  50% {
    content: "Loading..";
  }
  75% {
    content: "Loading...";
  }
}

.circus-background{
	background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 304 304' width='304' height='304'%3E%3Cpath fill='%239C92AC' fill-opacity='0.1' d='M44.1 224a5 5 0 1 1 0 2H0v-2h44.1zm160 48a5 5 0 1 1 0 2H82v-2h122.1zm57.8-46a5 5 0 1 1 0-2H304v2h-42.1zm0 16a5 5 0 1 1 0-2H304v2h-42.1zm6.2-114a5 5 0 1 1 0 2h-86.2a5 5 0 1 1 0-2h86.2zm-256-48a5 5 0 1 1 0 2H0v-2h12.1zm185.8 34a5 5 0 1 1 0-2h86.2a5 5 0 1 1 0 2h-86.2zM258 12.1a5 5 0 1 1-2 0V0h2v12.1zm-64 208a5 5 0 1 1-2 0v-54.2a5 5 0 1 1 2 0v54.2zm48-198.2V80h62v2h-64V21.9a5 5 0 1 1 2 0zm16 16V64h46v2h-48V37.9a5 5 0 1 1 2 0zm-128 96V208h16v12.1a5 5 0 1 1-2 0V210h-16v-76.1a5 5 0 1 1 2 0zm-5.9-21.9a5 5 0 1 1 0 2H114v48H85.9a5 5 0 1 1 0-2H112v-48h12.1zm-6.2 130a5 5 0 1 1 0-2H176v-74.1a5 5 0 1 1 2 0V242h-60.1zm-16-64a5 5 0 1 1 0-2H114v48h10.1a5 5 0 1 1 0 2H112v-48h-10.1zM66 284.1a5 5 0 1 1-2 0V274H50v30h-2v-32h18v12.1zM236.1 176a5 5 0 1 1 0 2H226v94h48v32h-2v-30h-48v-98h12.1zm25.8-30a5 5 0 1 1 0-2H274v44.1a5 5 0 1 1-2 0V146h-10.1zm-64 96a5 5 0 1 1 0-2H208v-80h16v-14h-42.1a5 5 0 1 1 0-2H226v18h-16v80h-12.1zm86.2-210a5 5 0 1 1 0 2H272V0h2v32h10.1zM98 101.9V146H53.9a5 5 0 1 1 0-2H96v-42.1a5 5 0 1 1 2 0zM53.9 34a5 5 0 1 1 0-2H80V0h2v34H53.9zm60.1 3.9V66H82v64H69.9a5 5 0 1 1 0-2H80V64h32V37.9a5 5 0 1 1 2 0zM101.9 82a5 5 0 1 1 0-2H128V37.9a5 5 0 1 1 2 0V82h-28.1zm16-64a5 5 0 1 1 0-2H146v44.1a5 5 0 1 1-2 0V18h-26.1zm102.2 270a5 5 0 1 1 0 2H98v14h-2v-16h124.1zM242 149.9V160h16v34h-16v62h48v48h-2v-46h-48v-66h16v-30h-16v-12.1a5 5 0 1 1 2 0zM53.9 18a5 5 0 1 1 0-2H64V2H48V0h18v18H53.9zm112 32a5 5 0 1 1 0-2H192V0h50v2h-48v48h-28.1zm-48-48a5 5 0 0 1-9.8-2h2.07a3 3 0 1 0 5.66 0H178v34h-18V21.9a5 5 0 1 1 2 0V32h14V2h-58.1zm0 96a5 5 0 1 1 0-2H137l32-32h39V21.9a5 5 0 1 1 2 0V66h-40.17l-32 32H117.9zm28.1 90.1a5 5 0 1 1-2 0v-76.51L175.59 80H224V21.9a5 5 0 1 1 2 0V82h-49.59L146 112.41v75.69zm16 32a5 5 0 1 1-2 0v-99.51L184.59 96H300.1a5 5 0 0 1 3.9-3.9v2.07a3 3 0 0 0 0 5.66v2.07a5 5 0 0 1-3.9-3.9H185.41L162 121.41v98.69zm-144-64a5 5 0 1 1-2 0v-3.51l48-48V48h32V0h2v50H66v55.41l-48 48v2.69zM50 53.9v43.51l-48 48V208h26.1a5 5 0 1 1 0 2H0v-65.41l48-48V53.9a5 5 0 1 1 2 0zm-16 16V89.41l-34 34v-2.82l32-32V69.9a5 5 0 1 1 2 0zM12.1 32a5 5 0 1 1 0 2H9.41L0 43.41V40.6L8.59 32h3.51zm265.8 18a5 5 0 1 1 0-2h18.69l7.41-7.41v2.82L297.41 50H277.9zm-16 160a5 5 0 1 1 0-2H288v-71.41l16-16v2.82l-14 14V210h-28.1zm-208 32a5 5 0 1 1 0-2H64v-22.59L40.59 194H21.9a5 5 0 1 1 0-2H41.41L66 216.59V242H53.9zm150.2 14a5 5 0 1 1 0 2H96v-56.6L56.6 162H37.9a5 5 0 1 1 0-2h19.5L98 200.6V256h106.1zm-150.2 2a5 5 0 1 1 0-2H80v-46.59L48.59 178H21.9a5 5 0 1 1 0-2H49.41L82 208.59V258H53.9zM34 39.8v1.61L9.41 66H0v-2h8.59L32 40.59V0h2v39.8zM2 300.1a5 5 0 0 1 3.9 3.9H3.83A3 3 0 0 0 0 302.17V256h18v48h-2v-46H2v42.1zM34 241v63h-2v-62H0v-2h34v1zM17 18H0v-2h16V0h2v18h-1zm273-2h14v2h-16V0h2v16zm-32 273v15h-2v-14h-14v14h-2v-16h18v1zM0 92.1A5.02 5.02 0 0 1 6 97a5 5 0 0 1-6 4.9v-2.07a3 3 0 1 0 0-5.66V92.1zM80 272h2v32h-2v-32zm37.9 32h-2.07a3 3 0 0 0-5.66 0h-2.07a5 5 0 0 1 9.8 0zM5.9 0A5.02 5.02 0 0 1 0 5.9V3.83A3 3 0 0 0 3.83 0H5.9zm294.2 0h2.07A3 3 0 0 0 304 3.83V5.9a5 5 0 0 1-3.9-5.9zm3.9 300.1v2.07a3 3 0 0 0-1.83 1.83h-2.07a5 5 0 0 1 3.9-3.9zM97 100a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm0-16a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm16 16a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm16 16a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm0 16a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm-48 32a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm16 16a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm32 48a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm-16 16a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm32-16a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm0-32a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm16 32a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm32 16a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm0-16a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm-16-64a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm16 0a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm16 96a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm0 16a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm16 16a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm16-144a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm0 32a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm16-32a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm16-16a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm-96 0a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm0 16a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm16-32a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm96 0a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm-16-64a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm16-16a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm-32 0a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm0-16a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm-16 0a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm-16 0a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm-16 0a3 3 0 1 0 0-6 3 3 0 0 0 0 6zM49 36a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm-32 0a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm32 16a3 3 0 1 0 0-6 3 3 0 0 0 0 6zM33 68a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm16-48a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm0 240a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm16 32a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm-16-64a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm0 16a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm-16-32a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm80-176a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm16 0a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm-16-16a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm32 48a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm16-16a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm0-32a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm112 176a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm-16 16a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm0 16a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm0 16a3 3 0 1 0 0-6 3 3 0 0 0 0 6zM17 180a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm0 16a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm0-32a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm16 0a3 3 0 1 0 0-6 3 3 0 0 0 0 6zM17 84a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm32 64a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm16-16a3 3 0 1 0 0-6 3 3 0 0 0 0 6z'%3E%3C/path%3E%3C/svg%3E");
}
</style>

<!-- CSS FOR TOOL TIP -->
<style>
	/* Default tooltip setting (also ) */
	[data-tooltip] {
		--arrow-size: 5px;
		position: relative;
		/* z-index: 10; */

		/* Disable context menu on long press on touch screen */
		-webkit-tap-highlight-color: rgba(0,0,0,0);
		-webkit-user-select: none;
		-webkit-touch-callout: none 
	}
	
	/* Positioning and visibility settings of the tooltip */
	[data-tooltip]::before,
	[data-tooltip]::after {
	  position: absolute;
	  visibility: hidden;
	  opacity: 0;
	  left: 50%;
	  bottom: calc(100% - 5px + var(--arrow-size));
	  pointer-events: none;
	  transition: 0.2s;
	  /* will-change: transform; */
	  z-index: 12;
	}
	
	/* The actual tooltip with a dynamic width */
	[data-tooltip]:before {
	  content: attr(data-tooltip);
	  padding: 10px 18px;
	  box-sizing: border-box;
	  min-width: 60px;
	  max-width: min(400px, calc(100vw - 30px) );
	  width: max-content;
	  width: -moz-max-content;
	  border-radius: 6px;
	  font-size: 14px;
	  background-color: rgba(59, 72, 80, 0.9);
	  background-image: linear-gradient(30deg,
		rgba(59, 72, 80, 0.44),
		rgba(59, 68, 75, 0.44),
		rgba(60, 82, 88, 0.44));
	  box-shadow: 0px 0px 14px rgba(0, 0, 0, 0.6);
	  color: #fff;
	  text-align: center;
	  white-space: pre-wrap;
	  font-weight: 400;
	  transform: translate(var(--data-translateX, -50%),  calc(0px - var(--arrow-size))) scale(0.5);
	}
	
	/* Tooltip arrow */
	[data-tooltip]:after {
	  content: '';
	  border-style: solid;
	  border-width: var(--arrow-size) var(--arrow-size) 0px var(--arrow-size); /* CSS triangle */
	  border-color: rgba(55, 64, 70, 0.9) transparent transparent transparent;
	  transition-duration: 0s; /* If the mouse leaves the element, 
								  the transition effects for the 
								  tooltip arrow are "turned off" */
	  transform-origin: top;   /* Orientation setting for the
								  slide-down effect */
	  transform: translateX(-50%) scaleY(0);
	}
	
	/* Tooltip becomes visible at hover */
	[data-tooltip]:hover:before,
	[data-tooltip]:hover:after {
	  visibility: visible;
	  opacity: 1;
	}
	/* Scales from 0.5 to 1 -> grow effect */
	[data-tooltip]:hover:before {
	  transition-delay: 0.3s;
	  /* transform: translate(-50%, calc(0px - var(--arrow-size))) scale(1); */
	  transform: translate(var(--data-translateX, -50%), calc(0px - var(--arrow-size))) scale(1);
	}
	/* 
	  Arrow slide down effect only on mouseenter (NOT on mouseleave)
	*/
	[data-tooltip]:hover:after {
	  transition-delay: 0.5s; /* Starting after the grow effect */
	  transition-duration: 0.2s;
	  transform: translateX(-50%) scaleY(1);
	}
	
	/* That's it for the basic tooltip, which set for TOP tooltip. Below are customization for left, right, bottom tooltips */
	
	/* LEFT */
	/* Tooltip + arrow */
	[data-tooltip-location="left"]:before,
	[data-tooltip-location="left"]:after {
	  left: auto;
	  right: calc(100% - 5px + var(--arrow-size));
	  bottom: 50%;
	}
	
	/* Tooltip */
	[data-tooltip-location="left"]:before {
	  transform: translate(calc(0px - var(--arrow-size)), 50%) scale(0.5);
	}
	[data-tooltip-location="left"]:hover:before {
	  transform: translate(calc(0px - var(--arrow-size)), var(--data-translateY, 50%)) scale(1);
	}
	
	/* Arrow */
	[data-tooltip-location="left"]:after {
	  border-width: var(--arrow-size) 0px var(--arrow-size) var(--arrow-size);
	  border-color: transparent transparent transparent rgba(55, 64, 70, 0.9);
	  transform-origin: left;
	  transform: translateY(50%) scaleX(0);
	}
	[data-tooltip-location="left"]:hover:after {
	  transform: translateY(50%) scaleX(1);
	}
	
	/* RIGHT */
	[data-tooltip-location="right"]:before,
	[data-tooltip-location="right"]:after {
	  left: calc(100% - 5px + var(--arrow-size));
	  bottom: 50%;
	}
	
	[data-tooltip-location="right"]:before {
	  transform: translate(var(--arrow-size), 50%) scale(0.5);
	}
	[data-tooltip-location="right"]:hover:before {
	  transform: translate(var(--arrow-size), var(--data-translateY, 50%)) scale(1);
	}
	
	[data-tooltip-location="right"]:after {
	  border-width: var(--arrow-size) var(--arrow-size) var(--arrow-size) 0px;
	  border-color: transparent rgba(55, 64, 70, 0.9) transparent transparent;
	  transform-origin: right;
	  transform: translateY(50%) scaleX(0);
	}
	[data-tooltip-location="right"]:hover:after {
	  transform: translateY(50%) scaleX(1);
	}
	
	/* BOTTOM */
	[data-tooltip-location="bottom"]:before,
	[data-tooltip-location="bottom"]:after {
	  top: calc(100% - 5px + var(--arrow-size));
	  bottom: auto;
	}
	
	[data-tooltip-location="bottom"]:before {
	  transform: translate(var(--data-translateX, -50%), var(--arrow-size)) scale(0.5);
	}
	[data-tooltip-location="bottom"]:hover:before {
	  /* If there is no --data-translateX, then it will be translate -50% */
	  transform: translate(var(--data-translateX, -50%), var(--arrow-size)) scale(1);
	}
	
	[data-tooltip-location="bottom"]:after {
	  border-width: 0px var(--arrow-size) var(--arrow-size) var(--arrow-size);
	  border-color: transparent transparent rgba(55, 64, 70, 0.9) transparent;
	  transform-origin: bottom;
	}

	/* Hack for chapter infor tooltip not to be clipped. Because #elmChapterInfor has class .detailContent (which contains max-height for detail/summary to expand/collapse animation), thus its has property display:block, so tooltip contained in ::before pseudo of its <code> descendant being clipped by boudingRect of #elmChapterInfor. Can change #elmChapterInfor display to 'inline' for tooltip to fully shows up, but #elmChapterInfor cannot be collapsed anymore. So, I do this hack using padding */
	div[name='divCtnTop'] > div:has(> details[name='chapterInforDetails']:not(:has([open])) + div.ap-container){ /* details collapsed */
		margin-top: 5px; /* come back to normal margin */
	}
	div[name='divCtnTop'] > div:has(> details[name='chapterInforDetails'][open]){ /* details expanded */
		& >  .detailContent{
			padding-bottom: 60px; /* make room for bottom tooltip*/
		}
		& + div.ap-container{
			margin-top: -60px; /* compensate the room of its presibling .detailContent */
		}
	}
	/* End of tooltip hack */
</style>
</head>

<body onload="init();">
<!-- PAGES WAITS FOR MAIN PAGE TO BE FULLY LOADED-->
 <div id="loadingPageWrapper">
	<div>
		<div class='loader--dot'></div>
		<div class='loader--dot'></div>
		<div class='loader--dot'></div>
		<div class='loader--dot'></div>
		<div class='loader--dot'></div>
		<div class='loader--dot'></div>
		<div class='loading-3dots--text'></div>
	</div>
</div>
<!-- HTML MODAL POPUP -->
<div class="modalPopup" id="modalSettingPopup">
	<div class="modalPopupOverlay" onclick="setting.closeSettingModal()"></div>
	<div class="modalPopupContentWrapper circus-background">
		<div class="modalHeader">
			<div class="modalTitle control-button-flex"> <!-- Title: Setting -->
				<button onclick="historyCls.wipeAll();" title="Xóa toàn bộ lịch sử thông tin trang Web đã ghi nhận" id="elmHistoryWipeAll">
					<svg class="!text-[25px] button-svg-img" focusable="false" aria-hidden="true">
					<use href="#icnSvgFullTrashBin"/>
					</svg>
				</button>
			</div>

			<!-- <button class="closeModal" onclick="setting.closeSettingModal()"></button> -->
			<div class="closeModal" onclick="setting.closeSettingModal()"></div>
		</div>

		<div class="modalPopupContent">
			<div class="flex-button-container">
				<div class="control-button-flex" style="padding-top: 2px;"><label for="selPopupBookGroup">Kiểu phân nhóm: </label><select id="selPopupBookGroup" class="dropdown-book-spinner" title="Những cách nhóm thứ tự các truyện"></select></div>

				<span class="control-button-flex">
					<input id="chkShowBookKit" type="checkbox" class="!text-[25px]" role="switch" title="Danh sách hiển thị phía dưới là Book Kit hay Book Set">
					<label for="chkShowBookKit" data-tooltip="set in openSettingModal()" data-tooltip-location="bottom" style="color: var(--select-book-group-color)">Book Set view</label>
				</span>
			</div>
			
			<div name="bookTitlesSettingWrapper">
				<div name="bookKitChkboxContainer" class="control-button-flex" style="justify-content: space-evenly;"></div>
				<ol id="lstBookTitlesSetting" class="lstBookTitlesSetting"></ol>
			</div>
			
			<div class="flex-button-container">
				<span class="control-button-flex">
					<input id="chkDisableCircleProgressButton" type="checkbox" class="!text-[30px]" checked="" role="switch" title="Ẩn/Hiện tiến trình phát hình tròn bao quanh nút Play/Pause">
					<label for="chkDisableCircleProgressButton"></label>
				</span>
				<span class="control-button-flex">
					<input id="chkHideBufferBar" type="checkbox" class="!text-[30px]" checked="" role="switch" title="Ẩn/Hiện thanh tiến trình dữ liệu audio đã được tải về máy (buffer)">
					<label for="chkHideBufferBar"></label>
				</span>
			</div>
		</div>
	</div>
</div>
<!-- end of html modal popup -->

<!-- MAIN PAGE -->
<div name="divContainer">
	<!-- Top part of the page, containing book select element and chapter title, audio element -->
	<div name="divCtnTop">
		<audio id="elmMyAudio" autoplay controls src=""></audio>
		
		<div>
			<select id="elmSelBookTitles" class="dropdown-book-spinner" title="Danh sách các truyện + MC"></select>
			<div id="elmDivMcRadioCtn"><p id="elmInnerMcFlexCtn" class="flex-button-container"></p></div>
		</div>
		
		<div>
			<details open name="chapterInforDetails">
				<summary><span id="elmChapterTitle"></span></summary>
			</details>
			<div id="elmChapterInfor" class="detailContent"></div>
		</div>
		
		<div class="ap-container">
			<div class="ap-panel">
			  <div class="ap-sub-panel ap--playback" name="divCtnAudioControlBottom">  <!-- control-button-flex -->
					<button class="ap-controls ap-reload-btn" title="Nạp lại link truyện" data-tooltip="Nạp lại link truyện" data-tooltip-location="bottom" style="--data-translateX:-15px">
						<svg class="!text-[20px] button-svg-img" focusable="false" aria-hidden="true">
							<use href="#icnSvgReload"/>
						</svg>
					</button>

					<button class="ap-controls ap-prev-btn"title="Nghe chương trước">
					<svg class="!text-[30px] rotate-180 button-svg-img" focusable="false" aria-hidden="true">
						<use href="#icnSvgSkipNext"/>
					</svg>
					</button>
					<button class="ap-controls ap-rewind-btn" onclick="xAudio.currentTime -= 10;" title="Lùi lại 10 giây">
					<svg class="!text-[20px] rotate-180 button-svg-img" focusable="false" aria-hidden="true">
						<use href="#icnSvgFastForward"/>
					</svg>
					</button>
					<button class="ap-controls ap-play-pause-btn" title="Phát/Dừng truyện">
					<svg class="!text-[40px] button-svg-img" focusable="false" aria-hidden="true">
						<use href="#icnSvgPlay" svg-icon-name="PlayPauseIcon"/>
					</svg>
					</button>
					
					<button class="ap-controls ap-fastforward-btn" onclick="xAudio.currentTime += 10;" title="Tiến lên 10 giây">
					<svg class="!text-[20px] button-svg-img" focusable="false" aria-hidden="true">
						<use href="#icnSvgFastForward"/>
					</svg>
					</button>
					<button class="ap-controls ap-next-btn" title="Nghe chương sau">
					<svg class="!text-[30px] button-svg-img" focusable="false" aria-hidden="true">
						<use href="#icnSvgSkipNext"/>
					</svg>
					</button>
			  </div>

			  <div class="ap-sub-panel ap--track">
				<div class="ap-info">
				  <div class="ap-title"></div>
				  <div class="ap-time">
					<span class="ap-time--remains">0:00 / 0:00</span>
				  </div>
				  <div class="ap-progress-container">
					<div class="ap-progress">
					  <div class="ap-progress-bar" style="width: 10%;"></div>
					  <div class="ap-progress-preload-bar" style="width: 100%;"></div>
					</div>
				  </div>
				  <!-- buffered bar -->
				  <canvas class="ap-buffer-bar"></canvas>
				</div>
			  </div>
			  <div class="ap-sub-panel ap--settings">
				
			<!-- Speed select box with increase/decrease buttons -->
			<div class="ap-controls ap-volume-container">
				<button class="ap-controls ap-volume-btn">
				  <svg class="!text-[15px] button-svg-img" focusable="false" aria-hidden="true">
					  <use href="#icnSvgVolumeOn" class="ap--volume-on"/>
					  <use href="#icnSvgVolumeOff" class="ap--volume-off"/>
				  </svg>
				</button>
				<div class="ap-volume">
				  <div class="ap-volume-progress">
					<div class="ap-volume-bar" style="height: 70px;"></div>
				  </div>
				</div>
			  </div>
			  
			  <div class="ap-controls ap-speed-container">
					<span class="ap-change-speed-buttons">
					<button class="ap-speed-decrease-speed" title="Giảm tốc độ phát">
						<svg class="!text-[15px] button-svg-img" focusable="false" aria-hidden="true">
							<use href="#icnSvgMinusSign"/>
						</svg>
					</button>
					<button class="ap-speed-increase-speed" title="Tăng tốc độ phát">
						<svg class="!text-[15px] button-svg-img" focusable="false" aria-hidden="true">
							<use href="#icnSvgPlusSign"/>
						</svg>
					</button>
					</span>
					<select class="ap-speed-option-select" title="Chọn tốc độ phát"></select>				
				</div>
				
			  </div>
			</div>
		  </div>
	</div>

	<div class="flex-container">
	<div>
		<div id="elmPlayingTime"></div>
		<div name='HourglassSpining'>
			<svg class="!text-[30px] button-svg-img animate-spin" focusable="false" aria-hidden="true" >
				<use href="#icnSvgHourGlass"/>
			</svg>
			<span class="loading-3dots--text"></span>
		</div>
	</div>

	<div name="divCtnAudioControl" class="flex-button-container">
		<div class="control-button-flex" name="divOtherControlTop">
			<!-- <button class="ap-reload-btn" title="Nạp lại link truyện" data-tooltip="Nạp lại link truyện" style="height:41px; --data-translateX: -15%">
				<svg class="!text-[20px] button-svg-img" focusable="false" aria-hidden="true">
					<use href="#icnSvgReload"/>
				</svg>
			</button> -->
			
			<div class="havingShortPopup">
				<button onclick="utilityHandles.showSeekAudioDurationPopup();" title="Chọn thời gian phát" data-tooltip="Chọn thời gian nghe">
					<svg class="!text-[25px] button-svg-img" focusable="false" aria-hidden="true">
						<use href="#icnSvgRunJumping"/>
					</svg>
				</button>
				<!-- popup to type in duration to jump to -->
				<div id="seekDurationDivPopup" class="shortPoup">
					<label for="ipAudioDuration">Nhập số thứ tự chương muốn nghe</label>
					<input id="ipAudioDuration" type="text" inputmode="text" maxlength="10" pattern="" placeholder="Nhập thời gian">
					<span class="checkInputValidity"></span>
				</div>
			</div>

			<div class="havingShortPopup">
				<button onclick='utilityHandles.showJumpChapterPopup()' title="Chọn chương" data-tooltip="Chọn chương để nghe">
					<svg class="!text-[25px] button-svg-img" focusable="false" aria-hidden="true">
						<use href="#icnSvgJumpToChapter"/>
					</svg>
				</button>
				<!-- popup to type in chapter number to play -->
				<div id="jumpChapterDivPopup" class="shortPoup">
					<label for="ipChapter2Goto">Nhập số thứ tự chương muốn nghe</label>
					<br/>
					<input id="ipChapter2Goto" type="number" inputmode="decimal" maxlength="4" min="1" max="50" pattern="\d{1,3}" placeholder="Nhập số chương">
					<span class="checkInputValidity"></span>
				</div>
			</div>
			<select id="selBookGroup" title="Đổi cách nhóm thứ tự các truyện"></select>
			
		</div>

		<!-- History buttons -->
		<div class="control-button-flex" name="divHistoryControlTop">
			<button onclick="setting.openSettingModal();" title="Setting">
				<svg class="!text-[30px] button-svg-img" focusable="false" aria-hidden="true">
				<use href="#icnSvgSetting"/>
			</svg>
			</button>
			<button onclick="historyCls.historyGo(0);" title="Lịch sử nghe: Sách ngay trước" id="elmHistoryGoBackward" data-tooltip-location="bottom">
				<svg class="!text-[30px] rotate-180 button-svg-img" focusable="false" aria-hidden="true">
				<use href="#icnSvgHistoryForward"/>
			</svg>
			</button>
			<button id="elmHistoryClear" onclick="historyCls.historyClear();" data-tooltip="Xóa toàn bộ Lịch sử nghe sách" data-tooltip-location="bottom">
				<svg class="!text-[30px] button-svg-img" focusable="false" aria-hidden="true">
					<use href="#icnSvgClearHistory"/>
				</svg>
			</button>
			<button onclick="historyCls.historyGo(1);" title="Lịch sử nghe: Sách tiếp theo" id="elmHistoryGoForward" data-tooltip-location="bottom">
				<svg class="!text-[30px] button-svg-img" focusable="false" aria-hidden="true">
					<use href="#icnSvgHistoryForward"/>
				</svg>
			</button>
		</div>

		<!-- Chapter group buttons -->
		<div class="control-button-flex" name="divChapterGroupControls">
			<button onclick="utilityHandles.gotoPlayingChapter();" title="Đến chương đang chạy" data-tooltip="Đến chương đang chạy" data-tooltip-location="bottom" >
				<svg class="!text-[20px] button-svg-img rotate-90" focusable="false" aria-hidden="true">
				<use href="#icnSvgJump2PlayingChap"/>
			</svg>
			</button>
			<span><input id="allChapGrpChkbox" type="checkbox" checked class="!text-[25px]" role="switch" title="Đóng/mở tất cả các chapter group">
			<label for="allChapGrpChkbox" data-tooltip="Đóng/mở tất cả các chapter group" data-tooltip-location="bottom">Nhóm chương</label>	
			</span>
		</div>
	</div>
	
	</div>
	
	<div name="divCtnMiddle" class="flex-container">
		<div>
			<img id="elmArtwork"/>
			<svg class="noInternetImg elm-hidden" focusable="false" aria-hidden="true">
				<use href="#svgIconNoInternetConnection"/>
			</svg>
			<div id="elmBookTotalDuration" role="containing-tooltip">
				<svg class="svg-img-infor" focusable="false" aria-hidden="true">
					<use href="#svgIconHeaphone"/>
				</svg>
				<span data-tooltip="Tổng thời gian cả cuốn sách">00:00:00</span>
				<svg class="svg-img-infor" focusable="false" aria-hidden="true">
					<use href="#svgIconListenTime"/>
				</svg>
				<span data-tooltip="Thời gian thực tế nghe cả cuốn sách với tốc độ phát hiện tại">00:00:00</span>
			</div>
			
			<!-- Big audio Play/Pause and other control button -->
			<div class="control-button-flex" style="color: #29689e;" name="divCtnAudioControlExtraBig">
				</button>
				<button onclick="xAudio.currentTime -= 10;" class="ap-rewind-btn" title="Lùi lại 10 giây">
				<svg class="!text-[50px] rotate-180 button-svg-img" focusable="false" aria-hidden="true">
					<use href="#icnSvgFastForward"/>
				</svg>
				</button>
				
				<button title="Phát/Dừng truyện">
				<svg class="!text-[80px] button-svg-img" focusable="false" aria-hidden="true">
					<use href="#icnSvgPlay" svg-icon-name="PlayPauseIcon"/>
				</svg>
				</button> <!-- icnSvgPlayProgress -->
				
				<button onclick="xAudio.currentTime += 10;" class="ap-fastforward-btn" title="Tiến lên 10 giây">
				<svg class="!text-[50px] button-svg-img" focusable="false" aria-hidden="true">
					<use href="#icnSvgFastForward"/>
				</svg>
				</button>
				
			</div>
		</div>

		<div name="elmPlaylistCtn" style="margin-top: -16px; margin-bottom: -13px;">
			<ol id="elmPlaylist" class="circus-background"></ol>
		</div>
	</div>
	<div name="divCtnBottom">
		<details >
			<summary><span id="elmBookTitle"></span></summary>
		</details>
		<div id="elmBookInfo"  class="detailContent"></div>
	</div>
</div>

<!-- Div to show toast -->
<div id="toastSnackbar">Some text some message..</div>

<script src="data.js?v=1.09"></script>

<!-- SMALL, HANDY NON-UI FUNCTIONS -->
<script>
	String.prototype.toProperCase = function () {
		return this.replace(/\w\S*/g, function(txt){return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();});
	};
	/* Simple, small, useful functions */
	/* padding some char before a text 
		n: the number of text to be padded
		width: number of char to pad
		z: char to pad
	*/
	function pad(n, width, z) {
	  z = z || '0';
	  n = n + '';
	  return String(n).padStart(width, z); // '0009'
	}
	
	//make braket that enclose something store in var m
	var  makeBrk = (m) => {return m? "["+m+"]":""};
	/* make inline svg from sprite embeded at the end of HTML
		_spriteName {string}: id of svg sprite stored in <symbol> element
		_options	{Json}, may have following attributes
			class	{string}: list of class	names
			style	{string}: inline style that customize UI of a paticular icon
			title	{string}: tooltip for current icon
	*/
	var makeSvgFromSprite = (_spriteName, _options) => {
		let _class="", _inlineStyle = "", _title="";
		if(_options){
			if(_options.class) _class = `class="${_options.class}"`;
			if(_options.style) _inlineStyle = `style="${_options.style}"`;
			//if(_options.title) _title = `title="${_options.title}"`; //for now, svg not support title, so ignore this for now
		}
		return `<svg ${_class} ${_inlineStyle} ${_title} focusable="false" aria-hidden="true">
			<use href="#${_spriteName}"/>
		</svg>`;
	}
	//extract host name from an url
	var getHostName = (url) => {if(!url) return "";
		let regRet = url.match(/(\w+)\.\w{2,}(\/|\?|$)/); return (Array.isArray(regRet) && regRet[1].toProperCase()) || "Link";};
	//change string to 
	toSentenceCase = (txt) => txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();
	//convert duration string (such as '34:09', '01:05:28' to second in number
	var toSeconds = (str) => {
		if(!str) return 0;
	   let t = str.split(':').map(n => {return isNaN(parseInt(n)) ? 0 : parseInt(n)});
	   return t.reduce((r,elem) => r *60 + elem, 0);  
	}
	//convert total number of second to duration string format: HH:mm:ss, HH will be left out if HH=0
	var toHhMmSs = (sec) => {
		if (isNaN(sec)) return "00:00";
		sec = sec << 0; //make sec to be integer
		let h = (sec / 3600) << 0; sec = sec % 3600;
		let m = (sec / 60) << 0; 
		s = sec % 60;
		return (h? h+":":"") + pad(m,2) + ":" + pad(s,2);
	}

	//get param from Url string
	function getUrlVars() {
		var vars = {};
		var parts = window.location.href.replace(/[?&]+([^=&]+)=([^&]*)/gi,    
			function(m,key,value) {
				vars[key] = value;
			});
		return vars;
	}

</script>

<!-- SMALL FUNCTION THAT EFFECT UI -->
<script>
	/* Helper prototype for any HTML element that:
		- if attr is string - which is an element's attribute (e.g 'height'), it return Element.style[{that attribute}]
		- if attr is json (e.g {'height': 100px, 'font-size':17px} ), it will set the assigned value for an attribute
	*/
	Element.prototype.css = function(attr) {
    if(typeof attr === 'string') {
      return getComputedStyle(this, '')[attr];
    }
    else if(typeof attr === 'object') {
      for(var name in attr) {
        if(this.style[name] !== undefined) {
          this.style[name] = attr[name];
        }
      }
    }
  };

	/* Prototype for Audio element to get/set attribute */
	Element.prototype.attr = function (attrName, attrVal){
		if(attrVal === undefined)
			return this.getAttribute("attr-"+attrName) || this.getAttribute(attrName);
		else{
			this.setAttribute("attr-"+attrName, attrVal);
		}
	}

	/* Set the state checked, indeterminate or unchecked for a textbox
		_chkBox {HTML element} : the checkbox to set state
		_state {interger}: 	0 : unchecked
							1 : checked
							2 : indeterminate
	*/
	function setChkboxState(_chkBox, _state){
		if(_state === 0) {
			_chkBox.indeterminate = false; //to avoid UI mess-up when browser does not know the state of checkbok
			_chkBox.checked = false;
		}
		else if(_state === 1){
			_chkBox.indeterminate = false; //to avoid UI mess-up when browser does not know the state of checkbok
			_chkBox.checked = true;
		}
		else _chkBox.indeterminate = true;
	}
	
	//each time a mp3 url is played (by change chapter or by Change Src button), we need to change the appearance of mp3 link accordingly (in case that chapter has multiple mp3 src link)
	let changePlayingMp3Style = cSrcIdx => {
		
		//format mp3 links that is played by audio element
		let elmMp3Links = document.getElementById("elmMp3Links");
		elmMp3Links.querySelectorAll("a.srcPlaying").forEach(_ => {_.classList.remove("srcPlaying")});
		let _newMp3Anchor = elmMp3Links.querySelector("li:nth-of-type("+(cSrcIdx+1)+") > a");
		_newMp3Anchor && (_newMp3Anchor.classList.add("srcPlaying"));
	}

	/* Change audio source for chapter that has multiple audio links
		_justReload {boolean} :
			TRUE: If failed, just trying audio.load() to reload audio src, skip step 3 of tryingLoadAudio()
			FALSE: if failed again after audio.load(), try other url src if there are multiple url src for this chapter
	*/
	let changeAudioSrc = (_justReload) => {
		let _currBook =	parseInt(xAudio.getAttribute("attr-Book"));
		let _currChap =	parseInt(xAudio.getAttribute("attr-Chap"));
		let chapDataUrl = xData[_currBook-1].parts[_currChap-1].url; //chapDataUrl has to be an array with at least two items, otherwise the ChangeSrc button would not show up
		
		let cSrcIdx = chapDataUrl.findIndex(t => {return decodeURI(t)== decodeURI(xAudio.src)}); //find the index of current source
		if(cSrcIdx > -1){ //if found
			cSrcIdx = (cSrcIdx + 1) % chapDataUrl.length;
			xState[xAudio.attr("book")]["urlLine"] = cSrcIdx; //update new urlLine for next chapter in this book to select mp3 source to play
			
			/* xAudio.src = chapDataUrl[cSrcIdx]; */
			audioPlayer.loadSrc(chapDataUrl[cSrcIdx], _justReload == undefined? false : _justReload ); //trying load audio src WITHOUT/WITH fail-safe to play other url line if current url line failed

			//somehow, when change src the playing speed reset to 1 (normal), we need to change it back. Since we set onratechange event of audio element to function changeSpeed(), it will set the speed back to the user chosen speed
		}

		if(cSrcIdx==-1) cSrcIdx=0;
		changePlayingMp3Style(cSrcIdx);
	}

	/* Showing Splash message */
	function showToastMsg(msg){
		if(xState.depressToastFlag){ //if the Toast not allow to show
			xState.depressToastFlag = false; //turn back the flag
			return;
		}
		let _elmSnack = document.getElementById("toastSnackbar");// Get the snackbar DIV
		_elmSnack.innerHTML = msg;
		_elmSnack.classList.toggle("showSnackbar");
		setTimeout(_ => {_elmSnack.classList.toggle("showSnackbar");}, 1800);
	}

	/* Re-calculate location of ::before pseudo which contain the tooltip 
		parentElem {HTML element}: the element that contains all the descendant element who has tooltip (has attribute data-tooltip)
		options {JSON}: might contain some property
			- container {HTMLElement}: HTML element that tooltip is not allowed to go off its edges. If missing, the default container is top-level div which contains almost all of the page div.[name="divContainer"]
			- selfElem {HTMLElement}: re-position tooltip for this selfElem itself. 
	*/
	function reposTooltips(parentElem, options) {
		
		let _container =  (options && options.container) || document.querySelector('[name="divContainer"]');
		let _containerPos = _container.getBoundingClientRect();
		/* Calculate left,right for element {_ttElem} having top/bottom tooltip */
		function calculateTooltipPos(_ttElem){
			let _ttPos = _ttElem.getBoundingClientRect();
			let _ttBeforePos = getComputedStyle(_ttElem, '::before');
			

			let _ttLocation = _ttElem.getAttribute("data-tooltip-location");
			if(["left", "right", "bottom"].indexOf(_ttLocation) === -1) _ttLocation = "top";

			if(_ttLocation == "top" || _ttLocation == "bottom"){
				/* //left, right of ::before calculted in the distance from parent
				let _ttBeforeLeft = parseFloat(_ttBeforePos.getPropertyValue("left"));
				let _ttBeforeRight = parseFloat(_ttBeforePos.getPropertyValue("right")); */

				let _ttBeforeWidth = parseFloat(_ttBeforePos.getPropertyValue("Width"));

				/* Because ::before and ::after was initially set in CSS left:50%, so before all translate, the initial left (before all translate() action) of ::before is (_ttPos.left + _ttPos.width/2) */
				let _ttBeforeInitalLeft = _ttPos.left + _ttPos.width/2;
				/* if translateX(-50%), then the right, left of ::before changes to (_ttBeforeLeft ± _ttBeforeWidth/2) */
				let _ttBeforeTX50Left = _ttBeforeInitalLeft - _ttBeforeWidth/2;
				let _ttBeforeTX50Right = _ttBeforeInitalLeft + _ttBeforeWidth/2;
				
				// check to see if tooltip goes off on left/right side of container when set 'transform: translateX(-50%)' for it. In the case of going off, calculate --data-translateX which is number of poxel need to move left (if <0) or right(if>0) from initial position (also this overides translateX(-50%)) so that tooltip is positioned inside
				if(_ttBeforeTX50Left < _containerPos.left){ //the left side of tooltip go off
					_ttElem.style.setProperty("--data-translateX", `-${_ttBeforeInitalLeft - _containerPos.left - 5}px`);
				}
				else if(_ttBeforeTX50Right > _containerPos.right) { //the right side of tooltip go off
					_ttElem.style.setProperty("--data-translateX", `-${_ttBeforeInitalLeft + _ttBeforeWidth - _containerPos.right + 5}px`);
				}
				else{ // if it already fit in, remove this style in case it was set last time page resize
					_ttElem.style.removeProperty("--data-translateX");
				}
			}
		}
		if(parentElem) 
			parentElem.querySelectorAll("[data-tooltip]").forEach(_ttElem => {
				calculateTooltipPos(_ttElem);
			})
		if(options && options.selfElem)
			calculateTooltipPos(options.selfElem);
	}

	/* Re-position tooltip for element that hard-code in the page HTML, some element adaptively created by js is not the concern here */
	function reposAllTooltips(){
		/* I. Re-postion for all hard-coded elements having tooltips */
		//adjust tooltip for buttons in extra audio controls
		reposTooltips(document.querySelector('[name="divCtnAudioControl"]'));

		//tooltip for bif total playing time
		reposTooltips(document.getElementById("elmBookTotalDuration"));

		//reposTooltips(document.querySelector('[name="divChapterGroupControls"]') );

		/*	TODO: Each time History Back/Forward buttons is click, its tooltip content changes, so might need to re-position for those button to update the changes
		*/

		/* I. Re-postion for all added-by-js elements having tooltips */
		//re-position tooltip for Book Infor svg icons
		reposTooltips(document.getElementById("elmBookInfo"));

		//re-position tooltip for Chapter Infor svg icons
		reposTooltips( document.getElementById("elmChapterInfor") )

		//re-calculate location for Book Kit/Set view checkbox in modalSetting
		//reposTooltips(document.querySelector(".modalPopupContent > :first-child"), {container: document.querySelector(".modalPopupContentWrapper") });
	}
	
</script>

<!-- ***** BIG FUNCTIONS THAT DEAL WITH BOOK DATA, GROUP/CATEGORY ***** -->
<script>
	/* Create real media links, cover image, original (outside) url,... for parts that have wildcart.
These information is not created from beginning for all books, it is only being created each time a book is open inside changeBook() function.
In future, if there is anything else can be wild-cart, this function need to be update to handle those wildcart things
*/
function generateWCLinks(bookValue){
	let bData = xData[bookValue-1]; //bData contains all information for current book
	if(!bData.wc || bData.wcDone) return; //if not wildcart specified, or already creating real links from wildcart, then do nothing
	let bParts = bData.parts;
	bData.wcDone = true; //mark that Wildcart already done
	
	//create real audio links from wildcart
	if(bData.wc.url){
		let _wc = bData.wc.url;
		for(let i=0; i<bParts.length; i++){
			//first of all, convert url to array it is not
			if( !Array.isArray(bParts[i].url) ) bParts[i].url = [bParts[i].url];
			let _chapUrls = bParts[i].url;

			for(let j=0; j<_wc.length; j++){
				let urlLine = _wc[j].urlLine;

				// Case 1: if link is null, there is no link, just remove it out of url array
				if(_chapUrls[urlLine] == null) {
					//because sometime null url is at index 0, so we need to  remove them from this later to avoid messing the array
					continue; 
				}

				//Case 2: if the link is empty string, using stt (chapter index + 1) to fill in wild-cart
				if(_chapUrls[urlLine] == "") {
					_chapUrls[urlLine] = _wc[j].wcSrc.replace(wildCartStr, pad(i+1, _wc[j].nd)); //note that chaper link most of the time start from 1 (not 0)
					continue;
				}

				//Case 3: if url is not empty, but not the full url link
				if(!_chapUrls[urlLine].match(/^https?\:\/\//)){
					// use current url to fill in the wild-cart to get full link
					_chapUrls[urlLine] = _wc[j].wcSrc.replace(wildCartStr, _chapUrls[urlLine]);
					//console.log(_chapUrls[urlLine]);
				}
				
				//Case 4: if url is full url link, do nothing
			}

			//remove null link. Because splice() function change the index of array, so we go from back to beginning
			for(let j=_wc.length-1; j>=0; j--){
				let urlLine = _wc[j].urlLine;
				if(_chapUrls[urlLine] == null) {
					//if null, meaning this chapter of this line does not have real link
					_chapUrls.splice(urlLine, 1); //remove this from array since there's no link for this line
				}
			}
		}
	}

	//create real outer original links (usually youtube) from wildcart. For youtube link, the yt ID mostly got from bParts[i].img (because most of the case, img and oUrl has the same YT Id). So, this snippet has to be put before the snipet that update the img property (right below)
	if(bData.wc.oUrl){
		let _wc2 = bData.wc.oUrl;
		for(let i=0; i<bParts.length; i++){
			let _rplcUrl = bParts[i].oUrl || bParts[i].img; //take img if there is no oUrl for replacement

			if(_rplcUrl == undefined) continue;

			//if oUrl not the full url
			if(_rplcUrl !== "" && !_rplcUrl.match(/^https?\:\/\//))
			bParts[i].oUrl = _wc2.replace(wildCartStr, _rplcUrl);
		}
	}
	
	//create real chapter cover from wildcart
	if(bData.wc.img){
		let _wc1 = bData.wc.img;
		for(let i=0; i<bParts.length; i++){
			if(bParts[i].img == undefined) continue; //no img link at all
			// if img is full link, keep it that way
			if(bParts[i].img.match(/^https?\:\/\//)) continue;

			if(bParts[i].img !="") {
				let _tmpSrc = _wc1.replace(wildCartStr, bParts[i].img);
				bParts[i].img = _tmpSrc.replace(/([^\/])+$/,"hq720.jpg"); //use high res, 16:9 thumbnail but might not always exist, so we need the error handler on cover image element which is on elmArtwork.onload()
			}
		}
	}
	
}

var BookData = function() {

	let elmBook = document.getElementById("elmSelBookTitles"); //Book titles dropdown list element
/* Prepare, collect, update all data (see each step for more detail) for page to work.
Because of storage and performance reason, some data is store separatedly (such as book group/category is stored in xBookGrp variable, but its configuration like visible/hidden, their display order is stored in xState.grpCfg) and need to gather back to some app variable for the app to work correctly
This is called one time on init() */
function prepareData(){
/* STEP A: unite (shallow copy - of course) all book information (which seperated for the easy of code management) into single variable and update some purposedly missing properties*/
	let constData = [lotrData, hpData, witcherData, tdkData, shData, gotData, budData, danbrwnData];
	let _idx = 0;
	xData = [];
	//Merge all single database (each of them is one item in constData) into big one (xData, xBookGrp) and get the start index of each of after being merged. dataSize is used to built bookKitInfor and get book kit father id for each book set in xBookGrp 
	let dataSize = [{idx: 0, name: "", eName: ""}].concat( constData.map(_CnstData => {
		// merge all definition for group book of each book kit into xBookGrp variable
		for(let i=0; i< xBookGrp.length; i++){
			xBookGrp[i].grp = xBookGrp[i].grp.concat(_CnstData.meta.bookGrp[i]);
		}
		// merge all the books information to xData variable
		xData = xData.concat(_CnstData.books);
		// return the start index and the name of current book kit in xData
		_idx += _CnstData.books.length;
		return {idx: _idx, name: _CnstData.meta.name, eName: _CnstData.meta.eName};
	}) );

	//xData = shData.concat(hpData, tdkData, lotrData, witcherData, gotData);
	//create and mark stt as the index for later reference. Note that stt is index + 1
	for (let i = 0; i<xData.length; i++) xData[i].stt=i+1;
	
/* STEP B: Lấy lại xSate lưu trong Storage từ phiên trước; This have been moved to init() */
	let resState = localStorage.getItem('xState');
	if(resState != null){
		try {
			resState = JSON.parse(resState);
		} catch (e) {}	
	}	
	if(resState) xState = resState;
/* STEP C: This step to find stt of each book and put it in the correspoding group and sub-group for each of the group way defined in const xBookGrp. 
By the same time, create bookKitInfor variable
*/

	/* Group 0 is so much different from the other two group ways, so it need to treat differently */	
	let bookGrpWay = 0; //this special categorization always at index 0
	//special array that contains books in categories, each book may actually contains some items of xData which are actually the same book, but different MC
	let _bookGrpItem = xBookGrp[bookGrpWay].grp;
	
	let bkInfor = []; //based on xBooGrp[0] to create array of book Kit information
	for (let i = 0; i<xData.length; i++){
		let _grpIds = xData[i].grp[bookGrpWay].split("$"); //in the form "SH.A1$1" or "HP.TAP7$4"
		let _specItem = _bookGrpItem.find(m => m.gId=="$"+_grpIds[1] ); //find the item of _bookGrpItem that has gId is something like $1, $4
		
		if(!_specItem.books) _specItem.books = []; //create array that will store books of this categories, e.g, $1 will store 4 novel (Tieu thuyet) A1->A4 of Sherlock Holmes

		let _bkIdx = dataSize.findIndex( (_currVar, _idx) => { return _idx==dataSize.length-1? _currVar.idx >= i : _currVar.idx <= i && dataSize[_idx+1].idx > i} ); //find index of book kit
		//create information for each Book Kit
		if(_bkIdx > -1 && !bkInfor[_bkIdx]) bkInfor[_bkIdx] = {bkIdx: _bkIdx, startIdx: dataSize[_bkIdx].idx, endIdx: dataSize[_bkIdx+1].idx - 1, label: dataSize[_bkIdx+1].name};

		if(!xBookGrp[0].hasOwnProperty("bookKit")) _specItem.bookKit = _bkIdx; //update Book Kit for current Book set. 
		
		let _bookItem = _specItem.books.find(m => m.bId == _grpIds[0]);
		if(_bookItem == undefined) { //if there is no data for this book yet?
			_bookItem = {};
			_specItem.books.push(_bookItem);
			_bookItem.bId = _grpIds[0]; //book id
			_bookItem.bName = xData[i].eTitle; //title;
			_bookItem.mc = xData[i].mc; //mc and year are extra infor to quickly build book item for elmSelBookTitles
			_bookItem.year = xData[i].year;
			_bookItem.bList = [xData[i].stt]; //list of stt of xData items that is the same book but different MC
		} 
		else {
			_bookItem.bList.push(xData[i].stt); //just add stt of this item to book List
		}
	}
	window["bookKitInfor"] = bkInfor; //done building bookKitInfor

	for(bookGrpWay = 1; bookGrpWay < xBookGrp.length; bookGrpWay++){
		//special array that contains books in categories, each book may actually contains some items of xData which are actually the same book, but different MC
		let _bookGrpItem = xBookGrp[bookGrpWay].grp;
		
		for (let i = 0; i<xData.length; i++){
			let _grpIds = xData[i].grp[bookGrpWay]; //in the form "SH.VTC-TT" or "SH.A1"
			let _specItem = _bookGrpItem.find(m => m.gId==_grpIds); //find the item of _bookGrpItem that has gId is something like "SH.VTC-TT" or "SH.A1"
			if(!_specItem.books) _specItem.books = []; //create array that will store books of this categories, e.g, $1 will store 4 novel (Tieu thuyet) A1->A4 of Sherlock Holmes

			let _bkIdx = dataSize.findIndex( (_currVar, _idx) => { return _idx==dataSize.length-1? _currVar.idx >= i : _currVar.idx <= i && dataSize[_idx+1].idx > i} ); //find index of book kit
			if(!xBookGrp[0].hasOwnProperty("bookKit")) _specItem.bookKit = _bkIdx; //update Book Kit for current Book set.		

			let _bookID = xData[i].stt;
			let _bookItem = _specItem.books.find(m => m.bId == _bookID);
			if(_bookItem == undefined) { //if there is no data for this book yet?
				_bookItem = {};
				_specItem.books.push(_bookItem);
				_bookItem.bId = _bookID; //book id
				_bookItem.bName = xData[i].title; //eTitle;
				_bookItem.mc = xData[i].mc;
				_bookItem.year = xData[i].year;
				_bookItem.bList = [_bookID]; //list of stt of xData items that is the same book but different MC
			} 
			else 
				_bookItem.bList.push(xData[i].stt); //just add stt of this item to book List
		}
	}

/* STEP D: collect all configuration like visible/hidden, their display order is stored in xState.grpCfg to xBookGrp variable */
	/* D1. create xState.grpCfg if it has not yet created*/
	if(!xState.grpCfg) xState.grpCfg = {};
	for(let i=0; i<xBookGrp.length; i++ ){
		if(xState.grpCfg[i] == undefined){
			xState.grpCfg[i] = {grpLine: i, grpWay: xBookGrp[i].grpWay, grp:[]};
			let _bookGrpItem = xBookGrp[i].grp;
			for(let j=0; j< _bookGrpItem.length; j++){	
				xState.grpCfg[i].grp.push( {gId: _bookGrpItem[j].gId, label: _bookGrpItem[j].label, bHidden: _bookGrpItem[j].bHidden? true : false} );		
			}
		}
	}

	/* D2. update xBookGrp */
	for(let i=0; i<xBookGrp.length; i++ ){
		setting.transferSetting2BookGrp(i);
	}
}


/*** NEXT 3 FUNCTIONS populateRepresentBookCate, showBookCategory, populateBooks2Radio FOR grpLine==0 (which in fact 2 level grouping "Book Set > Book > MC" ) ***/

/* Adding and grouping books titles to dropdown list for special case (case 0) where books are group in categories, each book may have different MC (e.g, Tay Du Ky, Sherlock Holmes) who will be listed into radio buttons. This will short down elmSelBookTitles alot, e.g from 30 items to 20 items
Each item of book select box is just represent for real book items in xData array, the real books lies in radios buttons of elmDivMcRadioCtn element
	- bookGrpWay: the order to put the title. For now, this function and next two function only server for bookGrpWay===0  (see xBookGrp, xSate.grpLine, xData.grp), so this parameter is missed
	- _currBook: the current playing book. There is a case that book is playing belong to group that is hidden by user (in setting class). In that case, This parameter is used to show the group and only current book (which is a bit different from user-setting) so that user has smooth experience when listning
*/
function populateRepresentBookCate(_currBook){
	let bookGrpWay = 0; //this special categorization always at index 0

	//special array that contains books in categories, each book may actually contains some items of xData which are actually the same book, but different MC
	let bookGrpLstSpec = xBookGrp[bookGrpWay].grp; 
	_currBook = parseInt(_currBook);

	elmBook.innerHTML = ""; //clear the last book dropdown list
	let gStt=1;
	for(let j=0; j<bookGrpLstSpec.length; j++){
		let bookGrpItem = bookGrpLstSpec[j];

		let hideThisGrp = bookGrpItem.bHidden;
		if(hideThisGrp){ //if user wants to hide this group 
			let _idx=-1;
			// search to find if this group contains the current playing book (having stt = _currBook)
			bookGrpItem.books.forEach(_bItem => {
				_idx = Math.max(_idx, _bItem.bList.indexOf(_currBook)) 
			});
			if(_idx === -1) continue; //stop with this group, go with next one
		}

		let optgroup = document.createElement('optgroup');
		optgroup.label = bookGrpItem.label;
		optgroup.setAttribute("attr-gId", bookGrpItem.gId);

		for (let i = 0; i<bookGrpItem.books.length; i++){
			let _book = bookGrpItem.books[i];
			
			//if user hides this group, and this book in this group not the current playing book
			if(hideThisGrp && _book.bList.indexOf(_currBook) === -1) continue;

			//create option
			let opt = document.createElement('option');
			opt.value = _book.bId;
			opt.innerHTML = `${hideThisGrp?"⚡":""} ${pad(gStt++,2)}. ${makeBrk(_book.year)} ${_book.bName}`;
			if(hideThisGrp) opt.disabled = true; //disable this option to mark it orphan
			opt.setAttribute("attr-book-array", makeBrk(_book.bList));
			opt.setAttribute("attr-gId", bookGrpItem.gId);
		
			optgroup.appendChild(opt);
		}
		elmBook.appendChild(optgroup);
		
	}

	//re-set onchange event for elmBook
	elmBook.onchange = () => {populateBooks2Radio(elmBook.value)};
}

/* Populate radio buttons corresponding each MC who read the current book, by the same time make one button checked and load the book read by that MC.
	_currentBook: the current Book value (stt)
*/
function showBookCategory(_currentBook){
	let bookGrpLstSpec = [...xBookGrp[0].grp];

	populateRepresentBookCate(_currentBook); //repopulate the elmBook, this may redundant in most of the time but it is not source-cosumming, but in some case like user change the category order or show hide category, this listbox need re-update to refect user setting.

	/* findBookSttInJSONCate: Find location of Book has stt sttBook in bookGrpLstSpec
	return: json {catIdx, catValue, sttIdx}
		- catIdx: the index of category item (that containing current book) in elmBook select box}
		catValue: like catIdx, but this is value
		_sttIdx: the index of radio button that represent for current book
	*/
	let _bLocation = (function (sttBook){ //findBookSttInJSONCate func
		sttBook = parseInt(sttBook);
		let _catIdx = 0;
		for(let i=0; i<bookGrpLstSpec.length; i++){
			let _catInfor = bookGrpLstSpec[i].books;
			for(let j=0; j<_catInfor.length;j++){
				let _sttList = _catInfor[j].bList;
				let _sttIdx = _sttList.findIndex(_stt => {return _stt == sttBook});
				if(_sttIdx > -1) //found
				return {catIdx: (_catIdx + j - 1), catValue: _catInfor[j].bId, sttIdx: _sttIdx};
			}
			_catIdx += bookGrpLstSpec.length;
		}
	})(_currentBook);

	elmBook.value = _bLocation.catValue;
	populateBooks2Radio(_bLocation.catValue, _currentBook);
}

/* populateBooks2Radio: Making radio buttons for each MC voicing a specific book for special case where xState.grpLine =0
	- catValue: value of current category value, which look like "SH.A1" 
	- bStt: the book value used to mark radio button that present current book. This param is included only on showBookCateory() function to pinpont the current book. The onchange event of elmBook will based on the bookLine to know which radio button should be checked when change the book category. 
*/
function populateBooks2Radio (catValue, bStt){
	let elmInnerMcFlexCtn = document.getElementById("elmInnerMcFlexCtn");
	
	elmInnerMcFlexCtn.innerHTML = ""; //clear radios button list
	let _sttLst = JSON.parse(elmBook.querySelector("[value='" + catValue + "']").getAttribute("attr-book-array"));
	let _innerH = "";

	if(!bStt) {
		if(xState.bookLine == undefined) xState.bookLine = 0; //default bookLine is 0
		bStt=_sttLst[xState.bookLine]; //update to use bookLine
	}

	for(let i=0; i< _sttLst.length; i++){
		_stt = _sttLst[i];
		_innerH += `<span><input type="radio" name="SpeakerMC" id="book_${_stt}" ><label for="book_${_stt}">${xData[_stt -1].mc}</label></span>`; //${_stt==bStt?"checked":""} 
	}
	elmInnerMcFlexCtn.innerHTML = _innerH;

	//show the radio container if there are more than 1 radio buttons, otherwise hide it
	document.getElementById("elmDivMcRadioCtn").style.display = _sttLst.length > 1? "block": "none";

	//set click event handler for just-added radio buttons.
	elmInnerMcFlexCtn.querySelectorAll("input[name='SpeakerMC']").forEach((elm,idx) => {
		let _stt = elm.getAttribute("id").match(/\d+/)[0]; //this is book value
		elm.onclick = _ => {
			let _currBook = xAudio.getAttribute("attr-book");
			if(_currBook && _currBook==_stt) return; //if current radio button is selected, do nothing
			//elmBook.value= _stt;
			changeBook(_stt);
			xState.bookLine=idx;
		};
	})

	let _radioButton2Select = elmInnerMcFlexCtn.querySelector(`input[id='book_${bStt}']`);
	if(!_radioButton2Select) _radioButton2Select = elmInnerMcFlexCtn.querySelector(`input[id='book_${_sttLst[0]}']`);
	_radioButton2Select.click();
};

/*** THIS FUNCTION FOR grpLine > 0 (=1 or 2) which is just one level grouping "MC > Book" or "Book > MC"
	adding and grouping books titles to dropdown list 
	bookGrpWay: the order to put the title. For now, there are two type of order, see xBookGrp, xSate.grpLine, xData.grp
***/
function addBookTitle(bookStt, bookGrpWay){
	if(bookGrpWay == 0) {return;} //this should never happen, it have been taken care of at init() and switchBookGrpWay() function, so that this function only work with bookGrpWay =1 or larger

	elmBook.innerHTML = ""; //clear the last book dropdown list
	let xGrpLbl = xBookGrp[bookGrpWay].grp, gStt=1;

	for(let j=0; j<xGrpLbl.length; j++){
		let bookGrpItem = xGrpLbl[j].books;

		let hideThisGrp = xGrpLbl[j].bHidden;
		let _idx=-1;
		if(hideThisGrp){ //if user wants to hide this group 
			// search to find if this group contains the current playing book (having stt = _currBook)
			bookGrpItem.forEach((_bItem,_idex) => {
				if(_bItem.bId == bookStt) _idx = _idex
			});
			if(_idx === -1) continue; //stop with this group, go with next one
		}
		
		let optgroup = document.createElement('optgroup');
		optgroup.label = xGrpLbl[j].label;
		
		for (let i = 0; i<bookGrpItem.length; i++){
			if(hideThisGrp && _idx != i) continue; //if user want to hide the group, and book in index i is not current book

			let bIndex = bookGrpItem[i].bId-1; //book Index in xData is book Stt - 1
			//create option
			let opt = document.createElement('option');
			opt.value = xData[bIndex].stt;
			let bookCode = Array.isArray(xData[bIndex].grp)? xData[bIndex].grp[1].split(".").pop() + ". " : "";
			if(xData[bIndex].grp[1].indexOf("SH.") > -1) //Only show MC for Sherlock Holmes
				opt.innerHTML = (hideThisGrp?"⚡":"") + pad(gStt++,2) + ". " + makeBrk(xData[bIndex].mc) + " " + makeBrk(xData[bIndex].year) + " " + xData[bIndex].title; //+ bookCode
			else{
				opt.innerHTML = (hideThisGrp?"⚡":"") + pad(gStt++,2) + ". " + makeBrk(xData[bIndex].year) + " "  + xData[bIndex].title;
				if(hideThisGrp) opt.disabled = true; //disable this option to mark it orphan
			}
		
			optgroup.appendChild(opt);
		}
		elmBook.appendChild(optgroup);
	}

	elmBook.onchange = () => {changeBook(elmBook.value)};

	elmBook.value = bookStt; //restore the last book to be selected
	changeBook(bookStt);
}

/* function to change the way to group book titles. Note that this function just change appearance of book list box, it does NOT touch to chapter and what is currently playing
	newGrpIdx: the index of group (start from 0) in xBookGrp to sort to
	if missing, it will get from config variable xState.grpLine
 */
function switchBookGrpWay(newGrpIdx){

	let _currBook = xAudio.attr("book"); //elmBook.value; //save the current book

	if(newGrpIdx == undefined ){
		newGrpIdx = xState.grpLine = selBookGroup.value; // (xState.grpLine +1) % xBookGrp.length; //for now, there are only 3 ways to group
	}
	else{
		selBookGroup.value = xState.grpLine = newGrpIdx;
	}

	showToastMsg(xBookGrp[newGrpIdx].grpWay);

	//resize selBookGroup width with the content of selected item
	var _sel = document.createElement('select');
	_sel.css({"font-size": selBookGroup.css("font-size")}); //make font size the same as the main select
	_sel.innerHTML = "<option>" + pad(newGrpIdx+1,2) + "</option>"; //&nbsp;
	document.body.appendChild(_sel);
	selBookGroup.style.width = (_sel.offsetWidth - 4) + "px";
	_sel.remove();

	//show/hide corresponding select element
	let elmDivMcRadioCtn = document.getElementById("elmDivMcRadioCtn");
	//elmBook.css({'border-color': ["darkblue", "darkred", "darkgreen"][newGrpIdx]});
	if(newGrpIdx == 0){
		elmDivMcRadioCtn.style.display = "block";
		showBookCategory(_currBook);
	}
	else{
		elmDivMcRadioCtn.style.display = "none";
		addBookTitle(_currBook, newGrpIdx);		
	}
}

/* Short function to populate Book list and select the current book for different case of category Line (grpLine) */
function goGetBook(_bookStt, _catLine){
	if(_catLine == undefined) _catLine = xState.grpLine;
	if(_catLine ==0){
		showBookCategory(_bookStt);
	}
	else {
		addBookTitle(_bookStt, _catLine);		
	}
}

//populate book group list, the select element look like a button having icon being a list with a small book at down-right corner
let selBookGroup = document.getElementById("selBookGroup");
(function populateBookGrpLst() {
	var _defGrpLabels = xBookGrp.map(_ => {return _.grpWay}); //get list of group name
	selBookGroup.innerHTML = "";// .options.length = 0; //clear the combobox
	for (let i = 0; i < _defGrpLabels.length; i++) {
		let opt = document.createElement('option');
		opt.value = i;
		opt.innerHTML = makeBrk(pad(i+1,2)) + " " +  _defGrpLabels[i]; //"&nbsp;" + 
		selBookGroup.appendChild(opt);			
	}
})();

//selBookGroup.addEventListener('change', switchBookGrpWay, true);
selBookGroup.onchange = () => {
	switchBookGrpWay();
	// Update spinner (which is a book with small mi) of elmBook to match the new color
	let oldBgrndImg = elmBook.css("background-image");
	let oldBgrndColor = oldBgrndImg.match(/fill\%3D\%22([^\%]+)\%22/); //search for fill property in background image
	if(!oldBgrndColor) return; //not found, out
	oldBgrndColor = oldBgrndColor[1]; //svg icon old color
	let bdrColor = window.getComputedStyle(document.body).getPropertyValue('--select-book-group-color'); //get border color of elmBook
	elmBook.style.backgroundImage = oldBgrndImg.replace(oldBgrndColor, bdrColor); //make svg icon has same color with border
}

//Initialize book Data, populate and assign	event handler for following listbox: elmSelBookTitles and selBookGroup. This is invoked one time in init when creating bookData obj
(function bookDataInitial(){ //populate select elements  and load the book
	prepareData(); //collect all data to xData and xBookGrp

	/* Load the most recently read book */
	let _lastBook = 0 ;
	if(typeof xState["lb"] != "undefined") _lastBook = parseInt(xState["lb"]);
	if(xState.grpLine == undefined) xState.grpLine = 0;
	let _lastCatLine = xState.grpLine;

	//populate elmSelBookTitles list, choose the book that was last playing and show all its chapter, then finally play chapter that was most-recently playing last session
	if(_lastCatLine ==0){
		showBookCategory(_lastBook);
	}
	else addBookTitle(_lastBook, _lastCatLine);

	// show category/group/ books for current group line
	selBookGroup.value = xState.grpLine;
	selBookGroup.onchange();

})(); //self-invoked function with parameter of BookDATA class constructor


/** 
 *  Public methods
 */
 return {
	switchBookGrpWay : switchBookGrpWay, //function to switch to type of book group in xBookGrp
    goGetBook: goGetBook //function to show a book by specified its stt.
  };


} //END OF BookDATA CLASS
</script>

<!-- MAIN SCRIPT HANDLING THE PAGE -->
<script>
var xData = null; // data variable contains all book data from data.js
var xAudio = document.getElementById("elmMyAudio"); //audio element
var elmPlaylist = document.getElementById("elmPlaylist"); //Chapter Playlist
var audioPlayer = null;
var bookData = null; // instance of BookData claas which deal with book and chapter Data

// IntersectionObserver object to asynchronously handle when a chapter-group-label reach and being pinned at the top edge of elmPlaylist
var playlistObserver = null;

// MutationObserver object to detect when a new element having tooltip added to page, so js can locate them properly to make it inside the page
var ttMutationObserver = null;

{
	/* Handle event when page is navigated away, the browser window is minimized, a browser tab is currently in the background, or a system element such as a task switcher obscures the page, task-switching on mobile platforms,... */
	document.addEventListener("visibilitychange", () => {
		if (document.hidden) { //or document.visibilityState=="hidden"
			saveState2Disk();
		} else {
			// Do something when the page got into user's view again
			//saveState();
			//if audio is playing, timeUpdate event will be invoked, so no need to raise it
			audioPlayer.updateTime();
		}
	});
	
	// extra event listeners for better behaviour
	/* document.addEventListener('blur' và 'focus', (event) => {
		saveState2Disk();
	}, false); */
	window.addEventListener('focus', (event) => {
		saveState2Disk();
	}, false);
	window.addEventListener('blur', (event) => {
		saveState2Disk();
	}, false);

	/* Loading page:waiting for main page to be fully loaded */
	document.onreadystatechange = function () {
		if (document.readyState === "complete") document.querySelector("#loadingPageWrapper").remove();
		return;

		/* if (document.readyState !== "complete") {
			document.querySelector("body").style.visibility = "hidden";
			document.querySelector("#loadingPageWrapper").style.visibility = "visible";
		} else {
			document.querySelector("#loadingPageWrapper").style.display = "none";
			document.querySelector("body").style.visibility = "visible";
		} */
	};
	
	window.addEventListener('resize', function(event) {
		//re-position for pre-code elements
		reposAllTooltips();

		/*	TODO: reload the book so the chapter-group-label got its height recalculted */
	}, true);
	
}
function webAPIinit(){
	// initialize playlistObserver to watch for chapter-group-label to pinned at top. For this to work, the label style need to set 'top:-0.1px' (top need less than 0 so when scroll to top, the label got hidden a bit)
	playlistObserver = new IntersectionObserver( (entries, observer) => {
		//can do entries.forEach() to go thorugh all target, but it is not necessary because except fisrt time
		let entry = entries[0]; 
		// condition 'entry.boundingClientRect.top <= entry.rootBounds.top' only catch the case label enter the top. 
		//because elmPlaylist scroll so labels' position changes, I don't know how to deal with, so I do a emotionally hack, the next (after OR operator) is even if label is completely in elmPlaylist, buts its very close to top of elmPlaylist (no more than 1.5px), then consider it as pinned
		entry.target.classList.toggle("stickyPinned", (entry.intersectionRatio < 1 && entry.boundingClientRect.top <= entry.rootBounds.top) || (entry.intersectionRatio == 1 && entry.boundingClientRect.top <= entry.rootBounds.top + 1.5));
		console.log("IntersectionObserver: " + entry.target.getAttribute("for") + ". " + entry.intersectionRatio );

		/* let _targetlId = entry.target.getAttribute("for"); //or any attribute to identify {target}
		if(entry.isIntersecting){ //from lowerer {entry.intersectionRatio} go through {threshold} to higher one, meaning the {target} just got fully appeared inside the {root}
			//the following code might work only at the case that height of {root} is at least 10% higher than height of {target}.
			if ( (entry.boundingClientRect.top - entry.rootBounds.top)/entry.boundingClientRect.height < 0.05) //if {target} top just go down less than 5% of its height
				console.log(_targetlId + ": leave the top [scroll down]");
			else if ((entry.rootBounds.bottom - entry.boundingClientRect.bottom)/entry.boundingClientRect.height < 0.05) //if {target} bottom just go up less than 5% of its height
				console.log(_targetlId + ": leave the bottom  [scroll up]");
		}
		else //from higher {entry.intersectionRatio} go through {threshold} to lower one, meaning the {target} just got partly hidden by the {root}
		{
			if(entry.boundingClientRect.top <= entry.rootBounds.top) 
				console.log(_targetlId + ": enter the top  [scroll up]");
			else if(entry.boundingClientRect.bottom >= entry.rootBounds.bottom) 
				console.log(_targetlId + ": enter the bottom  [scroll down]");
		} */
		
	}, 
	// rootMargin seems has no effect. If we want handle for last label in&out bottom of {root}, change 'threshold: [0.9, 1]'
	{ threshold: [1], root: elmPlaylist, rootMargin: "0px 0px -5px 0px" } 
	);

	//initiate Tooltip MutationObserver for adjsuting tooltip location
	ttMutationObserver = new MutationObserver( (mutationList, observer) => {
		for (const mutation of mutationList) {
			if (mutation.type === "childList") {
				//console.log(mutation);
				for (const addedNode of mutation.addedNodes) {
					//console.log(addedNode);
					if(addedNode instanceof HTMLElement && addedNode.getAttribute("role") === "containing-tooltip"){
						reposTooltips(addedNode);
						observer.disconnect(); //job done, unhook the watching element
					}
				}
			} 
			else if (mutation.type === "attributes") {
				//console.log(`The ${mutation.attributeName} attribute was modified.`);
				// console.log(mutation);
				const target = mutation.target;
				// div[name="divOtherControlTop"] which contains checkbox to expand/collapse all chapter-group and check if it is shown (its class .elm-hidden has been removed)
				if(target.getAttribute("name") == "divChapterGroupControls" && !target.classList.contains("elm-hidden"))
					reposTooltips(target);

				// for #elmHistoryGoBackward and #elmHistoryGoForward buttons when thier tooltip content changes
				if(target.hasAttribute("data-tooltip")){
					console.log(target);
					reposTooltips(null, {selfElem: target});
				}
				observer.disconnect(); //job done, unhook the watching element
			}
		}
	});

	/* div[name="divContainer"] has changed its sizes 3 times when page load.
		- 1st time: temp width, temp height
		- 2nd time: stable width, temp height
		- 3nd time: stable width, stable height
	So, we utilize ResizeObserver to watch for the last time size-changed to update tooltip location */
	let _resizeCount = 0;
	let _mainContentContainer = document.querySelector('[name="divContainer"]');
	let resizeObserver = new ResizeObserver( (entries, observer) => {
		/* for (let entry of entries) {
			console.log(entry);
		} */
		_resizeCount++;
		if(_resizeCount == 3){
			reposAllTooltips();
			observer.unobserve(_mainContentContainer); //unhook
			observer = null; //remove ResizeObserver object
		}
	});
	resizeObserver.observe(_mainContentContainer);

}
function init(){
	webAPIinit();

	//initial AudioPlayer object to take care of audio playing and corresponding UI
	let _spd = localStorage.getItem('speed'); 
	_spd = !isNaN(parseFloat(_spd))? parseFloat(_spd) : 1.4; //my default speed
	audioPlayer = AudioPlayer({speed: _spd}); //object for audio player

	//initialize book data, state data (xState) saved in localStorage and load most recently playing book + chapter of last session
	bookData = BookData(); 

	/*  - fail-safe when high-res youtube image not available
		- align the height of elmPlaylist with the cover image on the left if it is too long
	*/
	document.getElementById("elmArtwork").onload = (_event) => {
		let elmArtwork = _event.target;
		// when a youtube thumbnail not exist, youtube will return a fallback image whose size is 120x90 so onerror event on elmArtwork will never be fired. This small trick is a way to know that an thumbnail not exist, so we replace another existed one.
		if(elmArtwork.naturalWidth === 120){
			elmArtwork.src = elmArtwork.src.replace(/([^\/])+$/,"hqdefault.jpg"); //can use mqdefault.jpg with lower resolution but it is 16:9 thumbnail. Both of this thumbnail is guranteed to be existed

			return;
		}

		//align the height of elmPlaylist with the cover image on the left if it is too long
		let _leftSideHeight = 0;
		for(let _elm of elmArtwork.parentElement.children) {
			if ( _elm.tagName === 'svg' ) 
				//note that no-wifi svg does not have offsetHeight
				_leftSideHeight += _elm.getBoundingClientRect().height
			else
				_leftSideHeight += _elm.offsetHeight; 
		}
		elmPlaylist.style["max-height"] = Math.max(_leftSideHeight, 450) + "px";
	}

	/* Handle event for allChapGrpChkbox, so if it is changed, all chapters group collapse/expand accordingly */
	document.getElementById("allChapGrpChkbox").onclick = evt =>{
		let _chkExpandChapterGrp = evt.target;
		let _allChapChkbox = elmPlaylist.querySelectorAll("input[id^='chapGrpChkbox']");
		let _isChecked = _chkExpandChapterGrp.checked;
		_allChapChkbox.forEach(_chkBox => {
			_chkBox.checked = _isChecked;
			utilityHandles.chapGrpChkboxClick(_chkBox); // to save checkbox state into xState
		});

		//scroll elmPlaylist
		if(_isChecked)
			//wait 500 second for expand/collapse animation to finish, then scroll to chapter being played
			setTimeout(_ => { elmPlaylist.querySelector("li.beingPlay").scrollIntoView({behavior: 'smooth', block: 'center', inline: 'end'}); }, 500);
		else{
			//scroll to top, so sticky label not overlap each others
			elmPlaylist.scrollTo({ top: 0, left: 0, behavior: "smooth" });		
			//because scroll too fast, so IntersectionObserver object might not catch some lables being pinned at top of elmPlaylist, thanks to scrollTo, they are now moved down but still keep .stickyPinned class. So, we might need to go through all label and remove .stickyPinned from all label that below elmPlaylist top
			let _parentTop = elmPlaylist.offsetTop;
			let _allChapGrpLabel = elmPlaylist.querySelectorAll("input[type='checkbox'] + label.is-sticky");
			for(let i=0; i< _allChapGrpLabel.length; i++) utilityHandles.chapGrpChkboxClick(_allChapGrpLabel[i], i != _allChapGrpLabel.length-1);
			
		}
		//update checkbox label tooltip
		_chkExpandChapterGrp.nextElementSibling.setAttribute("data-tooltip", `Đóng/mở tất cả các chapter group\n` + `Tất cả các ${_allChapChkbox.length} nhóm chương đang ${_chkExpandChapterGrp.checked?"mở":"đóng"}` );
	}
	
	//adjust tooltip for elements created in HTML
	//reposAllTooltips();
}

/* user changes to other books
	bookValue: value of seleted item of elmSelBookTitles, not selected index in the elmSelBookTitles element, which in fact is stt of book in xData
 */
function changeBook(bookValue) {
	bookValue = parseInt(bookValue);

	//if still the same book, then do nothing. This happens sometimes, for exmple when close the User-Setting windows, Page will updates all the setting changes, and finally re-load book+chapter
	if(xAudio.getAttribute("attr-Book") == bookValue) return;
	
	// observe the _elmChapterInfor element, so when its newly added children and desendant rendered, adjust tooltips position
	ttMutationObserver.observe(document.getElementById("elmBookInfo"), {childList: true, subtree: true});
	// obsever if div[name="divOtherControlTop"] which contains checkbox to expand/collapse all chapter-group be show-up or hidden
	ttMutationObserver.observe( document.querySelector('[name="divChapterGroupControls"]'), {attributes: true, attributeFilter: ["class"]});
	
	historyCls.addToHistory(bookValue); //add new book to History if it was not hostory back/forward
	
	//update state
	xState["lb"] = bookValue;
	//if not yet available, make a new JSON for this book
	if(typeof xState[bookValue] == "undefined") xState[bookValue] ={"urlLine":0}; //urlLine remember the url link index should be played for all chapter this book if each chapter has multiple mp3 links
	
	let bData = xData[bookValue-1]; //bData contains all information for current book

	// Create real media links, cover image, original (outside) url,... for parts that have wildcart
	generateWCLinks(bookValue);
	
	let strOrgLink = "<div style='margin-left: 10px;'>Nguồn: <ul class='inlineList'>";	
	if(Array.isArray(bData.ssrc)){
		let i=1;
		bData.ssrc.forEach(s => {strOrgLink += "<li><a target='_blank' href='" + s + "'>" + (getHostName(s)) + "</a></li>"});
	}
	else
		strOrgLink += `<li><a target='_blank' href='${bData.ssrc}'>${getHostName(bData.ssrc)}</a></li>`; //
	strOrgLink += "</ul></div>";	
	
	let totalDuration = 0;
	for (let i = 1; i<=bData.parts.length; i++){totalDuration += toSeconds(bData.parts[i-1].dur);}
	
	let _elmBookTotalDuration = document.getElementById("elmBookTotalDuration");
	elmBookTotalDuration.setAttribute("attr-duration",totalDuration);
	elmBookTotalDuration.querySelector("span:first-of-type").innerHTML = toHhMmSs(totalDuration);
	elmBookTotalDuration.querySelector("span:last-of-type").innerHTML = toHhMmSs(totalDuration/xAudio.playbackRate);
	
	
	/* Update book infor to detail elem at the bottom of page */
	document.getElementById("elmBookTitle").innerHTML = bData.title + (bData.eTitle && bData.eTitle != bData.title? " ("+bData.eTitle+")":"");
	/* 
	_type:
	inforType 0:STT 1:Số chương 2:Tác giả 3:Năm xuất bản 4: Thể loại 5:MC 6:Thời gian còn lại của sách 7: Thời gian nghe còn lại thực tế của sách
	*/	
	let makeSvgStr = _type  => {
		let _iconTitle = ["Stt", "Số chương", "Tác giả", "Năm xuất bản", "Thể loại", "Người đọc", "Thời gian còn lại của sách", "Thời gian nghe còn lại thực tế của sách (theo tốc độ phát)"]; 
		let _iconNames = ["svgIconFeather", "svgIconBookNumber", "svgIconMaleAuthor", "svgIconCalendar","svgIconBookType", "icnSvgMicrophone", "svgIconRemainTime", "svgIconListenTime"];
		let _inlineStyle="";
		if(_type == 7) _inlineStyle="width: 1.3em;height: 1.3em;margin-bottom: -5px;";
		return `<code style="display: inline-block" data-tooltip="${_iconTitle[_type]}" data-tooltip-location="bottom" >${makeSvgFromSprite(_iconNames[_type], {class: "svg-img-infor", style: _inlineStyle, title: _iconTitle[_type] })}</code>`; //
	}
	document.getElementById("elmBookInfo").innerHTML = `${strOrgLink}<div role="containing-tooltip"><ul class='inlineListInfor' style='padding-inline-start: 0px;'>
		<li>${makeSvgStr(0)}<span>${bData.stt}</span></li>
		<li>${makeSvgStr(1)}<span>${bData.parts.length} chương.</span></li>
		<li attr-duration="${totalDuration}">${makeSvgStr(6)}<span>${toHhMmSs(totalDuration)}</span> ${makeSvgStr(7)}<span role="listeningTime">${toHhMmSs(totalDuration/xAudio.playbackRate)}</span></li>
		<li>${makeSvgStr(2)}<span>${bData.author}</span></li>`
		+ (bData.year?`<li>${makeSvgStr(3)}<span>${bData.year}</span></li>`:"")
		+ `<li>${makeSvgStr(4)}<span>${bData.type}</span></li>
		<li>${makeSvgStr(5)}<span}>${bData.mc}</span></li>
	</ul><p id="elmBookGioithieu" class="bookChapIntro">${bData.intro}</p></div>`;

	/* Create the Playlist which includes books' chapters */
	let _makeLiItem = (i) => {
			let _track = document.createElement('li');
			_track.innerHTML = "<code>" + makeBrk(bData.parts[i-1].dur) + "</code> <span>" + bData.parts[i-1].tit + "</span>";
			_track.setAttribute("attr-stt", i);
			_track.onclick = _ => {changeChap(i);};

			return _track;
		}
	/* UI: Right align all duration string store in <code> element for all <li> chapters inside a _container (which can be a section or all book if book does not have sections) */	
	let _rightAlignDuration = _container =>{
		let _durMaxWidth = 0;
		_container.querySelectorAll("li > code").forEach(elm => {_durMaxWidth = Math.max(_durMaxWidth, elm.offsetWidth)});
		_container.querySelectorAll("li > code").forEach(elm => {elm.style.width = _durMaxWidth + "px"});
	}

	elmPlaylist.innerHTML = ""; //clear the Playlist
	if(bData.tap){	//Neu sach co nhieu tap
		let _divChapterGroupControls = document.querySelector('[name="divChapterGroupControls"]');
		_divChapterGroupControls.classList.remove("elm-hidden"); //show control buttons for chapter groups
		//reposTooltips(_divChapterGroupControls); // need to re-pos tooltip for elems that just show up

		let _bookxState = xState[bookValue];
		if(!_bookxState.chapGrpCollapse) _bookxState.chapGrpCollapse = []; //initialize chapGrpCollapse array for this book if it is not existed
		
		let j=0, liGroup = null, _maxLabelHeight = 0;
		for (let i = 1; i<=bData.parts.length; i++){
			if(bData.tap[j].f == i){//start new group
				let _chapGrpChkbox = document.createElement('input');
				_chapGrpChkbox.type = "checkbox";
				_chapGrpChkbox.checked = _bookxState.chapGrpCollapse.indexOf(j) > -1? false : true; //last time this group is collapsed or expanded
				_chapGrpChkbox.id = "chapGrpChkbox_" + j;
				_chapGrpChkbox.setAttribute("attr-grpNo", j);
				_chapGrpChkbox.onclick = evt => {utilityHandles.chapGrpChkboxClick(evt.target)};

				//Make label for group of chapters
				let _chapCount = bData.tap[j].t - bData.tap[j].f + 1;
				let _lbl = document.createElement('label');
				_lbl.htmlFor = "chapGrpChkbox_" + j;
				_lbl.innerHTML = `<span style="display:block"><code class="underlineAnim">${bData.tap[j].label} [${_chapCount}]</code></span>`;
				_lbl.classList.add("is-sticky");
				elmPlaylist.appendChild(_chapGrpChkbox);
				elmPlaylist.appendChild(_lbl);

				_maxLabelHeight = Math.max(_maxLabelHeight, _lbl.getBoundingClientRect().height); //find biggest height of all group labels
				liGroup = document.createElement('section');
			}
			
			//Add li item to playlist
			liGroup.appendChild(_makeLiItem(i));
			
			if(bData.tap[j].t == i){//end of current option group
				if(j<bData.tap.length-1 && bData.tap[j].t != bData.tap[j+1].f - 1){
					//Create dummy group for items that not belong to any group
					let _lbl = document.createElement('label');
					_lbl.innerHTML = "Orphan chapters";
					elmPlaylist.appendChild(_lbl);
				}
				elmPlaylist.appendChild(liGroup);
				_rightAlignDuration(liGroup); //right align duration of all chapter in this section
				j++; //prepare for new option group
			}
		}

		//ttMutationObserver.observe(document.querySelector('label[for="allChapGrpChkbox"]'), {attributes: true, attributeFilter: ["data-tooltip"]});
		utilityHandles.updateAllChapGrpChkboxUI(); //update allChapGrpChkbox UI when all done

		/* make all group label same height so that when scroll up/down, the down sticky label would stay fit above the up group label*/
		let _chapGroupLabels = elmPlaylist.querySelectorAll("input[type='checkbox'] + label");
		_chapGroupLabels.forEach(_lbl => {
			let _marginTB = parseFloat(_lbl.css("padding-top")) + (_maxLabelHeight - _lbl.getBoundingClientRect().height) / 2;
			//_lbl.style.paddingTop = _lbl.style.paddingBottom = _marginTB + "px";
			_lbl.style.height = _maxLabelHeight + "px";
		});
		
		// stops watching all of old target elements, empty array of IntersectionObserverEntry (if any) for visibility changes.
		playlistObserver.disconnect(); 
		// observe new chapter-group-labels
		_chapGroupLabels.forEach(_lbl => { playlistObserver.observe(_lbl) });
	}
	else {// cho sach chi co 1 tap
		document.querySelector('[name="divChapterGroupControls"]').classList.add("elm-hidden"); //hide controls for chapter group
		for (let i = 1; i<=bData.parts.length; i++){
			elmPlaylist.appendChild(_makeLiItem(i));
		}
		_rightAlignDuration(elmPlaylist);//right align duration of all chapters
	}
	
	elmPlaylist.setAttribute("attr-Length", bData.parts.length); //save the number of li children

	// Tìm xem chương mở gần đây nhất của cuốn sách
	let lastChap = 1;
	if(typeof xState[bookValue]["lc"] != "undefined") lastChap = parseInt(xState[bookValue]["lc"]);
	xAudio.attr("Book", bookValue); //save book stt to xAudio attribute
	changeChap(lastChap);

}

/* Function to take care of playing other chapter including preparing information for new chapter, load new source for audio,...
newChap: stt of new chapter, can be text or number
*/
function changeChap(newChap) {
	//first, remember the last position that audio was played
	saveLastPosition();

	let bData = xData[parseInt(xAudio.getAttribute("attr-Book"))-1]; //bData contains all information for current book

	//Check the validity of variable newChap
	if(newChap == undefined) return;
	newChap = parseInt(newChap);
	if(isNaN(newChap)) return;

	let chapLength = parseInt(elmPlaylist.getAttribute("attr-Length"));
	if(isNaN(chapLength)) chapLength = elmPlaylist.querySelectorAll("li").length;

	//if play the chapter that is currently playing, do nothing
	let _liNewChap = elmPlaylist.querySelector(`li[attr-stt="${newChap}"]`);
	if(_liNewChap && _liNewChap.className.indexOf("beingPlay") > -1 ) return; //if item stt newChap having beingPlay class, meaning newChap is playing
	if(newChap < 1 || newChap > chapLength) {
		showToastMsg("Không tìm thấy chương truyện có số thứ tự " + newChap);
		return;
	}

	//change selected appearance in Playlist
	let _lastTrack = elmPlaylist.querySelector("li.beingPlay");
	_lastTrack && _lastTrack.classList.remove("beingPlay");
	_liNewChap.classList.add("beingPlay");
	utilityHandles.gotoPlayingChapter(); //open section if it is currently collapsed and scroll into playing chapter

	(function(){ //to enable/disable the preivous/next chapter button depending on the location of chapter to be the first or the last one
		/* _elmSkipPrev = document.querySelector(".ap-prev-btn");
		if(newChap == 1) _elmSkipPrev.classList.add("elm-disabled")
		else _elmSkipPrev.classList.remove("elm-disabled"); */

		_elmSkipNext = document.querySelector(".ap-next-btn");
		if(newChap == chapLength) _elmSkipNext.classList.add("elm-disabled")
		else _elmSkipNext.classList.remove("elm-disabled");
	})();

	//check done, save newChap attribute to element
	elmPlaylist.setAttribute("attr-Value", newChap); //remember stt of current played 

	let elmChapterTitle = document.getElementById("elmChapterTitle");
	let chapData = bData.parts[newChap-1]; //information for new selected chapter of current book
	
	document.querySelector(".ap-title").innerHTML = chapData.tit; //small track title right above progress bar
	elmChapterTitle.innerHTML = "<span style='color:darkblue;font-size:1em'>" + pad(newChap,2) + "/" + pad(bData.parts.length,2) + ".</span> " + chapData.tit.replaceAll(" - ", "<br/>");

	let tit = elmChapterTitle.innerText;
	/* inforType 0:🎧 1:🕓 2:📆 3:🎤 4: cId
		5: tooltip for Media 6: tooltip for switch mp3 links button
	*/	
	let makeSvgStr = (_type, _tooltip) => {
		let _iconTitle = ["Thời lượng", "Thời gian nghe thực tế", "Năm xuất bản","Người đọc", "Id của chương truyện", "Link trực tiếp chương truyện", "Đổi nghe link tiếp theo"]; 
		let _iconNames = ["svgIconHeaphone", "svgIconListenTime", "svgIconCalendar", "icnSvgMicrophone", "svgIconFeather", "icnSvgChapterLinks", ""];
		let _inlineStyle="";
		if(_type == 1) _inlineStyle="width: 1.5em;height: 1.5em;margin-bottom: -7px;";
		if(!_iconNames[_type]) return ` data-tooltip="${_iconTitle[_type]}" data-tooltip-location="bottom"` // style="--data-translateX: -20%"
		else
		return `<code data-tooltip="${_iconTitle[_type]}" data-tooltip-location="bottom">${makeSvgFromSprite(_iconNames[_type], {class: "svg-img-infor", style: _inlineStyle, title: _iconTitle[_type] })}</code>`;
	}	
	//Adding infor for the chapter
	let strBookInfo="";
	strBookInfo += `${chapData.eTit? "Tên gốc: <i>" + chapData.eTit + "</i><br>":""}`;
	strBookInfo += `<span role='containing-tooltip'><ul class='inlineListInfor'>
		${chapData.dur? "<li attr-duration='" + toSeconds(chapData.dur) + "' title='Thời gian'>"+makeSvgStr(0)+"<span>" + chapData.dur + "</span> "+ makeSvgStr(1) + "<span role='listeningTime'>" + toHhMmSs(toSeconds(chapData.dur)/xAudio.playbackRate) + "</span></li>":""} 
		${chapData.year || bData.year? "<li title='Năm xuất bản'>"+makeSvgStr(2)+"<span>" + (chapData.year || bData.year) + "</span></li>":""} 
		${bData.mc? "<li title='Người đọc'>"+makeSvgStr(3)+"<span>" + bData.mc + "</span></li>":""} 
		${(chapData.cId)? "<li>"+makeSvgStr(4)+"<span>" + chapData.cId + "</span></li>":""}`; //!bData.grp[2].split(".").pop().match(/[A-F]/) && 

	//set direct Link for audio
	let strLink = "<li title='Link trực tiếp tới file media'><span  id='elmMp3Links'>"+makeSvgStr(5)+"Media: ";
	if(!Array.isArray(chapData.url)){
		chapData.url = [chapData.url]; //if not array, convert to array for simpler code below
	}
	//if having multiple audio sources, list all of them and show Switch src button
	if(chapData.url.length>1)
		strLink += "<button class='svgButton switchChapterAudioSrc' style='padding: 1px 5px 0px 5px;transform: translateY(2px);' onclick='changeAudioSrc(false);' title='Đổi nghe link media tiếp theo'"+makeSvgStr(6)+"><svg class='button-svg-img' style='font-size:15px' focusable='false' aria-hidden='true'><use href='#icnSvgSwitchChapterLinks'/></svg></button>&nbsp;";

	//add audio url for playing
	strLink += "<ul class='inlineList'>";
	for(let i=1;i<=chapData.url.length;i++) 
		if(chapData.url[i-1]) //in case url is empty or null or even undefined
			strLink+= "<li><a target='_blank' href='" + chapData.url[i-1] + "'>" + getHostName(chapData.url[i-1]) +"</a></li>";
	
	//adding outside url (reference url, cannot be used as audio src)
	strLink += (chapData.oUrl? "<li><a class='outsideLink' target='_blank' href='" + chapData.oUrl + "'>" + getHostName(chapData.oUrl) + "</a></li>" : "");
	strLink += "</ul><span></li>"; //closing tags
	
	let _chapInfor = "";
	if(chapData.infor)
	_chapInfor = ` ∴ <details ${window.chapInforDetailsOpen?"open":""} ontoggle="window.chapInforDetailsOpen = this.open;" style="display: inline-block;margin-bottom: -5px;"><summary style="padding-top: 0px;cursor:pointer;">${makeSvgFromSprite("svgIconChapterInfor", {class: "svg-img-infor", style: ""})}</summary></details><div class="detailContent"><p class="bookChapIntro" style="font-size: .8em;">${chapData.infor}</p></div>`;

	let _elmChapterInfor = document.getElementById("elmChapterInfor");
	// observe the _elmChapterInfor element, so when its newly added children and desendant rendered, adjust tooltips position
	ttMutationObserver.observe(_elmChapterInfor, {childList: true, subtree: true});
	//Show chapter information on the page	
	_elmChapterInfor.innerHTML = strBookInfo + strLink + "</ul></span>" + _chapInfor;

	//update chapter/book cover
	let elmArtwork = document.getElementById("elmArtwork");
	elmArtwork.title = tit;
	if(chapData.img){ //if there is a chapter cover
		//update Chapter cover if there any
		elmArtwork.src = chapData.img;
		elmArtwork.style.width="450px";
	}
	else {
		elmArtwork.src = bData.cover;
		elmArtwork.style.width="300px";
	}

	//show cover img or sprite svg image of No Internet depending on state of internet connection
	document.getElementById("elmArtwork").classList.toggle("elm-hidden", !navigator.onLine);
	document.querySelector(".noInternetImg").classList.toggle("elm-hidden", navigator.onLine);
	
	// update total remaining duration, note that this is displayed in book Infor
	let remainDuration = 0;
	for (let i = newChap; i<=bData.parts.length; i++){remainDuration += toSeconds(bData.parts[i-1].dur);}
	let _totalRemainDurElem = document.getElementById("elmBookInfo").querySelector("[attr-duration]");
	_totalRemainDurElem.setAttribute("attr-duration",remainDuration);
	_totalRemainDurElem.querySelector("span:first-of-type").innerText = `${toHhMmSs(remainDuration)} (${bData.parts.length-newChap + 1} chương)`; //first span is total duration
	_totalRemainDurElem.querySelector("span:last-of-type").innerText = toHhMmSs(remainDuration/xAudio.playbackRate); //last span is real listenning time

	// update audio source and playing new chapter
	let _bookValue = parseInt(xAudio.getAttribute("attr-Book"));
	let aSrc = ""; //audio source
	if(Array.isArray(chapData.url)){
		let uLine = parseInt( xState[_bookValue]["urlLine"]); //the index of item in chapData.url that should be played
		if(isNaN(uLine)) {uLine = 0; xState[_bookValue]["urlLine"]=0}
		if(chapData.url.length <= uLine) uLine = 0;
		aSrc = chapData.url[uLine];
		changePlayingMp3Style(uLine); //change the look of direct mp3 link that is being played
	} else {
		aSrc = chapData.url;
		changePlayingMp3Style(0);
	}

	/* xAudio.src = aSrc; //mp3 link to be played
	audioPlayer.playAudio(); */
	audioPlayer.loadSrc(aSrc, false); //trying load audio src with fail-safe to play other url line if current url line failed

	xAudio.title = tit;
	//remember the current Book and current Chapter for later use when needed
	xAudio.setAttribute("attr-Chap", newChap);
	document.title = tit;
	
	// Lưu chương mở gần đây nhất của cuốn sách
	xState[_bookValue]["lc"] = newChap;
	
	//Lưu xSate vào local Storage
	localStorage.setItem('xState', JSON.stringify(xState));
	
	//Jump to last audio played position
	(function lastPosition() {
		let _bookValue = xAudio.getAttribute("attr-Book");
		let bSt = xState[_bookValue];
		if(!bSt) return;
		let cSt = parseFloat(bSt[parseInt(elmPlaylist.getAttribute("attr-Value"))]);
		if(!isNaN(cSt)) xAudio.currentTime = cSt;
	})();
}

//function to save position of current (of most recently, depend on cases) playing audio
let saveLastPosition = _ => {
	//get last book + chapter that was played
	let _lB = xAudio.getAttribute("attr-book"); 
	let _lC = xAudio.getAttribute("attr-chap"); 
	if(_lB && _lC){ //note that, when the site initially loaded, this should be null
		let currTime = xAudio.currentTime << 0; //get the integer
		if(currTime + 5 > xAudio.duration) {
			//if playing very close to end of video, then make it play from beginning next time
			delete xState[_lB][_lC];
		}
		else //save the position 
			xState[_lB][_lC] = currTime;
	}
}

// Save and recorded state to Local Disk
function saveState2Disk(){
	saveLastPosition();
	//Lưu xSate vào Local Storage
	localStorage.setItem('xState', JSON.stringify(xState));
}

</script>

<!-- SMALL CLASSES -->
<script>
/* Class contains handler for utility buttons and some other task. I wrap it in a class for easier to track source code */
class utilityHandles{
	/* Handle small popup for Jump to a chapter button */
	static showJumpChapterPopup(){
		let _popupDiv = document.getElementById("jumpChapterDivPopup");
		let _ipChapter2Goto = document.getElementById("ipChapter2Goto");
		
		_ipChapter2Goto.setAttribute("max", elmPlaylist.getAttribute("attr-length")); //bData.parts.length
		_popupDiv.querySelector("label[for]").innerHTML = "Nhập số thứ tự chương muốn nghe<br/>(Từ <b>1</b> đến <b>" + elmPlaylist.getAttribute("attr-length") + "</b>)";
		_ipChapter2Goto.value = ""; //elmPlaylist.getAttribute("attr-value");
		_popupDiv.classList.add("shortPoupShow");
		_ipChapter2Goto.focus({ focusVisible: true, preventScroll :false });

		if(!_ipChapter2Goto.onkeyup){ //check this, so these event defined only one time
			let	jump2Chapter = () => {
				let toChap = document.getElementById("ipChapter2Goto").value;
				if(toChap !== "") changeChap(toChap);
				_popupDiv.classList.remove("shortPoupShow");
			}

			_ipChapter2Goto.onkeyup = (_ev) => {
				if (_ev.key === "Enter") {
					//if we call jump2Chapter() here, it would be invoked twice with one more time at focusout event. So, I call blur() to make textbox lost focus
					_ipChapter2Goto.blur();
				}
				if (_ev.key === "Escape") {
					_popupDiv.classList.remove("shortPoupShow"); //do nothing
				}
			}
			
			_ipChapter2Goto.addEventListener("focusout", jump2Chapter);
		}
	}

	/* Handle small popup for button functions Seek to a duration time for audio to play */
	static showSeekAudioDurationPopup(){
		let _popupDiv = document.getElementById("seekDurationDivPopup");
		let _ipDuration2Seek = document.getElementById("ipAudioDuration");
		const _pattern = /^[\+\-]?(([1-5][.,:])?([0-5]?\d)[.,:])?([0-5]?\d)$/; //accept . or , or : as duration seperator
		let _maxDuration = xAudio.duration;
		if(!_maxDuration) _maxDuration=0;
		
		_ipDuration2Seek.setAttribute("pattern", _pattern.source); //pattern to check valid
		_popupDiv.querySelector("label[for]").innerHTML = "Nhập thời gian muốn tua nhanh đến theo format <b>±H.mm.ss</b>, <b>±mm.ss</b> hoặc <b>±mm</b><br/>(Không quá <b>" + toHhMmSs(_maxDuration) + "</b>)";
		_ipDuration2Seek.value = ""; //elmPlaylist.getAttribute("attr-value");
		_popupDiv.classList.add("shortPoupShow"); //show the popup
		_ipDuration2Seek.focus({ focusVisible: true, preventScroll :false });

		if(!_ipDuration2Seek.onkeyup){ //check this, so these event defined only one time
			let	seekAudioTo = () => {
				let _toTime = _ipDuration2Seek.value.trim(); //time in  H.mm.ss format 
				if ( _pattern.test(_toTime)) {
					let _toDur = 0; //duration to jump to
					let plusMinus = _toTime[0];
					if("+-".indexOf(plusMinus) > -1 ){
						_toTime = _toTime.slice(1); //remove the +/- sign to get the time in h:mm:ss only
					}
					else plusMinus = ""; //there is no sign at all

					_toTime = _toTime.replaceAll(/[\.\,]/g,":"); //change to H:mm:ss format

					//convert string to number of seconds
					if(_toTime.indexOf(":") == -1 ) //format mm
						_toTime = parseInt(_toTime) * 60
					else //the other two format
						_toTime = toSeconds(_toTime);

					//handle +/- sign
					if(plusMinus === "+") _toTime += xAudio.currentTime;
					if(plusMinus === "-") _toTime = xAudio.currentTime - _toTime;

					if(_toTime >= 0 && _toTime < xAudio.duration){ //if within the audio duration
						xAudio.currentTime = _toTime;
						xAudio.onseeked();
					}
					else
					showToastMsg(_toTime < 0? "Thời gian không được nhỏ hơn 0" :"Thời gian bạn nhập lớn hơn tổng thời lượng của chương truyện");
				}
				else {
					if(_toTime) //only show message when user type something
						showToastMsg("Thời gian bạn nhập không đúng format");
				}

				_popupDiv.classList.remove("shortPoupShow");
			}

			_ipDuration2Seek.onkeyup = (_ev) => {
				//console.log(_ev.key);
				if (_ev.key === "Enter") {
					_ev.preventDefault();
					//if we call seekAudioTo() here, it would be invoked twice with one more time at focusout event. So, I call blur() to make textbox lost focus
					_ipDuration2Seek.blur();
				}

				if (_ev.key === "Escape") {
					_popupDiv.classList.remove("shortPoupShow"); //do nothing
				}
			}

			_ipDuration2Seek.addEventListener("focusout", seekAudioTo);
		}
	}

	/* Scroll to chapter in playlist that is playing. This would be invoked when new chapter is playing or when user click on scroll to playing chapter button */
	static gotoPlayingChapter(){
		let _liNewChap = elmPlaylist.querySelector("li.beingPlay");
		if(!_liNewChap) return; //this should never happen

		let _liParent = _liNewChap.parentElement;
		// if new playing chapter is inside a chapter group, then open that group if it currently close
		let _isSectionExpanded = true;
		if(_liParent.nodeName == "SECTION"){ //can use tagName or localName
			let _chapGrpCheckbox = _liParent.previousElementSibling.previousElementSibling;
			_isSectionExpanded = _chapGrpCheckbox.checked;
			_chapGrpCheckbox.checked = true;
			if(_chapGrpCheckbox.checked != _isSectionExpanded) this.chapGrpChkboxClick(_chapGrpCheckbox); //save state of this checkbox only when its state changed
			//this.updateAllChapGrpChkboxUI(); //update UI of allChapGrpChkbox
		}
		let _scrollToView = _ => {
			_liNewChap.scrollIntoView({
				behavior: 'smooth', //smooth sometime does not scroll to the location of playing chapter. Change to 'auto' might lack of scroll animation, but when the page first start, it can sroll into playing chapter
				block: 'center', //vertically centered
				inline: 'end' 
			})
		}

		if(_isSectionExpanded) _scrollToView()
		else 
		setTimeout(_scrollToView, 500); //wait for closed section to be expanded before scrolling
	}

	/* This change UI (checkedm indeterminate, not checked) of allChapGrpChkbox based on state of all chapGrpChkbox which decide a chapter group is collapse or expand */
	static updateAllChapGrpChkboxUI(){
		let _allChapChkbox = elmPlaylist.querySelectorAll("input[id^='chapGrpChkbox']");
		
		let _chkCount = 0, _chkTotal = _allChapChkbox.length;
		_allChapChkbox.forEach(_chkBox => {
			if(_chkBox.checked) _chkCount++;
		});

		let _chkExpandChapterGrp = document.getElementById("allChapGrpChkbox");
		let _chkLabel = _chkExpandChapterGrp.nextElementSibling;
		ttMutationObserver.observe(_chkLabel, {attributes: true, attributeFilter: ["data-tooltip"]});
		_chkLabel.setAttribute("data-tooltip", `Đóng/mở tất cả các chapter group\n` + ((_chkCount==0 || _chkCount==_chkTotal)? `Tất cả các ${_chkTotal} nhóm chương đang ${_chkCount==0?"đóng":"mở"}` : `Hiện có ${_chkCount} trong ${_chkTotal} nhóm chương đang mở`) );
		setChkboxState(_chkExpandChapterGrp,
		_chkCount == 0? 0 : (_chkCount == _chkTotal? 1 : 2) );
	}

	/* handler for chapter group changing state from expand to collapse and vice versa 
		_chapGrpChkbox {checkbox}: the checkbox of chapter-group which is changing state
		_notCheckPosition: if false (default is false or missing), the page check all chapter-group-label to see if there is any one overlap (other label) or missed-recognized as pinned item. The reason see below. If true, the checking is ignored
	Because scroll too fast, so IntersectionObserver object might not catch some lables being pinned at top of elmPlaylist, thanks to scrollTo, they are now moved down but still keep .stickyPinned class. So, we might need to go through all label and remove .stickyPinned from all label that below elmPlaylist top			
	*/
	static chapGrpChkboxClick(_chapGrpChkbox, _notCheckPosition){
		//let _chapGrpChkbox = evt.target;
		let _grpNo = parseInt(_chapGrpChkbox.getAttribute("attr-grpNo"));
		
		let _bookxState = xState[xAudio.getAttribute("attr-book")];
		let _idx = _bookxState.chapGrpCollapse.indexOf(_grpNo);
		let isChecked = _chapGrpChkbox.checked;

		if( _idx > -1 && isChecked)
			_bookxState.chapGrpCollapse.splice(_idx, 1); //remove it
		if( _idx === -1 && !isChecked)
			_bookxState.chapGrpCollapse.push(_grpNo); //add it
		utilityHandles.updateAllChapGrpChkboxUI(); //update allChapGrpChkbox UI when a group chapter change collapse/expand state

		//Check all label position to see if any one overlap or miss-recognized as pinned
		if(!_notCheckPosition) setTimeout(_ => { // && !isChecked
			let _parentTop = elmPlaylist.getBoundingClientRect().top;
			let _allChapGrpLabel = elmPlaylist.querySelectorAll("input[type='checkbox'] + label.is-sticky");

			let _stopCheck = false;
			for(let i=0; i< _allChapGrpLabel.length; i++){
				let _label = _allChapGrpLabel[i];
				let _lblRect = _label.getBoundingClientRect();
				let _lblTop = _lblRect.top;

				if(_lblTop >= _parentTop){
					_label.classList.toggle("stickyPinned", _lblTop <= _parentTop + 1); //1 is just number got on experiment
					//console.log(_label.getAttribute("for") + ": " +  _lblTop + ". " + _parentTop);
				}
				
				if(!_stopCheck){
					let _prevLblBottom = i>0? _allChapGrpLabel[i-1].getBoundingClientRect().bottom : -10;
					if(_lblTop < _prevLblBottom && _lblRect.bottom > _prevLblBottom){
						{ //here
						elmPlaylist.scrollBy( {left: 0, top: (_lblTop - _prevLblBottom - 8), behavior: "smooth"} ); //8 is label's margin-top + margin-bottom
						//console.log(i + ": " + (_lblTop - _prevLblBottom - 8));
						}
						_stopCheck = true; //no need to check anymore, because in one moment, there is maximum 1 label overlap
					}
				}
			}
		}, 800);
	}
}

/* Class to handle history buttons and functions */
class historyCls {
	/* Change the button enable/disable state and their titles */
	static buttonAppeance(){
		let _hist = xState.history;
		let _elmF = document.getElementById("elmHistoryGoForward");
		let _elmB = document.getElementById("elmHistoryGoBackward");
		let _elmC = document.getElementById("elmHistoryClear");

		if(_hist.hisList.length <= 1){
			_elmF.classList.add("elm-disabled");
			_elmB.classList.add("elm-disabled");
			_elmC.classList.add("elm-disabled");
			return;
		}
		else _elmC.classList.remove("elm-disabled");

		let _currBookValue = _hist.hisList[_hist.currHis+1];
		if(_hist.currHis == _hist.hisList.length-1) {
			_elmF.classList.add("elm-disabled")
		}
		else {
			ttMutationObserver.observe(_elmF, {attributes: true, attributeFilter: ["data-tooltip"]});
			_elmF.classList.remove("elm-disabled");
			let _bData = xData[_hist.hisList[_hist.currHis+1]-1];
			_elmF.setAttribute("data-tooltip", makeBrk(_bData.mc) + " " + _bData.title );
		}

		if(_hist.currHis == 0) _elmB.classList.add("elm-disabled")
		else {
			ttMutationObserver.observe(_elmB, {attributes: true, attributeFilter: ["data-tooltip"]});
			_elmB.classList.remove("elm-disabled");
			let _bData = xData[_hist.hisList[_hist.currHis-1]-1];
			_elmB.setAttribute("data-tooltip", makeBrk(_bData.mc) + " " + _bData.title );
		}
	}

	/* Clear history button */
	static historyClear(){
		let _hist = xState.history;
		_hist.currHis = 0;
		_hist.hisList.length = 0; //empty history list

		this.buttonAppeance();
	}

	/* Add a new play book to history. This is called from changeBook() function */
	static addToHistory(bookValue){
		let _hist = xState.history;
		if(_hist.histCallFlag){ //If changeBook() is called from History go backward or forward (see historyGo below)
			xState.history.histCallFlag = false; //reset flag
		}
		else{
			_hist.hisList.splice (_hist.currHis +1); //delete history from current index to the end
			if(bookValue != _hist.hisList[_hist.hisList.length-1])
				_hist.hisList.push(bookValue);
			_hist.currHis = _hist.hisList.length - 1;
		}

		historyCls.buttonAppeance(); //history buttons enable/disable
	}
	/* Go back and forward in history list 
		_dir: =0 go backward, 1 go forward
	*/
	static historyGo(_dir){
		let _hist = xState.history;
		_hist.histCallFlag = true; //turn this flag on so changeBook function know that this is called from History
		if(_dir){
			_hist.currHis++;
		}
		else{
			_hist.currHis--;
		}

		this.buttonAppeance();

		let _currBook = _hist.hisList[_hist.currHis];
		bookData.goGetBook(_currBook); //note that goGetBook reload the elmSelBookTitles book list
	}

	/* Clear all information saved in xState, not just books reading history, but also other information such as last playing time, grpLine, urlLine */
	static wipeAll(){
		if (!confirm("Bạn muốn xóa toàn bộ lịch sử trang Web đã lưu?\n\n Sẽ cần phải nạp lại trang Web.") == true) return;
		xState = {}; //clear the xState
		localStorage.clear(); //clear local storage
		//Force a hard reload to clear the cache if supported by the browser
		window.location.reload(true);
	}
}

/* Class to allow items of a list to be DRAG AND DROP */

/* constructor
		_dragItemsQuery: json contain the parent container and css query string to get list of children which is dragitems. Format: {"parent": wrapper element, "queryString" : "li"}
		_exchangeFnc: callback function to do something after each drop
	*/
var dragDropList = function(_dragItemsQuery, _exchangeFnc) {
	let dragItemsQuery = _dragItemsQuery;
	let dragItems = _dragItemsQuery["parent"].querySelectorAll(_dragItemsQuery["queryString"]);

	let exchangeFnc = null;
	if(_exchangeFnc) exchangeFnc = _exchangeFnc;

	//Setter to set callback function to change the list after drag and drop. This will take two parameter fromIdx, toIdx which are the index of drag&drop item 
	function setExchangeFnc(_exchangeFnc){
		exchangeFnc = _exchangeFnc;
	}

	/* all action to deal with drag & drop */
	function handleDragDrop(){
		// (PART B) FLAG FOR "CURRENT ITEM BEING DRAGGED"
		let dragged;
		let cancelDefault = (event) => {
			event.preventDefault();
			event.stopPropagation();
			return false;
		}

		// (PART C) DRAG-AND-DROP MECHANISM
		dragItems.forEach( (_item, _idx) => {
			// (C1) LIST ITEM IS DRAGGABLE
			_item.draggable = true;
			_item.setAttribute("attr-dragIdx", _idx);
			
			// (C2) ON DRAG START - SET FLAG & DATA TRANSFER
			_item.ondragstart = event => {
				dragged = _item;
				_item.classList.add("activeDragItem");
				event.dataTransfer.dropEffect = "move";
				event.dataTransfer.effectAllowed = "move";
				event.dataTransfer.setData("text/html", _item.innerHTML);
				event.dataTransfer.setData("text/plain", _item.getAttribute("attr-dragIdx"));
			};

			// (C3) ON DRAG OVER - NECESSARY PREVENT DEFAULT FOR DROP TO WORK
			_item.ondragover = event => {
				//event.preventDefault();
				cancelDefault(event);
			}

			// (C4) ON DROP - "SWAP POSITION"
			_item.ondrop = event => {
				//event.preventDefault();
				cancelDefault(event);
				if (dragged != _item) {
					//dragged.innerHTML = _item.innerHTML;
					//_item.innerHTML = event.dataTransfer.getData("text/html");

					let _fromIdx = event.dataTransfer.getData("text/plain"),
					_toIdx = _item.getAttribute("attr-dragIdx");
					_fromIdx = parseInt(_fromIdx), _toIdx= parseInt(_toIdx);
					if(exchangeFnc) exchangeFnc(_fromIdx, _toIdx); //invoke callback function to do the real exchange on the list outside

					//paint item just being dragged differently
					dragItemsQuery["parent"].querySelector(`[attr-dragIdx = "${_fromIdx}"]`).classList.add("beingPlay");

					//update attr-dragIdx for all item effected by the drag&drop action
					if(_fromIdx > _toIdx){
						dragItems[_fromIdx].setAttribute("attr-dragIdx", _toIdx);
						for(let i=_toIdx; i<_fromIdx; i++){
							dragItems[i].setAttribute("attr-dragIdx", i+1);
						}
					}
					else {
						dragItems[_fromIdx].setAttribute("attr-dragIdx", _toIdx);
						for(let i=_fromIdx+1; i<=_toIdx; i++){
							dragItems[i].setAttribute("attr-dragIdx", i-1);
						}
					}

					//we need to re-assign dragItems to update the items' order changes
					dragItems = dragItemsQuery["parent"].querySelectorAll(dragItemsQuery["queryString"]);
				}
			};

			// (C5) NOT REALLY IMPORTANT - COSMETICS
			_item.ondragenter = (event) => {_item.classList.add("activeDropItem"); cancelDefault(event);}
			_item.ondragleave = (event) => {_item.classList.remove("activeDropItem");cancelDefault(event);}
			_item.ondragend = (event) => {
				dragItems.forEach( (_itm) => { 
					_itm.classList.remove("activeDragItem");
					_itm.classList.remove("activeDropItem");
				});
			};
		});
	}

	/* public methods */
	return {
		exchangeFnc : setExchangeFnc, /* setter function for callback function exchangeFnc */
		handleDragDrop : handleDragDrop /* Function to handle drag & drop */
	}
}

/* Class deal with user-setting on book group, show/hide books for each group, and show/hide circle progress on Play/Pause buttons 
To optimize user experience, every time a check box (which define the group visible or hidden) is clicked, everytime a group is drag and drop, this function is called automatically to save the change in setting right away, without any further action to click on some kind of "save setting" buttons
*/
var setting = ( function Setting() {
	let _dragObj = null; // instance object of dragDropList class to handle drag&drop
	//ol that display all sub-group and books of a group way
	let lstBookTitlesSetting = document.getElementById("lstBookTitlesSetting");

	//setting for circle progress button
	function handleCircleProgressChkbox(){
		let _chkDisableCircleProgress = document.getElementById("chkDisableCircleProgressButton");
		_chkDisableCircleProgress.checked = !xState.disableCircleProgressButton;

		if(!_chkDisableCircleProgress.onclick) //if click event has not been handled
		_chkDisableCircleProgress.onclick = (_ev) => { //user make change to circle progress button setting.
			xState.disableCircleProgressButton = !_ev.target.checked;

			//update the Play button interface. See AudioPlayer.switchPlayPauseButton() for more details. Svg icon here can be #icnSvgSpinWaiting, #icnSvgPlay, #icnSvgPause OR #icnSvgSpinWaiting, #icnSvgPlayProgress, #icnSvgPauseProgress
			document.querySelectorAll("[svg-icon-name='PlayPauseIcon']").forEach(_elm => {
				let _currSvg = _elm.getAttribute("href");
				if(_currSvg == "#icnSvgSpinWaiting") return //if it is loading spinner, keep it the same
				else {
					if(xState.disableCircleProgressButton){
						_currSvg = _currSvg.replace("Progress", ""); // Remove sufix "Progress" from the end of icon to make icon simple icon
					}
					else
						_currSvg+= "Progress"; // Add sufix "Progress" to the end of icon to make icon 'circle progress'
				}
				_elm.setAttribute("href", _currSvg); //change svg icon
			});
		};
	}

	//setting for circle progress button
	function handleBufferBarChkbox(){
		let _chkHideBufferBar = document.getElementById("chkHideBufferBar");
		_chkHideBufferBar.checked = !xState.hideBufferBar;

		if(!_chkHideBufferBar.onclick) //if click event has not been handled
		_chkHideBufferBar.onclick = (_ev) => { //user make change to show/hide buffer bar.
			xState.hideBufferBar = !_ev.target.checked;

			document.querySelector(".ap-buffer-bar").classList[xState.hideBufferBar?"add" : "remove"]("elm-hidden");

			if(!xState.hideBufferBar) {
				xState.depressToastFlag = true; //turn on flag so the toast Message will not display
				xAudio.onseeked(); //to update UI of the buffer bar
			}
		}
	}
	
	/* move an item of array ${arr} from index ${fromIndex} to index ${fromIndex} */
	function arrayMove(arr, fromIndex, toIndex) {
		var element = arr[fromIndex];
		arr.splice(fromIndex, 1); //take fromIndex item out
		arr.splice(toIndex, 0, element); //insert to toIndex
	}

	/* handle with the case when #chkShowBookKit (Book Kit checkbox) is off, meaning #lstBookTitlesSetting display book set as its item 
		_grpLine {integer}: the index of group line, which is also selected index of selPopupBookGroup
	*/
	function bookSetList(_grpLine){
		let xbookGrp_grp = xBookGrp[_grpLine].grp; // [...xBookGrp[bookGrpWay].grp]: can use this Spread Operator (ES6) to clone grp array - but it did not work (may be this is array of Json items)

		lstBookTitlesSetting.innerHTML = ""; //clear the last book dropdown list
		let gStt=1;
		for(let j=0; j<xbookGrp_grp.length; j++){
			let bookGrpItem = xbookGrp_grp[j];
			let _numberOfBooks = bookGrpItem.books.reduce((_total, _currItem) => {return _total + _currItem.bList.length},0);
			
			let _liGrpTitle = document.createElement('li');
			_liGrpTitle.innerHTML = `<code>${makeBrk(gStt++)}</code> <span>${bookGrpItem.label}<sup>${bookGrpItem.bookKit}</sup> ${makeBrk(_numberOfBooks)}</span> <input type="checkbox" ${bookGrpItem.bHidden?"":"checked"} role="switch" attr-BookKit-Father="${bookGrpItem.bookKit}"/>`;
			_liGrpTitle.setAttribute("attr-grpID", bookGrpItem.gId);
			//_liGrpTitle.setAttribute("attr-BookKit-Father", bookGrpItem.bookKit);

			_liGrpTitle.querySelector("input[type='checkbox']").onclick = evt => {
				let chkBox = evt.target;
				let _bkIndex = chkBox.getAttribute("attr-BookKit-Father");
				updateBKchkboxUI(_bkIndex);

				let _gid = chkBox.parentNode.getAttribute("attr-grpid"); //book set Id
				xState.grpCfg[_grpLine].grp.find((_it)=>{return _it.gId === _gid}).bHidden = !chkBox.checked; //update to xState.grpCfg
				bookGrpItem.bHidden = !chkBox.checked; //update hidden state to xBookGrp
			};
		
			lstBookTitlesSetting.appendChild(_liGrpTitle);
		}

		/* handle with drag&drop Book set in #lstBookTitlesSetting of the case when #chkShowBookKit (Book Kit checkbox) is off, meaning #lstBookTitlesSetting display book set as its item.
		*/
		(function startDragNDrop(){
			let _exchangeFnc = function(f,t) {
				// console.log("From " + f + " to " + t);
				f = parseInt(f), t= parseInt(t);
				let _itemDrag = lstBookTitlesSetting.querySelector("li[attr-dragidx='" + f + "']");
				let _itemDrop = lstBookTitlesSetting.querySelector("li[attr-dragidx='" + t + "']");
				if(f>t)
					lstBookTitlesSetting.insertBefore(_itemDrag, _itemDrop);
				else
					lstBookTitlesSetting.insertBefore(_itemDrag, _itemDrop.nextSibling);

				//save all changes of last session before changing group way
				arrayMove(xbookGrp_grp, f, t); //re-arrange for xBookGrp
				arrayMove(xState.grpCfg[_grpLine].grp, f, t); //re-arrange for xState.grpCfg

				//re-calculte book kit rank
				calculateBookKitRank(_grpLine);
			}
			_dragObj = dragDropList({"parent": lstBookTitlesSetting, "queryString" : "li"}, _exchangeFnc);
			_dragObj.handleDragDrop();

		}) (); //allow drag&drop right when new list is populated
		
		/* Function to change the UI of Book Kit checkbox depending on checked state of all of its book set checkbox */
		let updateBKchkboxUI = _bkIndex =>{
			let allChkboxCount = 0, checkedCount = 0;
			document.querySelectorAll(`.modalPopupContent input[type='checkbox'][attr-bookkit-father='${_bkIndex}']`).forEach(_liChkBox => {
				allChkboxCount++;
				if(_liChkBox.checked) checkedCount++;
			});
			let _chkBookKit = document.getElementById(`chkbox-BK-${_bkIndex}`);
			if(!_chkBookKit) return; //if this book kit has only one book set, so there is no book kit checkbox
			setChkboxState(_chkBookKit, checkedCount === 0 ? 0 : (checkedCount === allChkboxCount ? 1: 2) );

		};

		/* Create checkbox for book Kit that has more than 1 book sets */
		let bkCounts = bookKitInfor.map(_it => 0);
		xBookGrp[_grpLine].grp.forEach(_it => bkCounts[_it.bookKit]++);
		let bookKitHTML = "";
		let _stt=0;
		for(let i=0; i< bkCounts.length; i++){
			if(bkCounts[i] <=1) continue;
			let _bkIdx = bookKitInfor[i].bkIdx;
			bookKitHTML += `<div class="bookKitNo${_stt++}"><input id="chkbox-BK-${_bkIdx}" type="checkbox" role="switch" attr-BookKit="${_bkIdx}" class="!text-[25px]"/>
			<label for="chkbox-BK-${_bkIdx}">${bookKitInfor[i].label}</label></div>`;
		}
		let bookKitChkboxContainer = document.querySelector('[name="bookKitChkboxContainer"]');
		bookKitChkboxContainer.innerHTML = bookKitHTML;
		bookKitChkboxContainer.querySelectorAll("input[type='checkbox'][id*='chkbox-BK-']").forEach(chkBox => {
			let _bkIndex = chkBox.getAttribute("attr-bookKit");
			updateBKchkboxUI(_bkIndex); //update Book Kit UI corresponding with its Book Sets checked state

			let _bkIdx = chkBox.getAttribute("attr-bookKit");
			let _bookSetsChilds = document.querySelectorAll(`.modalPopupContent input[type='checkbox'][attr-bookkit-father='${_bkIdx}']`);

			// add class for all Book sets children of this Book Kit, so when hover the Book Kit, all of its book sets will highlight (using CSS)
			let _clsName = chkBox.parentElement.classList[0];
			_bookSetsChilds.forEach(_liChkBox => {
				_liChkBox.parentElement.classList.add(_clsName + "-Childs");
			})
			
			// Change checked state of all Book Sets with theirs Book Kit checked state
			chkBox.onclick = function(evt){
				//let chkBox = evt.target;
				//let _bkIdx = chkBox.getAttribute("attr-bookKit");
				// make all Book Set that belong to the Book Kit be shown/hidden with the checked state of the Book Kit checkbox
				_bookSetsChilds.forEach(_liChkBox => {
					_liChkBox.checked = chkBox.checked; // change book set UI

					let _gid = _liChkBox.parentNode.getAttribute("attr-grpid"); //book set Id
					xState.grpCfg[_grpLine].grp.find((_it)=>{return _it.gId === _gid}).bHidden = !_liChkBox.checked; //update to xState.grpCfg

					xBookGrp[_grpLine].grp.find((_it)=>{return _it.gId === _gid}).bHidden = !_liChkBox.checked; //update to xState.grpCfg
				});
			}
		});
	}

	/* handle with the case when #chkShowBookKit (Book Kit checkbox) is off, meaning #lstBookTitlesSetting display book set as its item 
		_grpLine {integer} the index of group line, which is also selected index of selPopupBookGroup
	*/
	function bookKitList(_grpLine){

		//rank of each book kit in this group line
		let _tempRank = bookKitInfor.map(_it => {return {bkIdx: _it.bkIdx, rank: _it.grpRanks[_grpLine].rank} });

		//sort book kit list by the rank
		let _tempBookKitInf = bookKitInfor.toSorted( (x,y) => _tempRank[x.bkIdx].rank - _tempRank[y.bkIdx].rank );

		/* Count number of hidden book set for each book kit */
		bookKitInfor.forEach(_it => _it.grpRanks[_grpLine].bsHidden = 0);//reset hidden book set Count to 0 for this group line
		let xbookGrp_grp = xBookGrp[_grpLine].grp;
		for(let j=0; j<xbookGrp_grp.length; j++){
			let bookGrpItem = xbookGrp_grp[j];
			let _bkIdx = bookGrpItem.bookKit;

			if(bookGrpItem.bHidden) bookKitInfor[_bkIdx].grpRanks[_grpLine].bsHidden++;
		}

		bookKitChkboxContainer = document.querySelector('[name="bookKitChkboxContainer"]').innerHTML = ""; //clear all book Kit Chkbox of Book set view
		lstBookTitlesSetting.innerHTML = ""; //clear the last book dropdown list
		let gStt=1;
		for(let j=0; j<_tempBookKitInf.length; j++){
			let _bookKitItem = _tempBookKitInf[j];
			let _numberOfBooks = _bookKitItem.endIdx - _bookKitItem.startIdx + 1;
			let _numOfBookset = _bookKitItem.grpRanks[_grpLine].bsCount;
			let _bkIdx = _bookKitItem.bkIdx;
			
			let _liGrpTitle = document.createElement('li');
			_liGrpTitle.innerHTML = `<code>${makeBrk(gStt++)}</code> <span>${_bookKitItem.label}<sup>${_bkIdx}</sup> ${makeBrk(_numOfBookset)}<sup>${_numberOfBooks}</sup></span> <input attr-bookKit="${_bkIdx}" type="checkbox" role="switch" checked />`;
			_liGrpTitle.setAttribute("attr-bookKitIdx", _bkIdx);
			//_liGrpTitle.setAttribute("attr-BookKit-Father", bookGrpItem.bookKit);

			let _chkBookKit = _liGrpTitle.querySelector("input[type='checkbox']");
			//update UI for Book Kit checkbox
			let _ranksInfor = bookKitInfor[_bkIdx].grpRanks[_grpLine];
			_chkBookKit.title = `${_ranksInfor.bsHidden} out of ${_ranksInfor.bsCount} hidden`;
			setChkboxState(_chkBookKit, _ranksInfor.bsHidden === _ranksInfor.bsCount ? 0 : (_ranksInfor.bsHidden === 0 ? 1: 2) );

			// handle when Book Kit check box changed
			_chkBookKit.onclick = evt => {
				//go through all xBookGrp[_idx].grp to find book sets belong to this book kit
				for(let j=0; j<xbookGrp_grp.length; j++){
					let bookGrpItem = xbookGrp_grp[j];
					// if this book set belong to current book kit with bkIdx == _bkIdx
					if(bookGrpItem.bookKit == _bkIdx) {
						bookGrpItem.bHidden = !_chkBookKit.checked; //update to xBookGrp
						let _gid = bookGrpItem.gId;

						xState.grpCfg[_grpLine].grp.find((_it)=>{return _it.gId === _gid}).bHidden = !_chkBookKit.checked; //update to xState.grpCfg
					}
				}
			};
		
			lstBookTitlesSetting.appendChild(_liGrpTitle);
		}

		/* handle with drag&drop Book set in #lstBookTitlesSetting of the case when #chkShowBookKit (Book Kit checkbox) is off, meaning #lstBookTitlesSetting display book set as its item.
		*/
		(function startDragNDrop(){
			let _exchangeFnc = function(f,t) {
				//console.log("From " + f + " to " + t);
				f = parseInt(f), t= parseInt(t);
				let _itemDrag = lstBookTitlesSetting.querySelector("li[attr-dragidx='" + f + "']");
				let _fBKidx = _itemDrag.getAttribute("attr-bookKitIdx"); //book kit id of From element
				let _itemDrop = lstBookTitlesSetting.querySelector("li[attr-dragidx='" + t + "']");
				let _tBKidx = _itemDrop.getAttribute("attr-bookKitIdx"); //book kit id of To element

				if(f>t)
					lstBookTitlesSetting.insertBefore(_itemDrag, _itemDrop);
				else
					lstBookTitlesSetting.insertBefore(_itemDrag, _itemDrop.nextSibling);

				//save all changes of last session before changing group way
				//a. update bookKitInfor rank 
				lstBookTitlesSetting.querySelectorAll("li").forEach( (_it, _idx) => {
					let _bkIdx = _it.getAttribute("attr-bookKitIdx");
					bookKitInfor[_bkIdx].grpRanks[_grpLine].rank = _idx; // the new rank of this book kit is its order in lstBookTitlesSetting
				} );

				//b. update xState and xBookGrp together. Note that array xState.grpCfg[_grpLine].grp is part of array xBookGrp[_grpLine].grp (which has been assigned to variable bookGrp_grp), and most importantly, these two arrays are always aligned
				let _bsLocation = []; //location (index) of all book sets belong to from book kit
				let _fxState = [], _fxBookGrp = []; //store all book sets of dragged book kit
				let xstate_grpCfg = xState.grpCfg[_grpLine].grp; //short name for xState grp
				for(let j=0; j<xbookGrp_grp.length; j++){
					if(xbookGrp_grp[j].bookKit == _fBKidx) _bsLocation.push(j);
				}

				// take all book sets out of xBookGrp and xState. Because going from end to beginning of array, the taken out array would be revesed in order
				for(let j=_bsLocation.length-1; j >= 0; j--){
					_fxBookGrp = _fxBookGrp.concat(xbookGrp_grp.splice(_bsLocation[j], 1) );
					_fxState = _fxState.concat(xstate_grpCfg.splice(_bsLocation[j], 1) );
				}
				_fxBookGrp =  _fxBookGrp.reverse(); //the order need to be reversed back
				_fxState = _fxState.reverse();

				if(f < t){ //dragging down: move all book sets of From book kit right after the last book set of To book kit
					let _tLastIdx = -1; //find the last index of 
					for(let j=xbookGrp_grp.length - 1; j >= 0; j--){
						if(xbookGrp_grp[j].bookKit == _tBKidx) {
							_tLastIdx = j;
							break;
						}
					}
					// put back all book sets has been taken out after _tLastIdx
					xbookGrp_grp.splice(_tLastIdx + 1, 0, ..._fxBookGrp); //using Spread syntax
					xstate_grpCfg.splice(_tLastIdx + 1, 0, ..._fxState);
				}
				else { //dragging up: move all book sets of From book kit right before the first book set of To book kit
					let _tFirstIdx = -1; //find the last index of 
					for(let j=0; j<xbookGrp_grp.length; j++){
						if(xbookGrp_grp[j].bookKit == _tBKidx) {
							_tFirstIdx = j;
							break;
						}
					}
					// put back all book sets has been taken out right before _tFirstIdx
					xbookGrp_grp.splice(_tFirstIdx, 0, ..._fxBookGrp); //using Spread syntax
					xstate_grpCfg.splice(_tFirstIdx, 0, ..._fxState);
				}
			}
			_dragObj = dragDropList({"parent": lstBookTitlesSetting, "queryString" : "li"}, _exchangeFnc);
			_dragObj.handleDragDrop();

		}) (); //allow drag&drop right when new list is populated
	}

	function openSettingModal(){
		//setting for circle progress button
		handleCircleProgressChkbox();		

		//setting for circle progress button
		handleBufferBarChkbox();

		//listbox show all kind of group in xBookGrp
		let selPopupBookGroup = document.getElementById("selPopupBookGroup");
		
		// checkbox to show book kit or book set in lstBookTitlesSetting
		let _chkShowBookKit = document.getElementById("chkShowBookKit");
		if(!_chkShowBookKit.onclick)
		_chkShowBookKit.onclick = _ => {
			selPopupBookGroup.onchange();
			let _chkboxLabel = _chkShowBookKit.nextElementSibling;
			_chkboxLabel.innerText = _chkShowBookKit.checked? "Book Kit view" : "Book Set view";
			let _tooltipTxt = _chkShowBookKit.checked?
			"Danh sách hiển thị phía dưới là Book Kit. Mỗi item có dạng '[2] Harry Potter^1 [1]^7', trong đó:\n[2]: stt của book Kit Harry Potter.\n^1: id của Book Kit.\n[1]: số Book Set của Book Kit này.\n^7: số books của Book Kit này.\n\nChú ý: Trong chế độ Book Kit, nếu thay đổi thứ tự một Book Kit, toàn bộ Book Set của Book Kit đó sẽ được chuyển cùng nhau, có thể làm mất thứ tự các Book Set bị xen kẽ trong Book Set của các Book Kit khác." :
			"Danh sách hiển thị phía dưới là Book Set. Mỗi item có dạng '[2] Harry Potter^1 [7]', trong đó:\n[2]: stt của Book Set Harry Potter.\n^1: id của Book Kit cha.\n[7]: số books của Book set này.";
			_chkboxLabel.setAttribute("data-tooltip", _tooltipTxt);

			// wait 1.5s for tooltip to be render before re-calculate its position
			setTimeout( _ => reposTooltips(_chkboxLabel.parentElement, {container: document.querySelector(".modalPopupContentWrapper") }), 1500);
		};

		//populate book group way list
		(function () {
			var _defGrpLabels = xBookGrp.map(_ => {return _.grpWay}); //get list of group name
			
			selPopupBookGroup.innerHTML = "";
			
			for (let i = 0; i < _defGrpLabels.length; i++) {
				let opt = document.createElement('option');
				opt.value = i;
				opt.innerHTML = makeBrk(pad(i+1,2)) + " " +  _defGrpLabels[i]; 
				selPopupBookGroup.appendChild(opt);
			}
		})();
		selPopupBookGroup.selectedIndex = xState.grpLine;
		// make the replaced spinner to have the same color with elmSelBookTitles
		selPopupBookGroup.style.backgroundImage = document.getElementById("elmSelBookTitles").style.backgroundImage;

		selPopupBookGroup.onchange = _ => {
			let newGrpIdx = selPopupBookGroup.selectedIndex;
			if(_chkShowBookKit.checked) bookKitList(newGrpIdx);
			else bookSetList(newGrpIdx);
		}
		selPopupBookGroup.onchange();
		_chkShowBookKit.onclick(); // this has to put behind because it invokes selPopupBookGroup.onchange()

		document.getElementById("modalSettingPopup").classList.add("activeModalPopup");
	}

	/* Transfer all setting changes to xBookGrp variable
		_grpLine: the line of group to save setting. If missing (only when called inside this setting class), _grpLine will be value of selPopupBookGroup select box
	*/
	function transferSetting2BookGrp(_grpLine){
		if(_grpLine == undefined) document.getElementById("selPopupBookGroup").value;
		let _bookGrps = xBookGrp[_grpLine].grp;

		/* I. Update the order and hidden state of each book set */
		// xState.grpCfg (store the order and shown/hidden states for each book set by each group way) has been updated immediately when user click a checkbox or drag&drop an item

		//xState.grpCfg has been created (if it not yet existed) in prepareData(), so following check is redundant
		let _xStateCfgs = xState.grpCfg && xState.grpCfg[_grpLine] && xState.grpCfg[_grpLine].grp;
		if(!Array.isArray(_xStateCfgs) || _xStateCfgs.length == 0 ) return; //there is no setting for this group line yet
			
		/* I.A Update the order of each book set */
		let _tmpArrSorted={}; //temp array store user-setting order for each xBookGrp gId, which will be used for sorting xBookGrp
		_xStateCfgs.forEach((_itm, _idx) => _tmpArrSorted[_itm.gId] = _idx);

		//sort _bookGrps
		_bookGrps.sort((_a,_b) => {
			return _tmpArrSorted[_a.gId] - _tmpArrSorted[_b.gId];
		});

		/* I.B update the shown/hidden state of each book set */
		//now _bookGrps and _xCfgs have the same order, copy bHidden flag to xBookGrp
		for(let i=0; i< _xStateCfgs.length; i++) {
			_bookGrps[i].bHidden = _xStateCfgs[i].bHidden;

		}

		/* II. Re-calculate book kit ranks based on order of all of its book set(s) */
		calculateBookKitRank(_grpLine);
	}

	/* Based on the order of each book set, calculate the rank for each book kit (which actually the rank of avarage order of all book sets belong to a book kit) */
	function calculateBookKitRank(_grpLine){
		let _bookGrps = xBookGrp[_grpLine].grp;
		//grpRanks store rank (order) of each book kit for each group line that user re-arrange
		for(let i=0; i< bookKitInfor.length; i++){
			let bkInforItemRank = bookKitInfor[i].grpRanks;
			if(!bkInforItemRank || !Array.isArray(bkInforItemRank) )
			bookKitInfor[i].grpRanks = new Array(xBookGrp.length).fill(-1); //if not yet created, create new one with all -1
		}

		let _tempRank = bookKitInfor.map(_it => {return {bkId: _it.bkIdx, count:0, rank: 0} });
		for(let i=0; i< _bookGrps.length; i++) {
			let _bkFather = _bookGrps[i].bookKit;
			_tempRank[_bkFather].count++;
			_tempRank[_bkFather].rank += i;
		}
		// get the avarage rank of all book sets for each book kit
		_tempRank.forEach(_it => _it.rank = Math.round(_it.rank / _it.count, 2) );
		_tempRank.sort( (a,b) => a.rank - b.rank ); //sort ranks

		//update rank for the book kit
		for(let i=0; i< _tempRank.length; i++){
			let _tempItem = _tempRank[i];
			bookKitInfor[_tempItem.bkId].grpRanks[_grpLine] = {bsCount: _tempItem.count, rank: i, bsHidden: 0}; //bsCount = book-set count, count number of book sets. bsHidden: book set hidden, count the number of hidden book set(s)
		}
		/* III. Update something more...? */
	}

	function closeSettingModal(){
		//clear the group listbox and books ol, and the same time clear all event handler (such as onchange or drag&drop) for each element and its children
		document.getElementById("selPopupBookGroup").innerHTML="";
		document.getElementById("lstBookTitlesSetting").innerHTML = "";
		document.querySelector('.modalPopupContent [name="bookKitChkboxContainer"]').innerHTML = "";
		_dragObj = null;

		/* //transfer all saved setting to xBookGrp
		for(let i=0; i<xBookGrp.length; i++ ){
			this.transferSetting2BookGrp(i);
		} */

		//Lưu xSate vào Local Storage
		localStorage.setItem('xState', JSON.stringify(xState));

		xState.depressToastFlag = true; //turn on this flag so the Toast message called inside next function will not display
		//make all the book setting take effect on main page
		bookData.switchBookGrpWay();

		//close the modal
		document.getElementById("modalSettingPopup").classList.remove("activeModalPopup");

	}

	/* PUBLIC METHOD */
	return {
		openSettingModal : openSettingModal,
		transferSetting2BookGrp : transferSetting2BookGrp,
		closeSettingModal : closeSettingModal
	};
})();

</script>

<!-- MAIN PLAYER CONTROLS -->
<script>
/* CLASS deal with audio player
	jsonOption: json object to specify some initial value. For example, it can be {speed: 1.4} to specify the initial speed for audio playback is 1.4

	modified from https://github.com/likev/html5-audio-player
*/
var AudioPlayer = function(jsonOption) {
let isSeeking = false, isPlaying, rightClick = false, volumeLength; //vars for seeking by mouse and by touching
let xPlayer = document.querySelector(".ap-container");
let volumeBtn      = xPlayer.querySelector('.ap-volume-btn');
let remTime        = xPlayer.querySelector('.ap-time--remains');
let trackTitle     = xPlayer.querySelector('.ap-title');
let progressBar    = xPlayer.querySelector('.ap-progress-bar');
let preloadBar     = xPlayer.querySelector('.ap-progress-preload-bar');
let volumeBar      = xPlayer.querySelector('.ap-volume-bar');
let playBtn        = xPlayer.querySelector('.ap-play-pause-btn');
let prevBtn        = xPlayer.querySelector('.ap-prev-btn');
let nextBtn        = xPlayer.querySelector('.ap-next-btn');
let reloadBtn      = document.querySelector('.ap-reload-btn');
let elmPlayingTime = document.getElementById("elmPlayingTime"); //playing time big display
let bufferBarCanvas      = document.querySelector('.ap-buffer-bar');

xAudio.autoplay = true; //this actually not doing anything

/* Check if internet connection is alive or dead
If dead, swich some element showing that internet is dead
*/
function checkInternetAlive(){
	if(navigator.onLine) return true;
	
	//no internet
	switchBigPlayingTime(-1); //showing no internet error

	// search "Audio readyState mdn" for meaning of readyState and its value
	if(xAudio.readyState < HTMLMediaElement.HAVE_FUTURE_DATA)
		xAudio.pause(); //pause audio
	switchPlayPauseButton(1, 0); // Play icon but 3 buttons got disabled
	return false;
}

/* ==========  WINDOW EVENT BINDING ========== */
{
	window.addEventListener("offline", (e) => {
		showToastMsg("Mất kết nối Internet");
	});

	// this event only fires when connection is lost and got back again
	window.addEventListener("online", (e) => {
		showToastMsg("Kết nối Internet");
		document.getElementById("elmPlayingTime").innerText = toHhMmSs(xAudio.currentTime) + " / " + toHhMmSs(xAudio.duration); // remove "no internet" text from big font playing time;
		
		switchPlayPauseButton(1, 1); //enable buttons and show Play icon
		
		//show cover img and hide No-Internet sprite svg image
		let _elmArtwork = document.getElementById("elmArtwork");
		_elmArtwork.classList.remove("elm-hidden");
		_elmArtwork.src = _elmArtwork.src; //reload cover image
		document.querySelector(".noInternetImg").classList.add("elm-hidden");

		reloadSrc(true); //reload src
	});
}
/* ==========  AUDIO HTML ELEMENT EVENT BINDING ========== */
{//set event handler for audio element
	/* When audio lack of data, and need to load, the event order would be: Waiting [> Progress] > Stalled [> Progress] > CanPlay > Playing > Progress 
	However, on stupid Apple Safary, after firing Stalled event, browser does not fire any other event except timeUpdate and sometime progress
	*/
	xAudio.onloadstart = (event) => { //start loading media, so we need to wait until oncanplay
		console.log("Load Start");
		remTime.innerHTML = "-:-- / -:--";
		//reset progress bar
		progressBar.style.width = '0%';
		preloadBar.style.width = '0%';

		if(!checkInternetAlive()) return;

		switchBigPlayingTime(0);
		switchPlayPauseButton(-1, 0); //show loading icon

		//reset circle progress bar to 0% (beginning)
		updateCircleProgressBar(0); 

		clearBufferBar(); //clean the buffer bar
	};

	// The canplay event is fired when the user agent can temporarily play the media, canplaythrough fired when it can play the media up to its end without stopping for content buffering.
	xAudio.oncanplay = (event) => { //the audio can now play
		// console.log("Can Play");
		updateTime();
		switchBigPlayingTime(1);
		
		//because of html audio element's autoplay attribute, we have to check the playing state to show corresponding buttons
		switchPlayPauseButton(xAudio.paused?1:0, 1);
	};
	
	/* 
	//The waiting event is fired when playback has stopped because of a temporary lack of data.
	xAudio.onwaiting = () => {console.log("Waiting")};
	//The progress event is fired periodically as the browser loads a resource.
	xAudio.onprogress = () => {console.log("Progress")};
 	*/

	//when the user agent is trying to fetch media data, but data is unexpectedly not forthcoming.
	xAudio.onstalled = (event) => { //this is similar to onwaiting ?
		console.log("Stalled !!!");
		checkInternetAlive();
		showToastMsg("Trying to fetch data.");
		//switchPlayPauseButton(); //show loading icon. TODO: If run this, we have to deactive it on some other event, see above for this problem
	};

	/* xAudio.onwaiting = (event) => { //this is invoked before stalled
		console.log("Waiting !!!");
	}; */
	
	// when a seek operation completed, the current playback position has changed
	xAudio.onseeked = (event) => {
		// console.log("Seeked");
		if(!isSeeking) showToastMsg("Audio is seeked to " + toHhMmSs(xAudio.currentTime));
		updateTime(); //after being seeked, the audio data need to buffer, sometime this take times until the audio can continue playing. So we need to update UI of the page
		updateBufferCanvas();
	};
		
	xAudio.onpause = (event) => {
		console.log("Paused");
		showToastMsg("Paused !!!");
		switchPlayPauseButton(1, 1); //show play icon
	};
	xAudio.onplaying = xAudio.onplay = (event) => {
		// console.log("Playing");
		showToastMsg("Playing...");
		switchPlayPauseButton(0, 1); //show pause icon
	};

	/* Some important events */
	xAudio.onended= (event) => {
		if(checkInternetAlive() ) playNextPrev(1);
	}; //when reach to end, play the next chapter: 
	xAudio.onratechange= (event) => {changeAudioSpeed()}; //somehow, sometimes the speed change back to normal withour user's request, so we need to change it back.

	xAudio.addEventListener('timeupdate', updateTime, false);
	/* xAudio.addEventListener('error', audioError, false);
	function audioError(evt){
	if (xAudio.networkState===HTMLMediaElement.NETWORK_NO_SOURCE)
		console.log("could not load audio source");
	} */
    
}

/* load new source for audio
	_src {string}		: mp3 link for playing audio
	_justReload {boolean} :
		TRUE: If failed, just trying audio.load() to reload audio sr, skip step 3 of tryingLoadAudio()
		FALSE: if failed again after audio.load(), try others url src
 */
function loadSrc(_src, _justReload){
	xAudio.src = _src;
	tryingLoadAudio(_justReload);
}

/* Function using promise chain to try playing audio 
1. Try audio.play() with current source
2. If failed, using audio.load() to reload (same) source. Sometime media from archieve.org need to load 2-3 times for it to play
3. Still failed: playing other sources
4. Still failed: notify user, change buttons UI.

param _justReload {boolean}
	True: just try reload current source without trying other url src line (skip step 3 above)
	False: include step 3
 */
function tryingLoadAudio(_justReload){
	if(!checkInternetAlive()) return; //check internet connection, if lost: change button UI and return

	let playPromise = xAudio.play();
	if (playPromise !== undefined){
		playPromise.then(_ => {
			//showToastMsg("Playing...");
		})
		.catch(_err => {
			// You can put a breakpoint here to see the detail of _err, all its properties and built-in error constant code
			console.log(`[tryingLoadAudio]: [${_err.code}]${_err.name}: ${_err.message}`);

			//[0]NotAllowedError: play() failed because the user didn't interact with the document first.
			if(_err.code === 0) {
				showToastMsg(`Phải bấm nút Play để nghe truyện`);
				return; //might put some code for playing audio when there is user interaction on page
			}

			//show error other than NotAllowedError
			showToastMsg(`[${_err.code}]${_err.name}: ${_err.message}`);

			// [20]AbortError: The play() request was interrupted by a new load request.
			if(_err.code === _err.ABORT_ERR){
				return;
			}

			// Network problem
			if(_err.code === _err.NETWORK_ERR){
				showToastMsg(`Mất kết nối Internet`);
				return;
			}

			// these code meaning "could not load audio source", it is most likely that audio source not exists. Should handle to reload or try others url line (if any)
			// _err.name === "NotAllowedError" NotSupportedError || _err.name === "SecurityError"
			/* Following audio.load() should be handled by some type of error like I listed here, but for now, the code is used for all type of error
			if(xAudio.networkState===HTMLMediaElement.NETWORK_NO_SOURCE || [_err.NOT_FOUND_ERR, _err.NOT_SUPPORTED_ERR, _err.TIMEOUT_ERR].indexOf(_err.code) > -1 ){} */
			
			console.log("[tryingLoadAudio]: trying audio.load()");
			xAudio.load(); //trying to reload source ONE time
			return xAudio.play(); //throw new promise for next catch() to catch if there is any more error
		}).catch(_err => {
			console.log(`[tryingLoadAudio]: audio.load() Failed.\n[${_err.code}]${_err.name}: ${_err.message}`);

			let _switchSrcBtn = document.querySelector(".switchChapterAudioSrc");
			// Change audio source if there are more than one
			if(!_justReload && _switchSrcBtn){
				console.log("[tryingLoadAudio]: Try loading other source ");
				changeAudioSrc(true); //trying load audio src WITHOUT fail-safe to play other url line if current url line failed
			}
			else {
				showToastMsg("Không phát được chương truyện. Chọn chương hoặc truyện khác");
				switchPlayPauseButton(1, 0); //paint UI (Play icon, disabled) for some buttons telling that audio cannot play
			}
		});
	}
}

/* ==========  AUDIO CONTROL BUTTONS HANDLER =========== */
document.querySelectorAll("button:has(svg > use[svg-icon-name='PlayPauseIcon'])").forEach(_btn => _btn.addEventListener('click', playStop, false)); //handler for the two Play/Pause buttons

prevBtn.addEventListener('click', () => playNextPrev(0), false);
nextBtn.addEventListener('click', () => playNextPrev(1), false);

function playStop() {
	//readyState = 4: video is playing
	if(xAudio.paused) {
		xAudio.play();
		//tryingLoadAudio();
		// showSplashMsg("Playing...");
	}
	else {
		xAudio.pause();
		// showSplashMsg("Paused!!!");
	}
}

//isNext = 1: playing next, 0 or missing: playing previous
function playNextPrev(isNext) {
	let currentStt = parseInt(elmPlaylist.getAttribute("attr-Value"));
	if(isNaN(currentStt)) currentStt = 1;
	let chapLength = parseInt(elmPlaylist.getAttribute("attr-Length"));
	if(isNaN(chapLength)) chapLength = elmPlaylist.querySelectorAll("li").length;

	if(isNext){
		if(currentStt < chapLength){
			changeChap(currentStt+1); //if not the very last chapter, play the next one
			
		} else showToastMsg("Đã là chương cuối rồi!");
	}
	else{
		// if audio current time before 30 sec, will play previous chapter
		if(currentStt > 1 && xAudio.currentTime < 30){
			changeChap(currentStt-1);
		}
		// if audio current time after 30 sec, seek to the beginning of current chapter
		else xAudio.currentTime = 0;
	}
}

reloadBtn.addEventListener('click', reloadSrc, false);
function reloadSrc(_forcePause){
	if(!navigator.onLine){
		showToastMsg("Không có kết nối Internet");
		return;
	}
	let _currTime = xAudio.currentTime;
	if(!_currTime) _currTime = 0;
	xAudio.load();
	xAudio.currentTime = _currTime;

	if(_forcePause) xAudio.pause();
}

/* Display Play/Pause/Loading icons and enable/disable for play-pause button depending on playing state of audio element. The fastforward, rewind button got enable/disable accordingly 
	_playIconType: 
		-1: show spinning loading icon, and the same time, disable all 3 buttons
		 0 - show Pause icon on play-pause button
		 1 - show Play icon on play-pause button
	_disableButton: enable/disable 3 buttons
		-1: do nothing
		 0: disable
		 1: enable

*/
var switchPlayPauseButton = (_playIconType, _disableButton) => {
	
	//change link to svg icon for PlayPause buttons
	document.querySelectorAll("[svg-icon-name='PlayPauseIcon']").forEach(_elm => {
		_elm.setAttribute("href", _playIconType === -1? "#icnSvgSpinWaiting": ( (_playIconType === 1? "#icnSvgPlay" : "#icnSvgPause") + (xState.disableCircleProgressButton?"":"Progress") ) );
	});

	if(_disableButton === undefined) _disableButton = -1;
	if(_playIconType === -1) _disableButton = 0;
	//change state for PlayPause buttons
	if(_disableButton !== -1){
	document.querySelectorAll("button:has(svg > use[svg-icon-name='PlayPauseIcon'])").forEach(_elm => {
		_elm.classList.toggle("elm-disabled", _disableButton === 0);
	}); 

	//change state for Rewind buttons
	document.querySelectorAll("button.ap-rewind-btn").forEach(_elm => {
		_elm.classList.toggle("elm-disabled", _disableButton === 0);
	}); 

	//change state for Fastforward buttons
	document.querySelectorAll("button.ap-fastforward-btn").forEach(_elm => {
		_elm.classList.toggle("elm-disabled", _disableButton === 0);
	}); 
	};
}

/* Switch appearance of Playing time 
_state {integer}: how playing time would be show up
	-1: internet connection lost, showing "No internet" on playingTime Elem
	 0: show spinning clock to tell user that chapter is loading
	 1: show current time / duration telling that audio is playing
*/
function switchBigPlayingTime(_state){
	elmPlayingTime.classList[_state == 0? "add": "remove"]("elm-hidden");
	document.querySelector("div[name='HourglassSpining']").classList[_state == 0? "remove": "add"]("elm-hidden");
	if(_state === -1) elmPlayingTime.innerHTML = "No Internet";
}
/* ========== AUDIO SPEED LIST ========== */

/* Create Speed combobox with default options */
let elmSltSpeed = document.querySelector(".ap-speed-option-select");
document.querySelector(".ap-speed-decrease-speed").addEventListener('click', () => insertSpeed(false), false);
document.querySelector(".ap-speed-increase-speed").addEventListener('click', () => insertSpeed(true), false);

(function populateSpeedList() {
    var _defSpd = [0.5,0.75,1.0,1.1,1.2,1.25,1.3,1.35,1.4,1.45,1.5,1.75,2,2.95]; //store old options of combobox
	elmSltSpeed.innerHTML = "";// .options.length = 0; //clear the combobox
	
    for (let i = 0; i < _defSpd.length; i++) {
		let opt = document.createElement('option');
		opt.value = _defSpd[i];
		//If integer, need to add .0
		opt.innerHTML = Number.isInteger(_defSpd[i])? _defSpd[i] + ".0x" : _defSpd[i] + "x"; 
		if(_defSpd[i]==1){
			//opt.innerHTML = "1.0x"; //"Normal";
			opt.style["background-color"] = "#e5e161";
		}
		elmSltSpeed.appendChild(opt);
    }

	//handling onChange event
	elmSltSpeed.onchange = _ => {
		showToastMsg("✕ " + elmSltSpeed.value);
		changeAudioSpeed(); //change audio playbackRate accordingly
		localStorage.setItem('speed', xAudio.playbackRate); //save new speed to Storage

		//resize elmSltSpeed width with the content of selected item
		var _sel = document.createElement('select');
		_sel.css({"font-size":elmSltSpeed.css("font-size")}); //copy font-size from elmSltSpeed to _sel
		let _spd = elmSltSpeed.value;
		if ( Number.isInteger(parseFloat(_spd)) ) _spd = _spd + ".0";
		_sel.innerHTML = "<option>" + _spd + "</option>";
		document.body.appendChild(_sel);
		elmSltSpeed.style.width = (_sel.offsetWidth-12) + "px";
		_sel.remove();

		//update the actual current chapter listenning time and total book listenning time with the change of playback speed
		document.querySelectorAll("[attr-duration]").forEach(elm => {
			let _duraion = elm.getAttribute("attr-duration");
			if(!_duraion) return;
			elm.querySelector("[role='listeningTime']").innerText = toHhMmSs(_duraion/xAudio.playbackRate);
		});
	}
})();

/* Insert Speed option to combobox 
speed: true/false - increase/decrease speed by 0.05
		number: the new speed
*/
function insertSpeed(speed) {
	let newSpeed = 1;
	if(typeof(speed) == "number") newSpeed = speed;
	if(typeof(speed) == "boolean") newSpeed = Math.round( (parseFloat(elmSltSpeed.value) + (speed? 0.05 : - 0.05)) * 100 ) / 100;
	
	//Check if new speed was already there in the speed listbox
	if(elmSltSpeed.querySelector('[value="' + newSpeed + '"]')){
		xAudio.playbackRate = elmSltSpeed.value = newSpeed; //select the new speed then out
		elmSltSpeed.onchange(); //onchange event is not automatically raised, so we need to call manually
		return;
	}

    // search right location to add newSpeed
	let i=0;
    while (i < elmSltSpeed.options.length && parseFloat(elmSltSpeed.options[i].value) < newSpeed) {
		i++;
    }
	//add new speed before location just found
	elmSltSpeed.add(new Option(Number.isInteger(parseFloat(newSpeed)) ? newSpeed + ".0x" :newSpeed + "x", newSpeed), i); //text, value
	
	xAudio.playbackRate = elmSltSpeed.value = newSpeed;
	elmSltSpeed.onchange(); //onchange event is not automatically raised, so we need to call manually
}

/* This function is invoked on onratechange event of audio element, and onchange event of speed dropdown element*/
function changeAudioSpeed() {
	if(xAudio.playbackRate != parseFloat(elmSltSpeed.value)) {
		//showSplashMsg("Speed " + s.value);
		xAudio.playbackRate = parseFloat(elmSltSpeed.value);
	}
}

// Restore speed from last time running page, and insert it if it is not in defaul playbackRate list
(()=> {
	
	insertSpeed(jsonOption.speed); //this also make speed s in elmPlaybackSpeed to be selected and the same time change xAudio playbackRate to s. So, we need no further action for speed
})();

/* ========== BUFFER BAR & TIME DISPLAY ========== */
if(xState.hideBufferBar) bufferBarCanvas.classList.add("elm-hidden");
clearBufferBar(); //initialize the UI of buffer bar
function clearBufferBar(){
	//if(xState.hideBufferBar) return;

	//if it is hidden when listening last chapter, then it is already cleaned
	if(bufferBarCanvas.classList.contains("elm-hidden")) {
		return;
	}
	else bufferBarCanvas.classList.add("elm-hidden"); //hide it, will show it again when user seek the audio

	let context = bufferBarCanvas.getContext('2d');

	context.clearRect(0, 0, bufferBarCanvas.width, bufferBarCanvas.height);
    context.fillStyle = '#bdbdbd'; //'lightgray';
    context.fillRect(0, 0, bufferBarCanvas.width, bufferBarCanvas.height);
}

function updateBufferCanvas(){
	//if user don't want to show buffer bar, do nothing
	if(xState.hideBufferBar) return;

	//show buffer bar if it is hidden
	if(bufferBarCanvas.classList.contains("elm-hidden"))
	bufferBarCanvas.classList.remove("elm-hidden"); 

	let context = bufferBarCanvas.getContext('2d');
	var inc = bufferBarCanvas.width / xAudio.duration;

	// if fillStyle not the one that assigned in clearBufferBar, it means the buffer bar has not been clean for the new one, so we need to redraw blank buffer bar
	if(context.fillStyle !== '#bdbdbd') {
		context.clearRect(0, 0, bufferBarCanvas.width, bufferBarCanvas.height);
		context.fillStyle = '#bdbdbd'; //'lightgray';
		context.fillRect(0, 0, bufferBarCanvas.width, bufferBarCanvas.height);
	}

	context.fillStyle = '#0062ff'; //cadetblue	darkgoldenrod crimson #f50
    context.strokeStyle = '#bdbdbd'; //white

	//clearBufferBar();

    // display TimeRanges
	for (i = 0; i < xAudio.buffered.length; i++) {
		var startX = xAudio.buffered.start(i) * inc;
		var endX = xAudio.buffered.end(i) * inc;

		context.fillRect(startX, 0, endX, bufferBarCanvas.height);
		context.rect(startX, 0, endX, bufferBarCanvas.height);
		context.stroke();
	}
}

/* ========== PROGRESS BAR & TIME DISPLAY ========== */
let progressWrapper = progressBar.parentNode.parentNode;
progressWrapper.addEventListener('mousedown', progressbarMD, false);
progressWrapper.addEventListener('mousemove', progressbarMM, false);
document.documentElement.addEventListener('mouseup', seekingDone, false); //it must be documentElement to handle MouseUp because when user move the mouse, the mouse might go outside of progressWrapper.
//progressWrapper.addEventListener('mouseup', seekingDone, false);

  function moveBar(evt, el, dir) {
    var value;
    if(dir === 'horizontal') {
      value = Math.round( ((evt.clientX - el.offset().left) + window.pageXOffset) * 100 / el.parentNode.offsetWidth);
      el.style.width = value + '%';
      return value;
    }
    else {
      var offset = (el.offset().top + el.offsetHeight)  - window.pageYOffset;
      value = Math.round((offset - evt.clientY));
      if(value > 100) value = 100;
      if(value < 0) value = 0;
      volumeBar.style.height = value + '%';
      return value;
    }
  }

  function progressbarMD(evt) {
	// console.log("Mouse down");
    rightClick = (evt.button === 2) ? true : false; //evt.which === 3, evt.which was deprecated
	isPlaying = !xAudio.paused; //flag to know if audio is playing
	console.log(isPlaying);
	if(isPlaying) xAudio.pause(); //if audio is playing, pause it so lots of temporary audio buffering, seeking,... is NOT invoked while seeking, that make the seeking perfectly smooth

    isSeeking = true;
	evt.preventDefault();
    progressbarMM(evt);
  }

  function progressbarMM(evt) {
	// console.log("Mouse move");
    if(isSeeking && rightClick === false && xAudio.readyState !== 0) {
      var value = moveBar(evt, progressBar, 'horizontal');
      xAudio.currentTime = xAudio.duration * (value / 100);
    }
  }

  function seekingDone(){
	// console.log("Mouse up");
	if(isPlaying && isSeeking) xAudio.play(); //audio, which was on playing, was paused for smooth seeking, now have to turn it back to playing
	isSeeking = false; //turf off flag to mark the (progress and volume) seeking has finished
  }
  
  /* TOUCH EVENT */
progressWrapper.addEventListener('touchstart', progressbarTS, false);
progressWrapper.addEventListener('touchmove', progressbarTM, false);
//document.documentElement
progressWrapper.addEventListener('touchend', seekingDone, false);
progressWrapper.addEventListener('touchcancel', seekingDone, false);

let _progressbarLeft; //progress bar left value relative to the browser's viewport

function progressbarTS(e) {
	//there are bunch of way to calculate this, depend on if there is scrollbar or not. Simply the most, I use this formula, hope it works.
	_progressbarLeft = progressBar.getBoundingClientRect().left; //progressBar.offset().left
	isPlaying = !xAudio.paused; //flag to know if audio is playing
	if(isPlaying) xAudio.pause(); //if audio is playing, pause it so lots of temporary audio buffering, seeking,... is NOT invoked while seeking, that make the seeking perfectly smooth
	isSeeking = true; //turn on flag showing that starting touch & move
    progressbarTM(e);
}

function touchMoveBar (e, el, dir) {
  var value;
  if(dir === 'horizontal') {
	value = Math.round( (e.changedTouches[0].clientX - _progressbarLeft) * 100 / el.parentNode.offsetWidth);
	
	// console.log(`${_progressbarLeft} - ${el.parentNode.offsetWidth}`);
	// console.log(`touch-move: clientX=${touch.clientX} ~ ${value}`);

	//in case move over the progress bar
	if(value > 100) value = 100;
	if(value < 0) value = 0;
	el.style.width = value + '%';
  }
  else{
	/* Currently, I don't want to implement for vertical volume bar
	const diffY = touch.clientY - startY;
	value = Math.round( (el.offsetTop + diffY) * 100 / el.parentNode.offsetHeight  );
	if(value > 100) value = 100;
	if(value < 0) value = 0;
	volumeBar.style.height = value + '%'; */
  }

  e.preventDefault();
  return value;
}

function progressbarTM(evt) {
    if(isSeeking && xAudio.readyState !== 0) {
      var value = touchMoveBar(evt, progressBar, 'horizontal');
      xAudio.currentTime = xAudio.duration * (value / 100);
    }
  }

let elmRoot = document.querySelector('[name="divContainer"]'); // root element to update circle progress around Pause button, see updateTime() function
//let svgCircleElems = document.querySelectorAll("#svgProgressCircle");
/* Draw the Circle ProgressBar surround the play and pause buttons. There are two ways to archive this, old way (seems very costly) is usage of --audio-playing-current-progress-percent variable in root element. 
2nd way, using js to change directly to svg "stroke-dashoffset" attribute. However, this way make play/pause button sometime irreresponsive
  currPercent {float from 0 to 1}: the current percentage of playing
 */
function updateCircleProgressBar(currPercent) {
	let _prgress = 383; //default value, which make progress go to 0%
	if(isFinite(currPercent)) //currPercent is not infinity or NaN
		_prgress = parseInt( (1 - currPercent) * 383 ); //383 is value of stroke-dasharray which is circumstance of a circle having radius of 61. See svg symbol having id="icnSvgPlayProgress"
	
	//svgCircleElems.forEach(_cir => _cir.setAttribute("stroke-dashoffset", _prgress + 'px'));
	elmRoot.style.setProperty('--audio-playing-current-progress-percent', _prgress + 'px');
}
 /* This function is called on audio timeUpdate event which happens 4 times a seconds. This function is in charge of updating UI for the audio */
function updateTime() {
	// this is to prevent override "No Internet" message when connection lost
	if(xAudio.readyState < HTMLMediaElement.HAVE_FUTURE_DATA) return; //there is no data for next frame (google 'audio readyState mdn' for more)

	/* // to get real duration to update to xData
	if(!window["durs"]) window["durs"]={};
	durs[xAudio.attr("chap")] = toHhMmSs(xAudio.duration);  */

	//saveLastPosition(); //this works very well but might put too much burden on computer
	if(document.hidden) return; //if page is currently not on user's view, stop all UI update

	let _currTime = xAudio.currentTime, _duration = xAudio.duration;
    var barlength = Math.round(_currTime * (100 / _duration));
    progressBar.style.width = barlength + '%';

	let _remTime = _duration - _currTime;
    remTime.innerHTML = toHhMmSs(_remTime) + " / " + toHhMmSs(_remTime/xAudio.playbackRate); //remaining time

    elmPlayingTime.innerText = toHhMmSs(_currTime) + " / " + toHhMmSs(_duration); //big font playing time
	
	// Update preload progress bar
	var buffered = xAudio.buffered;
    if(buffered.length) {
      /* var loaded = Math.round(100 * buffered.end(0) / _duration);
      preloadBar.style.width = loaded + '%'; //buffer bar */
	  for (let i = 0; i < buffered.length; i++) {
        if (buffered.start(buffered.length - 1 - i) < _currTime) {
			preloadBar.style.width = `${ (buffered.end(buffered.length - 1 - i) * 100) /_duration}%`;
          break;
        }
	  }
    }
	
	if(!xState.disableCircleProgressButton){ //will not update circle progress for lighter burden on the page performance
		updateCircleProgressBar(_currTime/_duration);		
	}
	
  }

  
/* ==========  VOLUME BUTTON & BAR  ========== */
volumeBtn.addEventListener('click', volumeToggle, false);
let volumeWrapper = volumeBar.parentNode.parentNode;
volumeWrapper.addEventListener('mousedown', volumebarMD, false);
volumeWrapper.addEventListener('mousemove', volumebarMM);
document.documentElement.addEventListener('mouseup', seekingDone, false);
//volumeWrapper.addEventListener('mouseup', seekingDone, false);

volumeBar.style.height = xAudio.volume * 100 + '%';
volumeLength = volumeBar.css('height');

function volumeToggle() {
    if(xAudio.muted) {
      if(parseInt(volumeLength, 10) === 0) {
        volumeBar.style.height = '100%';
        xAudio.volume = 1;
      }
      else {
        volumeBar.style.height = volumeLength;
      }
      xAudio.muted = false;
      this.classList.remove('muted');
    }
    else {
      xAudio.muted = true;
      volumeBar.style.height = 0;
      this.classList.add('muted');
    }
  }
  
function volumebarMD(evt) {
	rightClick = (evt.button === 2) ? true : false; //evt.which === 3, evt.which was deprecated
	isSeeking = true;
	volumebarMM(evt);
}

function volumebarMM(evt) {
	volumeLength = volumeBar.css('height');
	if(isSeeking && rightClick === false) {
	var value = moveBar(evt, volumeBar.parentNode, 'vertical') / 100;
	if(value <= 0) {
	xAudio.volume = 0;
	volumeBtn.classList.add('muted');
	}
	else {
	if(xAudio.muted) xAudio.muted = false;
	xAudio.volume = value;
	volumeBtn.classList.remove('muted');
	}
}
}

/*===== *  Helpers *=====*/ 
function extend(defaults, options) {
    for(var name in options) {
      if(defaults.hasOwnProperty(name)) {
        defaults[name] = options[name];
      }
    }
    return defaults;
  }

Element.prototype.offset = function() {
    var el = this.getBoundingClientRect(),
    scrollLeft = window.pageXOffset || document.documentElement.scrollLeft,
    scrollTop = window.pageYOffset || document.documentElement.scrollTop;

    return {
      top: el.top + scrollTop,
      left: el.left + scrollLeft
    };
  };

/* ==========  PUBLIC METHODS  ========== */
return {
	//playAudio: tryingLoadAudio,
	updateTime : updateTime, // for update UI when the page got focus again
	loadSrc : loadSrc
};
}
</script>

<!-- SVG ICONS LIBRARY -->
<svg width="0" height="0" class="elm-hidden" id="core-svg-icon" xmlns="http://www.w3.org/2000/svg">
	<symbol id="icnSvgRunJumping" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 105.74 122.88">
		<path d="M3.07 79.92c4.32 1.19 29.57 17.12 32.69 10.85.32-.64 2.87-6.24 2.87-6.27l13.62 3.47c.44 1.39-5.97 12.95-7.23 14.27-1.6 1.68-3.21 2.68-4.93 3.57C34.31 108.79 6.82 94.12 0 93.16zm72.78 39.9c.63.24.89 1.1.58 1.93s-1.07 1.31-1.7 1.07l-18.78-7.03c-.63-.24-.89-1.1-.58-1.93s1.07-1.31 1.7-1.07zm10.94-7.69c.63.24.89 1.1.58 1.93s-1.07 1.31-1.7 1.07l-18.78-7.03c-.63-.24-.89-1.1-.58-1.93s1.07-1.31 1.7-1.07zm.33-11.66c.63.24.89 1.1.58 1.93s-1.07 1.31-1.7 1.07l-18.78-7.03c-.63-.24-.89-1.1-.58-1.93s1.07-1.31 1.7-1.07zM22.26 22.99c-.66-.15-1.03-.97-.83-1.83.19-.86.88-1.44 1.54-1.29l19.56 4.41c.66.15 1.03.97.83 1.83-.19.86-.88 1.44-1.54 1.29zm-2.47-10.86c-.66-.15-1.03-.97-.83-1.83.19-.86.88-1.44 1.54-1.29l19.56 4.41c.66.15 1.03.97.83 1.83-.19.86-.88 1.44-1.54 1.29zm5.9-8.98c-.66-.15-1.03-.97-.84-1.83s.88-1.44 1.54-1.29l19.56 4.41c.66.15 1.03.97.83 1.83-.19.86-.88 1.44-1.54 1.29zm13.28 44.06-2.86 17.67c-.58 6.69-.63 11.89 5.95 15 3.44 1.62 4.32 1.42 8.12 2.06l19.27-.42c1.04-.02 26.34 11.02 28.43 12.43l7.83-9.36c1.1-1.31-25.7-14.04-29.63-15.46-18.65-6.72-20.64 10.5-16.9-15.51 3.75 2.9 6.93 3.62 13.62 5.39 8.01 1.1 11.41-.86 17.65-3.7l9.22-4.57-7.14-10.84-7.05 4.2c-.26.12-.92.45-2.08 1.01-2.92 1.07-5.25 1.95-7.25 1.26-6.64-2.32-12.06-12.07-29.81-11.45-24.69.86-22.32-2.09-38.63 17.42l9.79 7.55c7.7-9.21 8.39-11.43 20.79-12.61.23-.04.45-.05.68-.07M59.12 9.04c6.83-3.12 14.89-.11 18 6.72 3.12 6.83.11 14.89-6.72 18-6.83 3.12-14.89.11-18-6.72-3.12-6.83-.11-14.89 6.72-18"/>
	</symbol>
	<symbol id="icnSvgJumpToChapter" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 500 512.24">
		<path d="M65.5 0h315.71c6.94 0 12.61 5.68 12.61 12.63v157.15c-23.99-12.13-50.71-18.61-78.16-18.61-23.45 0-45.88 4.68-66.32 13.18A172.7 172.7 0 0 0 193.06 202c-45.13 45.11-61.73 111.81-43.51 172.45h-88.7c-19 0-34.53 15.55-34.53 34.53 0 19 15.55 34.54 34.53 34.54h128.59l3.6 3.7c8.17 8.17 17.05 15.43 26.51 21.73H62.16C27.97 468.95 0 440.99 0 406.8V65.51C0 29.48 29.47 0 65.5 0m253.98 185.1c38.15 0 74.59 15.1 101.56 42.06 37.26 37.26 51.12 92.19 36.11 142.62a142.8 142.8 0 0 1-14.59 33.02l55.63 60.63a6.89 6.89 0 0 1-.4 9.71l-40.85 37.3c-2.79 2.56-7.13 2.36-9.69-.43l-53.21-58.53c-22.53 13.73-48.17 20.89-74.56 20.89-38.15 0-74.59-15.1-101.56-42.07a143.9 143.9 0 0 1-31.17-46.64c-22.26-53.62-9.61-115.7 31.19-156.48 13.19-13.22 29-23.88 46.61-31.17 16.94-7.04 35.51-10.91 54.93-10.91m81.04 62.59c-32.71-32.72-82.29-42.55-124.89-24.9-76.44 31.65-94 130.21-37.21 186.97 32.77 32.69 82.24 42.57 124.9 24.91 42.88-17.81 70.76-59.52 70.76-105.94 0-15.55-3.07-30.38-8.65-43.83-5.82-14-14.33-26.63-24.91-37.21M58.17 416.08h106.68l1.9 2.92c2.34 3.48 4.79 6.87 7.34 10.16H58.17c-2.75 0-5.02-2.25-5.02-5.01v-3.05c0-2.75 2.25-5.02 5.02-5.02m0-25.9h92.97c1.87 4.43 3.95 8.8 6.23 13.08h-99.2c-2.75 0-5.02-2.25-5.02-5.01v-3.05c0-2.77 2.25-5.02 5.02-5.02m19.5-339.05h10.91c5.59 0 10.15 3.69 10.15 8.21v257.5c0 4.51-4.57 8.2-10.15 8.2H77.67c-5.58 0-10.14-3.69-10.14-8.2V59.33c0-4.51 4.56-8.2 10.14-8.2"/>
	</symbol>
	<symbol id="icnSvgMinusSign" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
		<g transform="matrix(0.22 0 0 0.22 12 12)">
			<path transform=" translate(-50, -50)" d="M 94.75 50 C 94.75 56.213 89.514 61.25 83.054 61.25 L 16.946 61.25 C 10.486 61.25 5.25 56.213 5.25 50 L 5.25 50 C 5.25 43.787 10.486 38.75 16.945999999999998 38.75 L 83.053 38.75 C 89.514 38.75 94.75 43.787 94.75 50 L 94.75 50 z"/>
		</g>
	</symbol>
	<symbol id="icnSvgPlusSign" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
		<g transform="matrix(0.22 0 0 0.22 12 12)">
			<path transform="translate(-50, -50)" d="M 40.747 13.955 L 59.254000000000005 13.955 C 60.353 13.955 61.242000000000004 14.845 61.242000000000004 15.941 L 61.242000000000004 38.787 L 84.08600000000001 38.787 C 85.18400000000001 38.787 86.07000000000001 39.675 86.07000000000001 40.772999999999996 L 86.07000000000001 59.226 C 86.07000000000001 60.324999999999996 85.183 61.211999999999996 84.08600000000001 61.211999999999996 L 61.242 61.211999999999996 L 61.242 84.05799999999999 C 61.242 85.157 60.352 86.044 59.254 86.044 L 40.747 86.044 C 39.652 86.044 38.762 85.15599999999999 38.762 84.05799999999999 L 38.762 61.213 L 15.915 61.213 C 14.819999999999999 61.213 13.93 60.325 13.93 59.227000000000004 L 13.93 40.773 C 13.93 39.67400000000001 14.82 38.787000000000006 15.915 38.787000000000006 L 38.762 38.787000000000006 L 38.762 15.941 C 38.762 14.845 39.651 13.955 40.747 13.955 z"/>
		</g>
	</symbol>
	<!-- Audio controls icons -->
	<symbol id="icnSvgReload" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 122.88 118.66">
		<path
       d="M 16.68,22.2 C 14.9,24.41 13.25,26.75 11.62,29.66 5.63,40.31 3.1,52.39 4.13,64.2 5.14,75.74 9.56,87.03 17.5,96.47 c 2.85,3.39 5.91,6.38 9.13,8.97 11.11,8.93 24.28,13.34 37.41,13.22 13.13,-0.12 26.21,-4.78 37.14,-13.98 3.19,-2.68 6.18,-5.73 8.91,-9.13 6.4,-7.96 10.51,-17.29 12.07,-27.14 1.53,-9.67 0.59,-19.83 -3.07,-29.66 C 115.6,29.4 110.27,21.07 103.31,14.54 96.7,8.33 88.59,3.76 79.2,1.48 76.26,0.77 73.26,0.3 70.21,0.11 c -3.06,-0.2 -6.19,-0.13 -9.4,0.22 -2.01,0.22 -3.46,2.03 -3.24,4.04 0.22,2.01 2.03,3.46 4.04,3.24 2.78,-0.31 5.49,-0.37 8.14,-0.19 2.65,0.17 5.23,0.57 7.73,1.17 8.11,1.96 15.1,5.91 20.84,11.29 6.14,5.75 10.85,13.12 13.94,21.43 3.21,8.61 4.04,17.51 2.7,25.96 -1.37,8.58 -4.96,16.73 -10.56,23.69 -2.47,3.07 -5.12,5.78 -7.91,8.13 -9.59,8.07 -21.03,12.15 -32.5,12.26 -11.47,0.11 -23,-3.76 -32.76,-11.61 C 28.33,97.41 25.61,94.76 23.1,91.77 16.18,83.55 12.33,73.68 11.45,63.57 10.54,53.19 12.77,42.58 18.02,33.24 19.61,30.42 21.23,28.17 23.03,26 l 0.53,14.7 c 0.07,2.02 1.76,3.6 3.78,3.53 2.02,-0.07 3.6,-1.76 3.53,-3.78 L 30.02,17.03 c -0.07,-2.02 -1.76,-3.59 -3.78,-3.52 -0.13,0.01 -0.25,0.02 -0.37,0.03 v 0 l -22.7,3.19 c -2,0.28 -3.4,2.12 -3.12,4.13 0.28,2 2.12,3.4 4.13,3.12 z M 98.2393,58.71 42.72725,89.104525 42.282275,31.187 Z"/>
	</symbol>
	<symbol id="icnSvgPlay" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
		<path d="m10 16.5 6-4.5-6-4.5v9zM12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/>
	</symbol>
	<symbol id="icnSvgPause" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
		<path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 14H9V8h2v8zm4 0h-2V8h2v8z"/>
	</symbol>
	<symbol id="icnSvgFastForward" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
		<path d="M256 0c70.69 0 134.7 28.66 181.02 74.98C483.34 121.31 512 185.32 512 256.01c0 70.68-28.66 134.69-74.98 181.01C390.7 483.34 326.68 512 256 512s-134.69-28.66-181.02-74.98C28.66 390.7 0 326.69 0 256.01c0-70.68 28.66-134.7 74.98-181.03C121.31 28.66 185.32 0 256 0zm110.47 269.8c10.3-9.17 10.02-17.33 0-26.62l-86.09-76.78c-11.21-7.03-22.9-2.9-22.59 11.73l.12 43.14-61.54-54.87c-11.2-7.03-22.89-2.9-22.59 11.73l.45 154.47c.96 15.86 10.01 20.21 23.37 12.87l60.51-53.95.12 41.08c.96 15.86 10.01 20.21 23.36 12.87l84.88-75.67zm46.28-170.55C372.64 59.15 317.22 34.33 256 34.33S139.36 59.15 99.26 99.25c-40.11 40.11-64.93 95.55-64.93 156.76 0 61.21 24.82 116.63 64.93 156.74 40.1 40.1 95.52 64.92 156.74 64.92 61.21 0 116.64-24.82 156.75-64.92 40.1-40.11 64.92-95.53 64.92-156.74 0-61.23-24.82-116.65-64.92-156.76z"/>
	</symbol>
	<symbol id="icnSvgSkipNext" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
		<path d="M255.99 0c70.68 0 134.7 28.66 181.02 74.98C483.33 121.3 512 185.31 512 256c0 70.68-28.67 134.69-74.99 181.01C390.69 483.33 326.67 512 255.99 512S121.3 483.33 74.98 437.01C28.66 390.69 0 326.68 0 256c0-70.67 28.66-134.7 74.98-181.02C121.3 28.66 185.31 0 255.99 0zm53.25 163.2h29.85c5.65 0 10.27 4.66 10.27 10.28v165.04c0 5.62-4.65 10.28-10.27 10.28h-29.85c-5.63 0-10.28-4.63-10.28-10.28V173.48c0-5.65 4.63-10.28 10.28-10.28zm-41.69 106.6c10.29-9.17 10.01-17.33 0-26.62l-82.3-76.78c-11.21-7.03-22.9-2.9-22.59 11.73l.44 154.47c.97 15.86 10.01 20.21 23.37 12.87l81.08-75.67zM412.74 99.25c-40.1-40.1-95.54-64.92-156.75-64.92-61.21 0-116.63 24.82-156.74 64.92-40.1 40.11-64.92 95.54-64.92 156.75 0 61.22 24.82 116.64 64.92 156.74 40.11 40.11 95.53 64.93 156.74 64.93 61.21 0 116.65-24.82 156.75-64.93 40.11-40.1 64.93-95.52 64.93-156.74 0-61.22-24.82-116.64-64.93-156.75z"/>
	</symbol>
	<symbol id="icnSvgChapterLinks" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 122.88 95.19">
		<path d="M11.7 0h6.19v2.07c15.49 3.54 17.26 11 8.28 22.7.95-11.63-.22-14.12-8.28-14.66v29.4a4 4 0 0 1 0 .47c0 3.82-4 7.61-8.95 8.47S0 46.9 0 43.07c0-5.21 7.16-9.74 11.7-8.14zM103 0h6.19v2.07c15.48 3.54 17.25 11 8.27 22.7 1-11.63-.22-14.12-8.27-14.66v29.87c0 3.82-4 7.61-9 8.47s-9-1.55-9-5.38c0-5.21 7.16-9.74 11.7-8.14V0ZM70.51 68.64a11.3 11.3 0 0 1 4.5.08V37.13l-33.43 9.59v37.3c0 5.82-6.42 10.06-11.57 11-6.39 1.1-11.58-2-11.58-7S23.65 78.18 30 77.08a13 13 0 0 1 6.49.42V32.34l43.54-9.91v50.88c.48 5.4-5 9.49-9.56 10.28-5.34.92-9.66-1.68-9.66-5.81s4.32-8.22 9.66-9.14Z"/>
	</symbol>
	<symbol id="icnSvgSwitchChapterLinks" xmlns="http://www.w3.org/2000/svg" viewBox="64 64 896 896">
		<path d="M768 768v64h78.7A190.1 190.1 0 0 1 704 896a192.2 192.2 0 0 1-192-192h-64a255.5 255.5 0 0 0 448 168.5V960h64V768zm-64-320a257.3 257.3 0 0 0-192 87.5V448h-64v192h192v-64h-78.7A190.1 190.1 0 0 1 704 512a192.2 192.2 0 0 1 192 192h64a256.3 256.3 0 0 0-256-256"/>
		<path d="M384 896H192V768h64v-64h-64V544h64v-64h-64V320h64v-64h-64V128h576v256h64V128a64 64 0 0 0-64-64H192a64 64 0 0 0-64 64v128H64v64h64v160H64v64h64v160H64v64h64v128a64 64 0 0 0 64 64h192Z"/>
	</symbol>
	<symbol id="icnSvgPlayProgress"  xmlns="http://www.w3.org/2000/svg" viewBox="0 0 142 142">
		<g transform="rotate(-90 71 71)">
			<circle r="61" cx="71" cy="71" fill="transparent" stroke="var(--audio-playing-current-progress-remained-color)" stroke-width="16px" stroke-dasharray="383.08000000000004px" stroke-dashoffset="0"/>
			<circle id="svgProgressCircle" r="61" cx="71" cy="71" stroke="var(--audio-playing-current-progress-played-color)" stroke-width="16px" stroke-linecap="round" stroke-dashoffset="var(--audio-playing-current-progress-percent)" fill="transparent" stroke-dasharray="383.08000000000004px"/>
		  </g>
		  <polygon transform="translate(53 32), scale(0.6)" style="fill-rule:evenodd;clip-rule:evenodd;" points="92.2,60.97 0,122.88 0,0 92.2,60.97"/>
	</symbol>
	<symbol id="icnSvgPauseProgress"  xmlns="http://www.w3.org/2000/svg" viewBox="0 0 142 142">
		<path transform="translate(14.95 14.9), scale(0.915)" style="fill-rule:evenodd;clip-rule:evenodd;" d="M61.44,0c33.93,0,61.44,27.51,61.44,61.44c0,33.93-27.51,61.44-61.44,61.44S0,95.37,0,61.44 C0,27.51,27.51,0,61.44,0L61.44,0z M68.16,33.88H84.1V89l-15.94,0V33.88L68.16,33.88L68.16,33.88z M38.78,33.88h15.94V89l-15.94,0 V33.88L38.78,33.88L38.78,33.88z"/>
		<g transform="rotate(-90 71 71)">
			<circle r="61" cx="71" cy="71" fill="transparent" stroke="var(--audio-playing-current-progress-remained-color)" stroke-width="10" stroke-dasharray="383.08000000000004px" stroke-dashoffset="0"/>
			<circle id="svgProgressCircle" r="61" cx="71" cy="71" stroke="var(--audio-playing-current-progress-played-color)" stroke-width="10" stroke-linecap="round" stroke-dashoffset="var(--audio-playing-current-progress-percent)" fill="transparent" stroke-dasharray="383.08000000000004px"/>
		</g>
		
	</symbol>
	<symbol id="icnSvgVolumeOn" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16">
		<path d="M7 1.008a.99.99 0 0 0-.77.351L3 5H2C.906 5 0 5.844 0 7v2c0 1.09.91 2 2 2h1l3.23 3.64A.97.97 0 0 0 7 15zm6.46.96a1 1 0 0 0-.558.169 1.005 1.005 0 0 0-.27 1.39 7.995 7.995 0 0 1 0 8.946 1.005 1.005 0 0 0 .27 1.39 1.005 1.005 0 0 0 1.391-.27 10.015 10.015 0 0 0 0-11.187 1 1 0 0 0-.832-.437m-3.42 2.02A1.004 1.004 0 0 0 9 4.996v.059a.95.95 0 0 0 .2.535 4 4 0 0 1 0 4.816.97.97 0 0 0-.2.535v.063c0 .305.133.605.395.805a1 1 0 0 0 1.398-.2A5.98 5.98 0 0 0 12 8a6 6 0 0 0-1.207-3.613 1 1 0 0 0-.754-.399m0 0" />
	</symbol>
	<symbol id="icnSvgVolumeOff" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16">
		<path d="M7 1.008a.99.99 0 0 0-.77.351L3 5H2C.906 5 0 5.844 0 7v2c0 1.09.91 2 2 2h1l3.23 3.64A.97.97 0 0 0 7 15zM10 5a1 1 0 0 0-.707 1.707L10.586 8 9.293 9.293a1 1 0 1 0 1.414 1.414L12 9.414l1.293 1.293a1 1 0 1 0 1.414-1.414L13.414 8l1.293-1.293a1 1 0 1 0-1.414-1.414L12 6.586l-1.293-1.293A1 1 0 0 0 10 5m0 0"/>		
	</symbol>
	<symbol id="icnSvgJump2PlayingChap" xmlns="http://www.w3.org/2000/svg" viewBox="3.74 4.53 16.35 14.79">
		<path d="M8.694 7.625V6.003h9.782v11.854H8.859v-1.292H7.238v2.761h12.859V4.534H7.073v3.09z"/>
		<path d="m16.45 11.932-2.865 2.64-2.851 2.64v-3.24H3.742V9.71h6.992V6.65l2.851 2.642z"/>
	</symbol>

	<!-- Other icons -->
	<symbol id="icnSvgAudioSpeed" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 240 240">
		<path d="M158.83,48.83A71.17,71.17,0,1,0,230,120,71.163,71.163,0,0,0,158.83,48.83Zm45.293,77.632H152.34V74.708h12.952v38.83h38.83ZM35.878,74.708h38.83V87.66H35.878ZM10,113.538H61.755V126.49H10Zm25.878,38.83h38.83V165.32H35.878Z"/>
	</symbol>
	<symbol id="icnSvgHourGlass" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 14 24">
		<path d="M13.974 19.455c0-.342-.01-.748-.077-1.169a4.11 4.11 0 00-.649-1.653c-.174-.263-1.05-1.176-3.127-3.258a69.969 69.969 0 01-.372-.374l-.156-.159a5.561 5.561 0 01-.2-.217 2.823 2.823 0 01-.056-.07 1.504 1.504 0 01-.157-.226.652.652 0 01-.078-.2 1.729 1.729 0 01-.008-.263v-.031c.002-.106.005-.2.023-.27a.592.592 0 01.098-.186 3.43 3.43 0 01.225-.288c.076-.085.158-.168.244-.256l.065-.067.37-.372c2.078-2.083 2.955-2.997 3.13-3.26a4.106 4.106 0 00.649-1.653 7.57 7.57 0 00.076-1.169V2.261A.741.741 0 0014 2.075C14 .727 10.393 0 7 0S0 .727 0 2.075c0 .062.01.122.025.182v2.057c0 .322.01.745.077 1.17A4.116 4.116 0 00.75 7.135c.174.263 1.051 1.177 3.129 3.26.187.188.32.321.37.373l.062.063a3.43 3.43 0 01.471.547.59.59 0 01.099.186c.018.07.021.16.023.27v.03c.002.096.003.188-.008.263a.647.647 0 01-.078.2 1.515 1.515 0 01-.157.228 2.849 2.849 0 01-.153.177 6.914 6.914 0 01-.103.108l-.104.104c-3.288 3.29-3.486 3.59-3.551 3.688a4.114 4.114 0 00-.649 1.653 7.692 7.692 0 00-.077 1.17v2.239C.025 23.279 3.641 24 7 24c3.36 0 6.975-.721 6.975-2.305v-.306l-.001-1.934zm-.949 2.24v.016c-.051.422-2.1 1.367-6.025 1.367-3.976 0-6.026-.97-6.026-1.384-.001-.615-.002-1.621 0-2.237 0-.307.008-.67.065-1.031a3.208 3.208 0 01.509-1.293c.055-.081.466-.576 3.434-3.545l.113-.113a6.845 6.845 0 00.24-.262 2.436 2.436 0 00.325-.46c.066-.123.145-.29.175-.494.022-.146.02-.285.018-.408v-.029a1.954 1.954 0 00-.053-.485 1.475 1.475 0 00-.239-.485 4.256 4.256 0 00-.287-.367 8.51 8.51 0 00-.276-.29l-.06-.061c-.05-.052-.187-.189-.378-.38-1.865-1.87-2.878-2.918-3.012-3.117a3.209 3.209 0 01-.509-1.294 6.732 6.732 0 01-.066-1.031V3.168c1.3.643 3.713.981 6.027.981 2.313 0 4.725-.338 6.026-.98v1.143c-.001.308-.01.671-.066 1.031a3.203 3.203 0 01-.51 1.294c-.133.199-1.146 1.247-3.011 3.117-.191.191-.328.328-.378.38l-.064.064c-.09.092-.182.186-.273.287-.109.123-.202.249-.287.367a1.474 1.474 0 00-.239.485 1.95 1.95 0 00-.052.486v.03c-.002.121-.004.26.017.406.03.203.11.37.175.494a2.464 2.464 0 00.325.46 4.399 4.399 0 00.24.261l.157.161.38.382c1.864 1.869 2.877 2.917 3.01 3.115a3.209 3.209 0 01.51 1.294c.057.36.065.723.065 1.031.002.616.001 1.622 0 2.237z"/>
		<path d="M12.715 19.253a5.274 5.274 0 00-.133-.127 5.793 5.793 0 00-.656-.542 5.292 5.292 0 00-.75-.425 11.85 11.85 0 00-1.715-.636c-.145-.042-.29-.084-.435-.128-.154-.048-.31-.09-.457-.155a1.752 1.752 0 01-.325-.185 1.982 1.982 0 01-.447-.45c-.131-.182-.256-.391-.297-.605-.04.214-.166.423-.297.605-.122.17-.27.323-.447.45-.1.073-.21.135-.326.185-.146.064-.303.107-.456.155-.145.044-.29.086-.436.128a11.875 11.875 0 00-1.715.636 5.294 5.294 0 00-.75.425 5.79 5.79 0 00-.655.542 5.297 5.297 0 00-.278.28.858.858 0 00-.14.193C2 20.373 4.461 21 7.497 21c3.035 0 5.496-.627 5.496-1.401H13a.852.852 0 00-.14-.194 5.181 5.181 0 00-.145-.152zM6.417 10.512c.063.06.123.135.177.221.096.153.178.337.244.54.072.219.14.47.162.727.022-.257.09-.508.162-.727.066-.203.148-.387.244-.54.054-.086.114-.16.177-.221.08-.077.166-.129.25-.186.078-.053.158-.103.237-.154.162-.103.321-.214.478-.343.155-.129.309-.266.458-.42.143-.149.28-.316.408-.51.13-.196.245-.42.358-.65a6.916 6.916 0 00.152-.336A1.39 1.39 0 0010 7.681C10 6.753 8.658 6 7.002 6c-1.656 0-2.998.753-2.998 1.681H4c.019.085.046.16.076.232a5.72 5.72 0 00.152.335c.112.231.228.455.357.651.128.194.266.361.41.51a5.4 5.4 0 00.457.42c.156.129.316.24.478.343.08.05.158.1.237.154.084.057.17.109.25.186z"/>
	  </symbol>
	<symbol id="icnSvgSpinWaiting" viewBox="22 22 56 56">
		<g transform="rotate(0 50 50)">
		  <rect x="47" y="24" rx="3" ry="6" width="6" height="12">
			<animate attributeName="opacity" values="1;0" keyTimes="0;1" dur="1s" begin="-0.9166666666666666s" repeatCount="indefinite"></animate>
		  </rect>
		</g>
		<g transform="rotate(30 50 50)">
		  <rect x="47" y="24" rx="3" ry="6" width="6" height="12">
			<animate attributeName="opacity" values="1;0" keyTimes="0;1" dur="1s" begin="-0.8333333333333334s" repeatCount="indefinite"></animate>
		  </rect>
		</g>
		<g transform="rotate(60 50 50)">
		  <rect x="47" y="24" rx="3" ry="6" width="6" height="12">
			<animate attributeName="opacity" values="1;0" keyTimes="0;1" dur="1s" begin="-0.75s" repeatCount="indefinite"></animate>
		  </rect>
		</g>
		<g transform="rotate(90 50 50)">
		  <rect x="47" y="24" rx="3" ry="6" width="6" height="12">
			<animate attributeName="opacity" values="1;0" keyTimes="0;1" dur="1s" begin="-0.6666666666666666s" repeatCount="indefinite"></animate>
		  </rect>
		</g>
		<g transform="rotate(120 50 50)">
		  <rect x="47" y="24" rx="3" ry="6" width="6" height="12">
			<animate attributeName="opacity" values="1;0" keyTimes="0;1" dur="1s" begin="-0.5833333333333334s" repeatCount="indefinite"></animate>
		  </rect>
		</g>
		<g transform="rotate(150 50 50)">
		  <rect x="47" y="24" rx="3" ry="6" width="6" height="12">
			<animate attributeName="opacity" values="1;0" keyTimes="0;1" dur="1s" begin="-0.5s" repeatCount="indefinite"></animate>
		  </rect>
		</g>
		<g transform="rotate(180 50 50)">
		  <rect x="47" y="24" rx="3" ry="6" width="6" height="12">
			<animate attributeName="opacity" values="1;0" keyTimes="0;1" dur="1s" begin="-0.4166666666666667s" repeatCount="indefinite"></animate>
		  </rect>
		</g>
		<g transform="rotate(210 50 50)">
		  <rect x="47" y="24" rx="3" ry="6" width="6" height="12">
			<animate attributeName="opacity" values="1;0" keyTimes="0;1" dur="1s" begin="-0.3333333333333333s" repeatCount="indefinite"></animate>
		  </rect>
		</g>
		<g transform="rotate(240 50 50)">
		  <rect x="47" y="24" rx="3" ry="6" width="6" height="12">
			<animate attributeName="opacity" values="1;0" keyTimes="0;1" dur="1s" begin="-0.25s" repeatCount="indefinite"></animate>
		  </rect>
		</g>
		<g transform="rotate(270 50 50)">
		  <rect x="47" y="24" rx="3" ry="6" width="6" height="12">
			<animate attributeName="opacity" values="1;0" keyTimes="0;1" dur="1s" begin="-0.16666666666666666s" repeatCount="indefinite"></animate>
		  </rect>
		</g>
		<g transform="rotate(300 50 50)">
		  <rect x="47" y="24" rx="3" ry="6" width="6" height="12">
			<animate attributeName="opacity" values="1;0" keyTimes="0;1" dur="1s" begin="-0.08333333333333333s" repeatCount="indefinite"></animate>
		  </rect>
		</g>
		<g transform="rotate(330 50 50)">
		  <rect x="47" y="24" rx="3" ry="6" width="6" height="12">
			<animate attributeName="opacity" values="1;0" keyTimes="0;1" dur="1s" begin="0s" repeatCount="indefinite"></animate>
		  </rect>
		</g>
	</symbol>
	<symbol id="icnSvgFullTrashBin" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
		<path d="M322.62 254.95h-20.71v195.41h20.71V254.95zM111.53 2.02l105.89 36.64 3.26-9.41c.11-.32.23-.64.38-.94 3.69-9.25 13.28-14.76 23.08-13.35 2.56.37 4.75 1.19 7.16 2.03l60.97 21.1c.82.28 1.62.53 2.4.91 5.11 2.08 9.07 5.94 11.32 10.59 2.21 4.56 2.8 9.93 1.36 15.13-.17.61-.35 1.25-.55 1.83l-3.07 8.89 106.95 37.01c1.43.49 2.47.88 3.84 1.61 6.86 3.69 10.35 11.45 8.43 19.03-.21.82-.44 1.59-.72 2.38l-12.01 34.71c-1.67 4.85-6.97 7.41-11.81 5.74l-19.61-6.79a81.15 81.15 0 0 1 6.56 28.24c1.22.78 2.35 1.68 3.36 2.68 3.52 3.47 5.81 8.14 5.93 13.34.02 1.1-.11 2.21-.21 3.3L388.9 490.72c-.33 3.6-.93 6.8-2.75 10.18-3.52 6.55-10.03 11.1-18.14 11.1H117.06c-5.32 0-9.19-.47-13.67-3.53-5.28-3.61-8.74-9.7-9.35-16.46L68.66 215.9c-.08-.87-.16-1.82-.13-2.68.18-5.15 2.44-9.76 5.94-13.19 2.78-2.73 6.45-4.74 10.43-5.61-.19-.97-.3-1.96-.3-2.99v-66.36c0-8.26 6.76-15.02 15.02-15.02h78.92c8.25 0 15.01 6.76 15.01 15.02v22.45c12.39-10.17 28.24-16.28 45.52-16.28a71.52 71.52 0 0 1 32.54 7.79c4.18-3.5 8.71-6.6 13.54-9.22L79.45 58.63c-4.85-1.68-7.42-6.97-5.75-11.82l.07-.2 11.29-32.63C89.79.32 98.32-2.56 111.53 2.02zm143.75 252.93h-20.72v195.41h20.72V254.95zm-67.34 0h-20.71v195.41h20.71V254.95zm205.55-42.48H89.89c-1.99 0-2.94.34-2.75 2.45l25.11 273.2c.16 1.69.13 5.33 2.53 5.29h253.25c2.08 0 2.32-2.93 2.46-4.44l25.57-274.23c.16-1.77-.89-2.27-2.57-2.27zm-224.75-23.88h9.8v-52.32c0-5.98-4.9-10.87-10.88-10.87h-57.17c-5.98 0-10.87 4.89-10.87 10.87v52.32h69.12zm100.12 2.44H379.1c-2.52-15.25-11.22-28.4-23.44-36.82l-.15-.11-.23-.15-.38-.26-.38-.25-.02-.01-.37-.25-.39-.24-.26-.17-.13-.08-.4-.24-.39-.24-.11-.06-.29-.17-.4-.23-.36-.21-.04-.02-.4-.23-.41-.22-.41-.22-.41-.21-.41-.22-.06-.03-.35-.17-.42-.21-.32-.16-.09-.04-.42-.2-.43-.2-.16-.07-.26-.12-.43-.19-.42-.18-.01-.01-.42-.17-.71-.29-.16-.06-.84-.33-.02-.01-.12-.05-.32-.12-.44-.16-.4-.14-.04-.01-.45-.16-.44-.15-.24-.07-.21-.07-.45-.15-.45-.13-.06-.02-.39-.12-.45-.13-.35-.1-.11-.03-.45-.12-.46-.12-.18-.05-.28-.07-.46-.11-.46-.11h-.01l-.46-.1-.76-.17-.17-.03-.46-.09-.48-.09-.12-.03-.34-.06-.48-.08-.42-.07-.05-.01-.48-.07-.47-.07-.24-.04-.24-.03-.48-.06-.48-.05-.06-.01-.42-.05-.48-.05-.37-.03-.11-.01-.49-.04-.48-.04-.19-.01-.3-.02c-1.18-.08-2.37-.12-3.57-.12-27.51 0-50.44 19.73-55.12 46.67z"/>
	</symbol>

	<symbol id="icnSvgSetting" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 122.88 122.878">
		<path fill-rule="evenodd" clip-rule="evenodd" d="M101.589,14.7l8.818,8.819c2.321,2.321,2.321,6.118,0,8.439l-7.101,7.101 c1.959,3.658,3.454,7.601,4.405,11.752h9.199c3.283,0,5.969,2.686,5.969,5.968V69.25c0,3.283-2.686,5.969-5.969,5.969h-10.039 c-1.231,4.063-2.992,7.896-5.204,11.418l6.512,6.51c2.321,2.323,2.321,6.12,0,8.44l-8.818,8.819c-2.321,2.32-6.119,2.32-8.439,0 l-7.102-7.102c-3.657,1.96-7.601,3.456-11.753,4.406v9.199c0,3.282-2.685,5.968-5.968,5.968H53.629 c-3.283,0-5.969-2.686-5.969-5.968v-10.039c-4.063-1.232-7.896-2.993-11.417-5.205l-6.511,6.512c-2.323,2.321-6.12,2.321-8.441,0 l-8.818-8.818c-2.321-2.321-2.321-6.118,0-8.439l7.102-7.102c-1.96-3.657-3.456-7.6-4.405-11.751H5.968 C2.686,72.067,0,69.382,0,66.099V53.628c0-3.283,2.686-5.968,5.968-5.968h10.039c1.232-4.063,2.993-7.896,5.204-11.418l-6.511-6.51 c-2.321-2.322-2.321-6.12,0-8.44l8.819-8.819c2.321-2.321,6.118-2.321,8.439,0l7.101,7.101c3.658-1.96,7.601-3.456,11.753-4.406 V5.969C50.812,2.686,53.498,0,56.78,0h12.471c3.282,0,5.968,2.686,5.968,5.969v10.036c4.064,1.231,7.898,2.992,11.422,5.204 l6.507-6.509C95.471,12.379,99.268,12.379,101.589,14.7L101.589,14.7z M61.44,36.92c13.54,0,24.519,10.98,24.519,24.519 c0,13.538-10.979,24.519-24.519,24.519c-13.539,0-24.519-10.98-24.519-24.519C36.921,47.9,47.901,36.92,61.44,36.92L61.44,36.92z"/>
	</symbol>
	
	<!-- History icons -->
	<symbol id="icnSvgClearHistory" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 469 503.83">
	   <path d="m 381.11617,403.59756 c 0.62578,-0.65795 1.2824,-1.26347 1.98274,-1.81082 0.5261,-0.83393 1.12396,-1.62039 1.78642,-2.37814 7.21069,-8.05937 13.76554,-16.6275 19.58337,-25.74825 3.18815,-5.00492 8.68614,-8.12229 14.63376,-8.19884 13.99176,-0.27228 22.67458,15.34326 15.18358,27.10929 -6.86879,10.7419 -14.5975,20.90895 -23.11016,30.40119 -0.80181,0.89691 -1.67825,1.6832 -2.59409,2.36683 -0.49157,0.7564 -1.06068,1.4783 -1.67927,2.15493 l -0.17532,0.18512 0.0295,0.0208 C 362.43204,474.85634 303.18715,499.57992 243.22206,501.44327 183.25338,503.29726 122.58315,482.28383 75.430095,437.96857 28.273455,393.64397 3.5498604,334.3991 1.6865324,274.43401 -0.1767985,214.46891 20.845975,153.7951 65.157653,106.6327 80.651923,90.15565 97.97448,76.404451 116.52512,65.405988 132.16185,56.136617 148.6682,48.825679 165.66865,43.499506 L 152.97927,38.29103 C 142.92837,34.179883 138.11551,22.702323 142.23024,12.660779 146.34138,2.609903 157.81896,-2.2029589 167.8605,1.911773 l 50.72806,20.813083 c 1.97027,0.807554 3.72498,1.890665 5.26129,3.186151 8.0534,5.381343 11.07261,16.037105 6.67646,24.954859 l -24.21807,49.196584 c -4.78796,9.71086 -16.53638,13.70649 -26.25656,8.9221 -9.71084,-4.78797 -13.7065,-16.53638 -8.91857,-26.247207 l 2.31493,-4.712601 c -13.5005,4.454005 -26.60925,10.375036 -39.06061,17.757548 -15.71719,9.31097 -30.41067,20.98181 -43.56923,34.97697 -37.66808,40.08123 -55.528739,91.63616 -53.949554,142.57345 1.573429,50.95023 22.603219,101.2979 62.688004,138.97532 40.08122,37.66808 91.63616,55.52873 142.57347,53.94953 28.18114,-0.86679 56.18383,-7.69562 81.96039,-20.40742 0.56283,-0.37666 1.14411,-0.72492 1.74174,-1.04349 2.94605,-1.50578 5.83758,-3.09776 8.71122,-4.73641 0.73187,-0.40947 1.49098,-0.77586 2.25293,-1.07905 16.00441,-9.39981 30.94497,-21.20832 44.29969,-35.41804 z" />
	   <path d="m 201.26897,182.98215 c 0,-10.03 8.13,-18.16 18.16,-18.16 10.03,0 18.16,8.13 18.16,18.16 v 110.52001 l 75.64,33.25 c 9.17,4.04 13.33,14.74 9.3,23.9 -4.04,9.17 -14.74,13.33 -23.91,9.29 l -85.58,-37.61 c -6.87,-2.59 -11.77,-9.22 -11.77,-17.01 z" />
	 <g transform="matrix(1.8093715,0,0,1.9111334,269.98843,23.875916)">
	   <path d="m 4.873,9.058 h 33.35 V 6.2 6.187 c 0,-0.095 0.002,-0.186 0.014,-0.279 0.075,-1.592 0.762,-3.037 1.816,-4.086 L 40.046,1.815 c 1.104,-1.104 2.637,-1.79 4.325,-1.806 l 0.023,0.002 V 0 h 0.031 19.884 0.016 c 0.106,0 0.207,0.009 0.309,0.022 1.583,0.084 3.019,0.76 4.064,1.81 1.102,1.104 1.786,2.635 1.803,4.315 l -0.003,0.021 h 0.014 V 6.2 9.057 h 32.909 0.017 c 0.138,0 0.268,0.014 0.401,0.034 1.182,0.106 2.254,0.625 3.034,1.41 l 0.004,0.007 0.005,-0.007 c 0.851,0.857 1.386,2.048 1.401,3.368 l -0.002,0.032 h 0.014 v 0.032 10.829 c 0,1.472 -1.195,2.665 -2.667,2.665 H 105.558 2.667 C 1.195,27.426 0,26.233 0,24.762 V 24.699 13.933 13.919 C 0,13.813 0.004,13.708 0.018,13.604 V 13.583 C 0.107,12.376 0.642,11.279 1.44,10.485 L 1.433,10.483 C 2.295,9.622 3.49,9.087 4.81,9.069 L 4.842,9.071 V 9.058 Z M 77.79,49.097 h -5.945 v 56.093 h 5.945 z m -19.33,0 h -5.948 v 56.093 h 5.948 z m -19.33,0 H 33.184 V 105.19 H 39.13 Z M 10.837,31.569 h 87.385 l 0.279,0.018 0.127,0.007 0.134,0.011 h 0.009 l 0.163,0.023 c 1.363,0.163 2.638,0.789 3.572,1.708 1.04,1.025 1.705,2.415 1.705,3.964 0,0.098 -0.009,0.193 -0.019,0.286 l -0.002,0.068 -0.014,0.154 -7.393,79.335 -0.007,0.043 h 0.007 l -0.016,0.139 -0.051,0.283 -0.002,0.005 -0.002,0.018 c -0.055,0.331 -0.12,0.646 -0.209,0.928 l -0.007,0.022 -0.002,0.005 -0.009,0.018 -0.023,0.062 -0.004,0.021 c -0.118,0.354 -0.264,0.698 -0.432,1.009 -1.009,1.88 -2.879,3.187 -5.204,3.187 H 18.13 l -0.247,-0.014 v 0.003 l -0.011,-0.003 -0.032,-0.004 c -0.46,-0.023 -0.889,-0.091 -1.288,-0.202 -0.415,-0.116 -0.818,-0.286 -1.197,-0.495 l -0.009,-0.002 -0.002,0.002 c -1.785,-0.977 -2.975,-2.882 -3.17,-5.022 L 4.88,37.79 4.869,37.665 4.858,37.418 4.854,37.302 H 4.849 c 0,-1.553 0.664,-2.946 1.707,-3.971 0.976,-0.955 2.32,-1.599 3.756,-1.726 l 0.122,-0.004 v -0.007 l 0.3,-0.013 0.104,0.002 v -0.014 z m 87.386,5.334 H 10.837 V 36.896 L 10.721,36.9 c -0.163,0.022 -0.322,0.106 -0.438,0.222 -0.063,0.063 -0.104,0.132 -0.104,0.179 h -0.007 l 0.007,0.118 7.282,79.244 h -0.002 l 0.002,0.012 c 0.032,0.376 0.202,0.691 0.447,0.825 l -0.002,0.004 0.084,0.032 0.063,0.012 h 0.077 72.695 c 0.207,0 0.399,-0.157 0.518,-0.377 l 0.084,-0.197 0.054,-0.216 0.014,-0.138 H 91.5 L 98.884,37.41 98.881,37.3 c 0,-0.045 -0.041,-0.111 -0.103,-0.172 -0.12,-0.118 -0.286,-0.202 -0.451,-0.227 z m 0.111,-0.002 h -0.016 z m 0.549,0.512 v -0.004 z m 5.297,0.377 -0.002,0.018 z M 40.887,14.389 H 5.332 v 7.706 h 97.63 V 14.389 H 67.907 67.844 c -1.472,0 -2.664,-1.192 -2.664,-2.664 V 6.2 6.168 h 0.007 C 65.18,5.948 65.081,5.735 64.928,5.583 64.791,5.442 64.604,5.354 64.407,5.331 H 64.325 64.309 44.425 44.394 V 5.325 C 44.181,5.332 43.972,5.429 43.818,5.584 L 43.814,5.58 43.807,5.584 c -0.131,0.134 -0.231,0.313 -0.259,0.501 l 0.007,0.102 V 6.2 11.724 c -10e-4,1.472 -1.196,2.665 -2.668,2.665 z" />
	 </g>
	</symbol>
	<symbol id="icnSvgHistoryForward" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 122.883 122.882">
		<path d="M61.441,0C44.475,0,29.115,6.877,17.996,17.996C6.877,29.115,0,44.475,0,61.441c0,16.966,6.877,32.326,17.996,43.445 c11.119,11.118,26.479,17.995,43.445,17.995c16.967,0,32.327-6.877,43.446-17.995c11.119-11.119,17.996-26.479,17.996-43.445 c0-16.967-6.877-32.327-17.996-43.445C93.768,6.877,78.408,0,61.441,0L61.441,0z M51.505,42.166 c-1.735-1.784-1.696-4.637,0.088-6.372c1.784-1.735,4.637-1.696,6.373,0.088l21.839,22.521l-3.23,3.142l3.244-3.146 c1.738,1.792,1.693,4.652-0.098,6.39c-0.053,0.05-0.105,0.099-0.158,0.146L57.966,87.017c-1.735,1.784-4.588,1.823-6.373,0.088 c-1.784-1.734-1.823-4.588-0.088-6.372l18.78-19.201L51.505,42.166L51.505,42.166z M24.386,24.386 C33.869,14.903,46.97,9.038,61.441,9.038c14.471,0,27.573,5.865,37.055,15.348c9.484,9.483,15.35,22.584,15.35,37.056 c0,14.471-5.865,27.572-15.35,37.055c-9.482,9.483-22.584,15.349-37.055,15.349c-14.471,0-27.572-5.865-37.055-15.349 C14.903,89.014,9.038,75.912,9.038,61.441C9.038,46.97,14.903,33.869,24.386,24.386L24.386,24.386z"/>
	</symbol>
	<symbol id="icnSvgSquareLinkArrow" xmlns="http://www.w3.org/2000/svg" viewBox="300 150 424 724"> 
		<path d="M725.4 853.3H256C208.9 853.3 170.7 815.1 170.7 768V298.7C170.7 251.5 208.9 213.3 256 213.3H426.7V298.7H256V768H725.4V597.3H810.7V768C810.7 815.1 772.5 853.3 725.4 853.3ZM499.2 584.8L439.1 524.5 707.6 256H554.7V170.7H853.4V469.3H768V316.4L499.2 584.8Z"> 
		</path> 
	</symbol>

	<!-- Icons for using in general chapter information item -->
	<symbol id="icnSvgMicrophone" xmlns="http://www.w3.org/2000/svg" viewBox="192 0 640 1024">
		<path d="M224 416a32 32 0 0 1 32 32v64a256 256 0 0 0 512 0v-64a32 32 0 0 1 64 0v64a320 320 0 0 1-288 318.4V960h192a32 32 0 0 1 0 64H288a32 32 0 0 1 0-64h192V830.4A320 320 0 0 1 192 512v-64a32 32 0 0 1 32-32"/><path d="M640 512a128 128 0 1 1-256 0V192a128 128 0 1 1 256 0zM512 0a192 192 0 0 0-192 192v320a192 192 0 0 0 384 0V192A192 192 0 0 0 512 0"/>
	</symbol>
	<symbol id="svgIconHeaphone" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 115.34 122.88">
		<path d="M97.74 119.52a2 2 0 0 1-.68-.12V65.93a2 2 0 0 1 .68-.12c3.34 0 6.43 5 8.48 7l-.46-12.12c0-12.8-3.72-23.11-9.68-30.93a7.37 7.37 0 0 1-5.86-2.23l-.68-.7C80.91 18.29 69 14.44 57.24 14.66s-23.48 4.53-31.55 12.25l-.66.64a7.3 7.3 0 0 1-6.49 2.05c-6 7.84-9.75 18.21-9.75 31.14l-.46 13.89c2.25-2.71 6.34-8.66 10-8.82v53.71C10.52 119.36 4.91 107.05 3 101H0V60.74a57.33 57.33 0 0 1 12.83-36.17 7.35 7.35 0 0 1 1.8-7.36l1-.95C26.36 6 41.62.3 57 0s31.25 4.9 42.87 16.46l.91.93a7.33 7.33 0 0 1 1.74 7.2 57.34 57.34 0 0 1 12.81 36.13V101h-2.21c-1.89 6.14-7.54 18.57-15.39 18.57Zm-5.55 3.36h-9a3.48 3.48 0 0 1-3.48-3.47V65.65a3.49 3.49 0 0 1 3.48-3.48h9zm-69-60.71H33a3.5 3.5 0 0 1 3.48 3.48v53.76a3.49 3.49 0 0 1-3.48 3.47h-9.86V62.17Z"/>
	</symbol>
	<symbol id="svgIconListenTime" xmlns="http://www.w3.org/2000/svg" viewBox="72 121.07 881 781.93">
	<path d="M945 412H689c-4.4 0-8 3.6-8 8v48c0 4.4 3.6 8 8 8h256c4.4 0 8-3.6 8-8v-48c0-4.4-3.6-8-8-8zM811 548H689c-4.4 0-8 3.6-8 8v48c0 4.4 3.6 8 8 8h122c4.4 0 8-3.6 8-8v-48c0-4.4-3.6-8-8-8zM477.3 322.5H434c-6.2 0-11.2 5-11.2 11.2v248c0 3.6 1.7 6.9 4.6 9l148.9 108.6c5 3.6 12 2.6 15.6-2.4l25.7-35.1v-0.1c3.6-5 2.5-12-2.5-15.6l-126.7-91.6V333.7c0.1-6.2-5-11.2-11.1-11.2z"/>
	<path d="M804.8 673.9H747c-5.6 0-10.9 2.9-13.9 7.7-12.7 20.1-27.5 38.7-44.5 55.7-29.3 29.3-63.4 52.3-101.3 68.3-39.3 16.6-81 25-124 25-43.1 0-84.8-8.4-124-25-37.9-16-72-39-101.3-68.3s-52.3-63.4-68.3-101.3c-16.6-39.2-25-80.9-25-124 0-43.1 8.4-84.7 25-124 16-37.9 39-72 68.3-101.3 29.3-29.3 63.4-52.3 101.3-68.3 39.2-16.6 81-25 124-25 43.1 0 84.8 8.4 124 25 37.9 16 72 39 101.3 68.3 17 17 31.8 35.6 44.5 55.7 3 4.8 8.3 7.7 13.9 7.7h57.8c6.9 0 11.3-7.2 8.2-13.3-65.2-129.7-197.4-214-345-215.7-216.1-2.7-395.6 174.2-396 390.1C71.6 727.5 246.9 903 463.2 903c149.5 0 283.9-84.6 349.8-215.8 3.1-6.1-1.4-13.3-8.2-13.3z"/>
	</symbol>
	<symbol id="svgIconCalendar" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 119.92 122.88">
		<path d="M108.68,122.88H11.24A11.28,11.28,0,0,1,0,111.64V22.55A11.28,11.28,0,0,1,11.24,11.31H21.61V25.14a12.35,12.35,0,0,0,4.67,9.61,14.55,14.55,0,0,0,18.31,0,12.35,12.35,0,0,0,4.67-9.61V11.31H70.2V25.14a12.35,12.35,0,0,0,4.67,9.61,14.55,14.55,0,0,0,18.31,0,12.35,12.35,0,0,0,4.67-9.61V11.31h10.83a11.3,11.3,0,0,1,11.24,11.24v89.09a11.27,11.27,0,0,1-11.24,11.24ZM83.58,56.77h16.1a2.07,2.07,0,0,1,2.06,2v13.4a2.07,2.07,0,0,1-2.06,2H83.58a2.06,2.06,0,0,1-2-2V58.82a2.05,2.05,0,0,1,2-2Zm-31.51,0H68.18a2.06,2.06,0,0,1,2,2v13.4a2.07,2.07,0,0,1-2,2H52.07a2.06,2.06,0,0,1-2-2V58.82a2.06,2.06,0,0,1,2-2Zm-31.84,0H36.34a2.06,2.06,0,0,1,2,2v13.4a2.07,2.07,0,0,1-2,2H20.23a2.06,2.06,0,0,1-2.05-2V58.82a2.05,2.05,0,0,1,2.05-2ZM83.58,85.26h16.1a2.07,2.07,0,0,1,2.06,2v13.4a2.06,2.06,0,0,1-2.06,2.05H83.58a2.06,2.06,0,0,1-2-2.05V87.31a2.06,2.06,0,0,1,2-2Zm-31.51,0H68.18a2.06,2.06,0,0,1,2,2v13.4a2.06,2.06,0,0,1-2,2.05H52.07a2.06,2.06,0,0,1-2-2.05V87.31a2.07,2.07,0,0,1,2-2Zm-31.84,0H36.34a2.06,2.06,0,0,1,2,2v13.4a2.06,2.06,0,0,1-2,2.05H20.23a2.06,2.06,0,0,1-2.05-2.05V87.31a2.06,2.06,0,0,1,2.05-2ZM78.6,4.45C78.6,2,81,0,84,0s5.43,2,5.43,4.45V25.14c0,2.46-2.42,4.45-5.43,4.45s-5.42-2-5.42-4.45V4.45ZM30,4.45C30,2,32.44,0,35.44,0s5.42,2,5.42,4.45V25.14c0,2.46-2.42,4.45-5.42,4.45S30,27.6,30,25.14V4.45ZM3.6,43.86v66.58a8.87,8.87,0,0,0,8.84,8.84h95a8.87,8.87,0,0,0,8.85-8.84V43.86Z"/>
	</symbol>
	<symbol id="svgIconChapterInfor" xmlns="http://www.w3.org/2000/svg" viewBox="204.8 102.4 614.4 819.2">
		<path d="M204.8 204.8v614.4a102.4 102.4 0 0 0 102.4 102.4h486.4a25.6 25.6 0 0 0 0-51.2H307.2a51.2 51.2 0 0 1-51.2-51.2h512a51.2 51.2 0 0 0 51.2-51.2V204.8a102.4 102.4 0 0 0-102.4-102.4H307.2a102.4 102.4 0 0 0-102.4 102.4m512-51.2a51.2 51.2 0 0 1 51.2 51.2V768H256V204.8a51.2 51.2 0 0 1 51.2-51.2zM550.4 294.4a38.4 38.4 0 1 0-76.8 0 38.4 38.4 0 0 0 76.8 0M537.6 640a25.6 25.6 0 0 1-51.2 0V435.2a25.6 25.6 0 0 1 51.2 0z"/>
	</symbol>
	<!-- Icons for using in general book information item -->
	<symbol id="svgIconFeather" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 121.24 122.88">
	<path class="st0" d="M10.05,96.6C6.38,105.51,1.42,113.97,0,122.88l5.13-0.44c8.1-23.56,15.4-39.4,31.23-59.21 C48.24,48.39,61.13,36.58,77.66,27.2c8.8-5,20.07-10.47,30.21-11.85c2.77-0.38,5.58-0.49,8.46-0.24 c-31.4,7.19-56.26,23.84-76.12,48.8C32.1,74.09,25.05,85.4,18.57,97.32l11.94,2.18l-4.97-2.47l17.78-2.83 c-6.6-2.33-13.12-1.55-15.21-4.06c18.3-0.83,33.34-4.78,43.9-12.45c-3.93-0.55-8.46-1.04-10.82-2.17 c17.69-5.98,27.92-16.73,40.9-26.27c-16.87,3.54-32.48,2.96-37-0.25c29.77,2.21,49-6.02,55.59-26.77c0.57-2.24,0.73-4.5,0.37-6.78 C118.74,0.62,92.49-4.39,83.95,7.77c-1.71,2.43-4.12,4.66-6.11,7.48L85.97,0c-21.88,7.39-23.68,15.54-35,40.09 c0.9-7.47,2.97-14.24,5.66-20.63c-27.34,10.55-36.45,37.11-37.91,59.7c-0.79-7.88,0.67-17.78,3.49-28.9 c-7.98,8-13.41,17.39-11.47,30.79l-3.65-1.63l1.92,7.19l-5.46-2.59L10.05,96.6L10.05,96.6z"/>
	</symbol>
	<symbol id="svgIconBookNumber" xmlns="http://www.w3.org/2000/svg" viewBox="204.8 102.4 614.6 819.2">
		<path d="M358.4 384.3a25.6 25.6 0 0 1 25.6-25.6h66l11.4-56.5a25.6 25.6 0 0 1 50.1 10.1l-9.2 46.4h50.2l11.3-56.4a25.6 25.6 0 0 1 50.1 10l-9.2 46.4h48.2a25.6 25.6 0 0 1 0 51.2h-58.4l-10.3 51.2h55.9a25.6 25.6 0 1 1 0 51.2h-66l-11.2 55.9a25.6 25.6 0 0 1-50.2-10l9.1-45.9H471.6l-11.3 55.9a25.6 25.6 0 1 1-50.1-10l9.2-45.9h-48a25.6 25.6 0 0 1 0-51.2H429.6l10.2-51.2H384a25.6 25.6 0 0 1-25.6-25.6Zm173.7 76.8l10.2-51.2H492l-10.2 51.2h50.3ZM307.2 102.4h409.8a102.4 102.4 0 0 1 102.4 102.4v588.9a25.6 25.6 0 0 1-25.6 25.6H256A51.2 51.2 0 0 0 307.2 870.4h486.6a25.6 25.6 0 0 1 0 51.2H307.2a102.4 102.4 0 0 1-102.4-102.4V204.8a102.4 102.4 0 0 1 102.4-102.4ZM256 768.1h512.2V204.8a51.2 51.2 0 0 0-51.2-51.2H307.2a51.2 51.2 0 0 0-51.2 51.2v563.3Z"/>
	</symbol>
	<symbol id="svgIconRemainTime" xmlns="http://www.w3.org/2000/svg" viewBox="-0.42 0 1024.32 1024.2">
		<path d="M545 65.2a448 448 0 0 0-33-1.2V0a512 512 0 0 1 37.7 1.4zM673.2 94a448 448 0 0 0-63-19.1l14-62.5c24.5 5.5 48.6 12.8 72.1 21.9zm87.7 45.5a449 449 0 0 0-28.1-17.3l31.6-55.7a513.6 513.6 0 0 1 62.6 41.9l-39.4 50.4a448 448 0 0 0-26.7-19.3M878.3 254a447.4 447.4 0 0 0-41.8-50.9l46.3-44.2c17.3 18.2 33.3 37.8 47.8 58.3zm47.6 86.5a453 453 0 0 0-13.7-29.9l57.1-28.8a510.5 510.5 0 0 1 28.8 69.6l-60.8 20.1a450 450 0 0 0-11.4-31M959.8 501a447.4 447.4 0 0 0-6.4-65.6l63-10.9c4.3 24.7 6.8 49.8 7.5 74.9l-64 1.6zm-8.4 98.4c2.1-10.9 3.8-21.7 5.2-32.6l63.6 7.9a509 509 0 0 1-14.8 73.9l-61.7-17.1c2.9-10.6 5.5-21.2 7.7-32.1m-60.9 152.3c11.8-18.6 22.1-38 31.1-58.1l58.5 25.9c-10.2 23-22.1 45.2-35.5 66.4zm-61.7 77.1c7.8-7.8 15.3-15.9 22.4-24.2l48.5 41.8A517 517 0 0 1 874 874z"/>
		<path d="M512 64a448 448 0 1 0 316.8 764.8L874 874A512.1 512.1 0 1 1 512 0z"/>
		<path d="M480 192a32 32 0 0 1 32 32v333.4l207.9 118.8a32 32 0 0 1-31.8 55.6l-224-128A32 32 0 0 1 448 576V224a32 32 0 0 1 32-32"/>
	</symbol>
	<symbol id="svgIconMaleAuthor" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 117.37 122.88">
		<path d="M78.08 115.36H6.11c-5.24-.4-6.5-4.17-6.02-8.52C2.96 81.2 31.72 88.62 43.28 78.21c5.76 16.96 29.85 17.59 35.26 0 3.18 2.87 9.48 4.58 15.85 6.08.32.08.65.15 1 .23-7.77 4.75-13.88 12.08-16.32 20.65-1 3.52-1.31 6.95-.99 10.19m31.43-26.51 7.04 5.43c.93.72 1.1 2.06.39 2.99l-1.83 2.29-10.42-8.04 1.83-2.29c.71-.92 2.06-1.09 2.99-.38m-7.59 28.62c-2.4 1.1-4.79 2.19-7.19 3.28-5.63 2.57-5.45 3.78-4.58-2.08l1.37-9.22-.01-.01 11.54-15.87 10.42 8.04-11.55 15.87zm-8.62-6.65 6.84 5.28c-1.58.72-3.15 1.44-4.72 2.15-3.7 1.68-3.58 2.48-3.01-1.37zM43.13 61.2c2.19 3.47 4.48 7.02 7.32 9.63 2.74 2.5 6.06 4.2 10.45 4.21 4.76.01 8.23-1.75 11.06-4.39 2.94-2.75 5.25-6.52 7.54-10.28l6.14-10.12c1.14-2.62 1.56-4.36 1.3-5.39-.16-.61-.83-.91-1.98-.96-.24-.01-.49-.01-.74-.01-.27.01-.56.03-.86.05-.17.01-.32 0-.47-.03-.54.03-1.11-.01-1.68-.09l2.1-9.31c-15.61 2.46-27.28-9.13-43.77-2.32l1.19 10.97c-.65.04-1.29.01-1.87-.07-9.47.31 2.4 15.14 4.27 18.11m43.95-20.09c1.51.46 2.48 1.42 2.88 2.97.44 1.72-.04 4.14-1.5 7.45-.03.06-.05.12-.09.18l-6.21 10.23c-2.4 3.94-4.82 7.9-8.07 10.93-3.36 3.15-7.5 5.24-13.16 5.22-5.28-.01-9.27-2.03-12.53-5.02-3.94-3.62-22.12-26.37-14-31.85.4-.26.84-.49 1.32-.67-.36-4.7-.48-10.63-.26-15.59.12-1.17.35-2.35.67-3.53 1.39-4.98 4.89-8.99 9.21-11.74 2.39-1.52 5-2.67 7.72-3.43 1.73-.49-1.47-6.03.31-6.2 8.65-.89 22.66 7.01 28.7 13.55 3.02 3.27 4.93 7.62 5.34 13.36z"/>
	</symbol>
	<symbol id="svgIconBookType" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 353 512.32">
		<path d="M74.05 244.67h38.71c1.5-4.16 2.96-8.33 4.3-12.54l-17.01-27.12 12.78 4.82-5.65-15.84 8.53 3c-6.84-29.82 3.66-51.96 20.14-71.46-4.28 25.57-5.73 48.13-2.5 65.73-.89-51.13 14.71-112.63 74.32-141.43-4.89 14.88-8.31 30.5-8.94 47.49 20.95-57.37 23.5-76.06 71.4-96.75l-15.49 35.85c3.97-6.72 8.98-12.18 12.38-17.97C284-10.53 344.03-4.1 352 28.85c1.22 5.07 1.28 10.19.41 15.33-10.99 47.95-52.78 70.02-120.22 70.57 10.78 6.38 46.02 4.81 83.36-6.29-27.47 23.87-48.51 49.98-87.25 66.72 5.53 2.11 15.82 2.38 24.78 2.89-22.36 19.23-55.49 30.9-96.54 36.16 5.18 5.27 19.71 2.3 35 6.33l-39.51 9.67 11.64 4.65-27.29-2.7c12.39-28.04 26.16-54.82 42.52-79.24 40.11-59.89 93.01-101.98 162.38-123.98-6.51-.02-12.83.76-19 2.12-22.58 4.98-46.94 19.39-65.83 32.27-35.47 24.19-62.32 53.17-86.3 88.8-22.05 32.77-35.33 60.54-45.99 92.52h46.04c4.57 0 8.74 1.88 11.77 4.9l.05.05c3.01 3.03 4.88 7.19 4.88 11.75v36.45c0 4.56-1.88 8.74-4.91 11.78l.01.01a16.74 16.74 0 0 1-8.92 4.66v21.82c3.4 1.18 7.36 2.46 11.56 3.8 21.21 6.79 47.87 15.34 56.04 31.64 3.32 6.64 4.16 13.61 3.23 21.24-.83 6.86-3.1 14.21-6.21 22.4l-24.58 67.59-.35.79c-3.72 7.58-8.2 13.82-13.48 18.57-5.46 4.92-11.75 8.28-18.91 9.92-.68.18-1.4.28-2.13.28H66a9 9 0 0 1-1.71-.19c-7.33-1.6-13.76-4.99-19.34-10.01-5.17-4.66-9.57-10.75-13.25-18.13q-.33-.585-.57-1.23L6.55 415.17c-3.02-7.96-5.25-15.14-6.13-21.91-.98-7.54-.31-14.4 2.71-20.89 7.87-16.9 35.04-25.61 56.58-32.51 4.16-1.33 8.09-2.59 11.46-3.77v-21.83a16.66 16.66 0 0 1-8.89-4.64h-.04a16.7 16.7 0 0 1-4.89-11.8v-36.45c0-4.6 1.87-8.78 4.89-11.8s7.2-4.9 11.81-4.9m19.27 126.18h57.6v16.23h-57.6zm-55.93 81.77h169.47l15.69-43.15c2.68-7.05 4.61-13.22 5.27-18.6.56-4.62.16-8.62-1.59-12.12-5.1-10.19-28.18-17.58-46.54-23.46-6.63-2.12-12.71-4.07-17.76-6.14-3.14-1.27-5.03-4.29-5.04-7.48h-.03v-27.16H87.39v27.16c0 3.7-2.47 6.81-5.84 7.79-4.88 1.95-10.64 3.79-16.9 5.8-18.53 5.94-41.92 13.44-46.82 23.96-1.63 3.5-1.96 7.45-1.38 11.95.69 5.26 2.61 11.35 5.25 18.3zm163.57 16.23H43.29l2.93 8.06c2.73 5.45 5.91 9.87 9.57 13.17 3.26 2.94 6.96 4.97 11.12 6.02h110.43c4.16-1.05 7.85-3.08 11.12-6.02 3.66-3.3 6.84-7.72 9.57-13.17zM170.2 260.89H74.05c-.13 0-.25.06-.33.15-.09.09-.15.21-.15.33v36.45c0 .12.06.23.15.32.07.1.19.15.33.15h96.15c.12 0 .24-.06.33-.15h.03c.07-.07.12-.19.12-.32v-36.45c0-.14-.05-.26-.12-.33l-.03-.03a.47.47 0 0 0-.33-.12"/>
	</symbol>

	<symbol id="svgIconNoInternetConnection" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 122.88 122.88">
		<path d="m101.68 32.93-68.76 68.75a49.29 49.29 0 0 0 77.83-40.24A49.3 49.3 0 0 0 108 45.15a48.9 48.9 0 0 0-6.32-12.22M24 93.5 93.49 24A49.31 49.31 0 0 0 24 93.5" style="fill:#fff"/><path d="M30.29 52a3 3 0 0 1-4.29-.37 3 3 0 0 1 .34-4.24A59.3 59.3 0 0 1 43.27 37a48 48 0 0 1 36.4.31A61 61 0 0 1 96.46 47.9a1.3 1.3 0 0 1 .17.16 3 3 0 0 1 .27 4.07 1.5 1.5 0 0 1-.17.19 3 3 0 0 1-4.16.19A55.2 55.2 0 0 0 77.47 43a41.86 41.86 0 0 0-32.08-.27A53.4 53.4 0 0 0 30.29 52m31.15 24.09A6.59 6.59 0 1 1 56.77 78a6.62 6.62 0 0 1 4.67-1.93ZM50.05 72.5a3 3 0 0 1-4.16-.35 1.4 1.4 0 0 1-.16-.18 3 3 0 0 1 .43-4.07l.17-.14a27.6 27.6 0 0 1 7.33-4.33 21.7 21.7 0 0 1 7.84-1.52 21.4 21.4 0 0 1 7.8 1.47 27.1 27.1 0 0 1 7.34 4.36 3 3 0 0 1 .44 4.26 3 3 0 0 1-2 1.1 3.06 3.06 0 0 1-2.21-.66 21.3 21.3 0 0 0-5.62-3.37 15.12 15.12 0 0 0-11.47 0 22 22 0 0 0-5.7 3.41Zm-9.56-9.71-.15.13a3.06 3.06 0 0 1-2.08.67 3 3 0 0 1-2-1 1 1 0 0 1-.14-.15 3 3 0 0 1 .34-4.16 45.8 45.8 0 0 1 12.36-8 30.76 30.76 0 0 1 25.6.42 45.7 45.7 0 0 1 12.11 8.41l.08.07a3.1 3.1 0 0 1 .87 2 3 3 0 0 1-.82 2.15l-.07.08a3 3 0 0 1-2 .87 3 3 0 0 1-2.15-.81A40.1 40.1 0 0 0 72 56.28a24.75 24.75 0 0 0-21-.35 39.7 39.7 0 0 0-10.5 6.86Z"/>
		<path d="M61.44 0A61.31 61.31 0 1 1 38 4.66 61.3 61.3 0 0 1 61.44 0m40.24 32.93-68.75 68.75A49.44 49.44 0 0 0 80.31 107 49.53 49.53 0 0 0 107 80.3a49 49 0 0 0 3.73-18.86 48.93 48.93 0 0 0-9.08-28.51ZM24 93.5 93.5 24A49.32 49.32 0 0 0 24 93.5" style="fill:#d92d27"/>
	</symbol>
</svg>
</body>
</html>